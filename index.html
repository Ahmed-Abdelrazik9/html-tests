<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MavericPro | Advanced Medical AI Assistant</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Tabulator CSS -->
    <link href="https://unpkg.com/tabulator-tables@5.4.4/dist/css/tabulator.min.css" rel="stylesheet">

    <!-- JointJS CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jointjs/3.6.5/joint.min.css" integrity="sha512-cJvqdaXX2eUYypMLubeaZQQ3sTsLe86/MyFIEOaZmgy8WigcFhxem73nPN5kw+4Yrm2bSAx403RbG3vhGrO3Og==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Marked.js (Markdown â†’ HTML) -->
    <script type="module">
      import { marked } from "https://cdn.jsdelivr.net/npm/marked/lib/marked.esm.js";
      window.marked = marked; // attach globally for later use
    </script>

    <!-- DOMPurify (XSS protection) -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

    <!-- jQuery (required for DataTables) -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>

    <!-- DataTables CSS and JS with responsive extension -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css">

    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

    <!-- Tabulator JS -->
    <script src="https://unpkg.com/tabulator-tables@5.4.4/dist/js/tabulator.min.js"></script>

    <!-- JointJS JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jointjs/3.6.5/joint.min.js" integrity="sha512-5U3UCSzIxi4/okg8WdfzP75/YF9scnk3gs0s2LyMsv1w9vcLwXyKJd+WvPSq+agNF6XcXIrsXIbJ/cVUHK7BwA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- Chart.js for enhanced charts and graphs with plugins -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.9/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

    <!-- Mermaid.js for enhanced diagrams and flowcharts -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            securityLevel: 'loose'
        });
    </script>
    <style>
        /* CSS Variables - ChatGPT Official Specifications */
        :root {
            --sidebar-bg: #171717;
            --main-bg: #f7f7f8;
            --chat-bg: #f7f7f8;
            --text-primary: #202123;
            --text-secondary: #353740;
            --border-color: #e2e8f0;
            --hover-bg: #f3f4f6;
            --accent-color: #1a73e8;
            --accent-hover: #1764b0;
            --assistant-bg: #ffffff;
            --user-bg: #f7f7f8;
            --code-bg: #f6f8fa;
            --code-fg: #24292e;
            --bubble-radius: 12px;
            --bubble-shadow: 0 1px 3px rgba(0,0,0,0.03);
            --sidebar-hover: rgba(255, 255, 255, 0.1);
        }

        /* ChatGPT Official Dark Mode Colors */
        [data-theme="dark"] {
            --sidebar-bg: #171717;
            --main-bg: #212121;
            --chat-bg: #212121;
            --text-primary: #ececec;
            --text-secondary: #b4b4b4;
            --border-color: #4d4d4f;
            --hover-bg: #2f2f2f;
            --accent-color: #19c37d;
            --accent-hover: #0d9553;
            --assistant-bg: #2f2f2f;
            --user-bg: #2f2f2f;
            --code-bg: #2f2f2f;
            --code-fg: #d1d5db;
            --bubble-radius: 12px;
            --bubble-shadow: 0 1px 3px rgba(0,0,0,0.3);
            --sidebar-hover: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
            background: var(--main-bg);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
            font-size: 16px;
            line-height: 1.6;
            display: flex;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 17.5%;
            background: var(--sidebar-bg);
            color: white;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border-color);
            transition: width 0.3s ease, margin-left 0.3s ease;
            overflow: hidden;
        }

        .sidebar.hidden {
            width: 0;
            margin-left: 0;
            border-right: none;
        }

        .sidebar-header {
            padding: 30px 20px;
            border-bottom: 1px solid var(--sidebar-hover);
            text-align: center;
        }

        .sidebar-header h1 {
            font-size: 16px;
            font-weight: 500;
            margin: 0;
            color: white;
            text-align: center;
            line-height: 1.4;
        }

        .sidebar-separator {
            height: 1px;
            background: #374151;
            margin: 20px 20px 16px 20px;
        }

        .sidebar-actions {
            padding: 0 20px 16px 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .new-chat-btn {
            width: 100%;
            padding: 12px 16px;
            background: transparent;
            color: #e5e7eb;
            border: 1px solid #374151;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .new-chat-btn:hover {
            background: var(--sidebar-hover);
            border-color: #4b5563;
        }

        .search-container-fixed {
            position: relative;
            width: 100%;
        }

        .search-input-fixed {
            width: 100%;
            padding: 12px 16px 12px 40px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            outline: none;
            transition: all 0.2s;
        }

        .search-input-fixed::placeholder {
            color: #9ca3af;
        }

        .search-input-fixed:focus {
            border-color: rgba(99, 102, 241, 0.5);
            background: rgba(255, 255, 255, 0.08);
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            font-size: 14px;
        }

        .archive-btn {
            width: 100%;
            padding: 12px 16px;
            background: transparent;
            color: #e5e7eb;
            border: 1px solid #374151;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .archive-btn:hover {
            background: var(--sidebar-hover);
            border-color: #4b5563;
        }

        .sidebar-content {
            flex: 1;
            padding: 16px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }



        .sidebar-section {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
        }

        .sidebar-section h3 {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #9ca3af;
            margin-bottom: 8px;
            font-weight: 600;
            padding-left: 8px;
            flex-shrink: 0;
        }

        .chat-item {
            padding: 8px 12px;
            margin-bottom: 2px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            color: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
        }

        .chat-item:hover {
            background: var(--sidebar-hover);
            color: white;
        }

        .chat-item.active {
            background: var(--accent-color);
            color: white;
        }

        .chat-content {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 0;
        }

        .chat-title {
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }

        .chat-menu {
            position: relative;
        }

        .chat-menu-btn {
            width: 20px;
            height: 20px;
            border: none;
            background: none;
            color: inherit;
            cursor: pointer;
            border-radius: 4px;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: background 0.2s;
        }

        .chat-item:hover .chat-menu-btn {
            display: flex;
        }

        .chat-menu-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .chat-dropdown {
            position: absolute;
            right: 0;
            top: 100%;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            min-width: 180px;
            display: none;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            max-height: 300px;
            overflow-y: auto;
        }

        /* Ensure popup backgrounds remain white and text remains black in dark mode */
        [data-theme="dark"] .chat-dropdown {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 20px rgba(255, 255, 255, 0.1);
        }

        .chat-dropdown.show {
            display: block;
            animation: popupFadeIn 0.15s ease-out;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-primary);
            transition: background-color 0.1s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-family: inherit;
        }

        /* Force dropdown text to remain black in dark mode */
        [data-theme="dark"] .dropdown-item {
            color: #202123;
        }

        .dropdown-item:first-child {
            border-radius: 8px 8px 0 0;
        }

        .dropdown-item:last-child {
            border-radius: 0 0 8px 8px;
        }

        .dropdown-item:only-child {
            border-radius: 8px;
        }

        .dropdown-item:hover {
            background: #f7f7f8;
        }

        .dropdown-icon {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .dropdown-text {
            flex: 1;
            font-weight: 400;
        }

        .divider {
            height: 1px;
            background: #4b5563;
            margin: 16px 0;
        }

        /* Main Chat Area */
        .main-area {
            width: 82.5%;
            display: flex;
            flex-direction: column;
            background: var(--chat-bg);
            transition: width 0.3s ease, margin-left 0.3s ease;
        }

        .main-area.full-width {
            width: 100%;
            margin-left: 0;
        }

        .chat-header {
            padding: 20px 90px;
            border-bottom: 1px solid var(--border-color);
            background: var(--assistant-bg);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .chat-header h2 {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
            margin-top: 0;
        }

        /* Sidebar Toggle Button - ChatGPT Style */
        .sidebar-toggle {
            width: 32px;
            height: 32px;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
            color: var(--text-secondary);
            font-size: 18px;
            padding: 0;
            margin: 0;
        }

        .sidebar-toggle:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .sidebar-toggle:active {
            background: rgba(0, 0, 0, 0.1);
        }

        /* Settings Toggle Button */
        .settings-toggle {
            width: 32px;
            height: 32px;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
            color: var(--text-secondary);
            font-size: 16px;
            padding: 0;
            margin: 0;
        }

        .settings-toggle:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .settings-toggle:active {
            background: rgba(0, 0, 0, 0.1);
        }

        .toggle-icon {
            transition: transform 0.3s ease;
            display: inline-block;
        }

        .sidebar.hidden .toggle-icon {
            transform: rotate(180deg);
        }

        .chat-area {
            flex: 1;
            padding: 30px 90px;
            overflow-y: auto;
            background: var(--chat-bg);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .chat-area.with-centered-input {
            padding-bottom: 120px;
        }

        /* Message Bubbles - ChatGPT Official Style */
        .message {
            margin-bottom: 24px;
            max-width: 80%;
            padding: 16px 20px;
            border-radius: 18px;
            font-size: 16px;
            line-height: 1.6;
            word-wrap: break-word;
            position: relative;
            box-shadow: none;
            border: 1px solid var(--border-color);
        }

        .message.user {
            background: var(--user-bg);
            align-self: flex-end;
            margin-left: auto;
            margin-right: 10%;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            position: relative;
            padding: 8px 12px;
            margin-bottom: 40px;
            text-align: right;
            max-width: fit-content;
            width: auto;
            min-width: auto;
            transition: all 0.2s ease;
        }

        .message.user:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* User Message Actions Popup */
        .user-message-actions-popup {
            position: absolute;
            top: 8px;
            left: calc(100% + 8px);
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            min-width: 180px;
            display: none;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            max-height: 300px;
            overflow-y: auto;
        }

        [data-theme="dark"] .user-message-actions-popup {
            background: white;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 20px rgba(255, 255, 255, 0.1);
        }

        .user-message-actions-popup.show {
            display: block;
            animation: popupFadeIn 0.15s ease-out;
        }

        .message.assistant {
            background: var(--assistant-bg);
            align-self: center;
            margin-left: auto;
            margin-right: auto;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            box-shadow: var(--bubble-shadow);
            padding-left: 30px;
            padding-right: 30px;
            text-align: justify;
        }

        /* Chat Input - ChatGPT Official Style */
        .chat-input-container {
            background: var(--main-bg);
            border-top: none;
            padding: 20px 30px;
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
            max-width: 700px;
            margin: 0 auto;
            width: 100%;
        }

        .input-group {
            flex: 1;
            position: relative;
        }

        #messageInput {
            flex: 1;
            border: none;
            outline: none;
            background: transparent;
            font-size: 16px;
            font-family: inherit;
            color: var(--text-primary);
            resize: none;
            overflow-y: hidden;
            line-height: 1.5;
            min-height: 44px;
            max-height: 120px;
            width: 100%;
            padding: 12px 0;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        #messageInput::-webkit-scrollbar {
            display: none;
        }

        #messageInput:focus {
            border: 1.5px solid var(--border-color);
            outline: none;
        }

        .send-button {
            width: 44px;
            height: 44px;
            border: none;
            border-radius: 50%;
            background: var(--accent-color);
            color: #fff;
            font-size: 20px;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(26,115,232,0.10);
        }

        .send-button:hover:not(:disabled) {
            background: var(--accent-hover);
        }

        .send-button:disabled {
            background: #add8e6 !important; /* Light blue - force override */
            color: #fff !important;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* Ensure disabled state overrides hover states */
        .send-button:disabled:hover {
            background: #add8e6 !important; /* Light blue */
            color: #fff !important;
            cursor: not-allowed;
            transform: none;
        }

        /* Additional specificity for bottom send button */
        #newBottomSendButton:disabled,
        #newSendButton:disabled {
            background: #add8e6 !important; /* Light blue */
            color: #fff !important;
            cursor: not-allowed;
            box-shadow: none;
        }

        .input-area {
            padding: 20px 30px;
            background: var(--main-bg);
            display: flex;
            gap: 12px;
            align-items: flex-end;
            transition: all 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .input-area.centered {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: transparent;
            z-index: 100;
            width: 70%;
            max-width: 700px;
            min-width: 400px;
            transition: none;
        }

        .input-area.centered.sidebar-visible {
            left: calc(17.5% + (82.5% / 2));
            transform: translate(-50%, -50%);
            width: 60%;
            max-width: min(600px, calc(82.5vw - 60px));
        }

        .input-area.centered.sidebar-hidden {
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: min(800px, calc(100vw - 60px));
        }

        .input-container {
            flex: 1;
            position: relative;
            background: var(--assistant-bg);
            border: 2px solid var(--border-color);
            border-radius: 25px;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s ease;
            min-height: 60px;
            width: 100%;
            max-width: none;
        }

        .input-area.centered .input-container {
            background: var(--assistant-bg);
            border: 2px solid var(--accent-color);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        }

        .input-container:focus-within {
            border-color: var(--border-color);
        }

        #messageInput {
            flex: 1;
            border: none;
            outline: none;
            background: transparent;
            font-size: 16px;
            font-family: inherit;
            color: var(--text-primary);
            resize: none;
            overflow-y: hidden;
            line-height: 1.5;
            min-height: 24px;
            max-height: 120px;
            width: 100%;
            padding: 8px 0;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        #messageInput::-webkit-scrollbar {
            display: none;
        }

        /* Dark mode specific styles for chat input */
        [data-theme="dark"] #messageInput {
            color: #ececec !important;
            background: var(--assistant-bg) !important;
        }

        [data-theme="dark"] .search-input-fixed {
            color: #ececec !important;
            background: rgba(255, 255, 255, 0.05) !important;
        }

        [data-theme="dark"] .search-input-fixed::placeholder {
            color: #9ca3af !important;
        }

        #messageInput::placeholder {
            color: #9ca3af;
        }

        [data-theme="dark"] #messageInput::placeholder {
            color: #9ca3af !important;
        }

        /* Dark mode input container styling */
        [data-theme="dark"] .input-container {
            background: var(--assistant-bg) !important;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .input-area.centered .input-container {
            background: var(--assistant-bg) !important;
            border-color: var(--accent-color) !important;
        }

        .input-icon-button {
            background: #f3f4f6;
            color: #6b7280;
            border: 1px solid #e5e7eb;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 14px;
            flex-shrink: 0;
        }

        .input-icon-button:hover {
            background: #e5e7eb;
            border-color: #d1d5db;
            transform: scale(1.05);
        }

        [data-theme="dark"] .input-icon-button {
            background: var(--hover-bg) !important;
            color: var(--text-secondary) !important;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .input-icon-button:hover {
            background: var(--border-color) !important;
            color: var(--text-primary) !important;
        }

        .input-buttons-group {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
            margin-left: auto;
        }

        .send-button {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 50%;
            background: var(--accent-color);
            color: #fff;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(26,115,232,0.10);
            flex-shrink: 0;
        }

        .send-button:hover:not(:disabled) {
            background: var(--accent-hover);
        }

        .send-button:disabled {
            background: #add8e6; /* Light blue */
            cursor: not-allowed;
            box-shadow: none;
        }

        .stop-button {
            background: #f3f4f6;
            color: #6b7280;
            border: 1px solid #e5e7eb;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 14px;
            flex-shrink: 0;
        }

        .stop-button:hover {
            background: #e5e7eb;
            border-color: #d1d5db;
            transform: scale(1.05);
        }

        .stop-button.visible {
            display: flex;
        }

        .typing-cursor {
            color: var(--accent-color);
            font-weight: bold;
        }

        .loading {
            display: none;
            text-align: center;
            color: var(--text-secondary);
            font-style: italic;
            margin: 10px 0;
        }

        /* Scrollbar Styles */
        .sidebar-content::-webkit-scrollbar,
        .chat-area::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar-content::-webkit-scrollbar-thumb {
            background: var(--sidebar-hover);
            border-radius: 3px;
        }

        .chat-area::-webkit-scrollbar-track {
            background: var(--chat-bg);
        }

        .chat-area::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        /* Welcome Message */
        .welcome-message {
            text-align: center;
            padding: 50px 20px;
            color: var(--text-secondary);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .welcome-message h3 {
            font-size: 20px;
            margin-bottom: 5px;
            color: var(--text-primary);
            font-weight: 600;
        }

        .welcome-message p {
            font-size: 16px;
            line-height: 1.6;
        }

        .welcome-message.centered {
            position: fixed;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            z-index: 50;
            transition: none;
        }

        .welcome-message.centered.sidebar-visible {
            left: calc(17.5% + (82.5% / 2));
            transform: translate(-50%, -50%);
        }

        .welcome-message.centered.sidebar-hidden {
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .welcome-message.hidden {
            opacity: 0;
            transform: translate(-50%, -60%);
        }

        /* Message Edit Button - ChatGPT Style - Hidden */
        .message-toggle {
            display: none !important;
        }

        /* AI Message Click Area */
        .ai-message-hover-area {
            position: absolute;
            top: 0;
            right: 0;
            width: 40px;
            height: 40px;
            cursor: pointer;
            z-index: 10;
        }

        .message.assistant {
            position: relative;
        }

        /* Message Actions Popup - ChatGPT Style */
        .message-actions-popup {
            position: absolute;
            top: 8px;
            left: calc(100% + 8px);
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            min-width: 180px;
            display: none;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            max-height: 300px;
            overflow-y: auto;
        }

        /* Keep message action popups white with black text in dark mode */
        [data-theme="dark"] .message-actions-popup {
            background: white;
            border: 1px solid #e2e8f0;
        }

        .message-actions-popup.show {
            display: block;
            animation: popupFadeIn 0.15s ease-out;
        }

        @keyframes popupFadeIn {
            from {
                opacity: 0;
                transform: translateY(-8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .popup-action {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-primary);
            transition: background-color 0.1s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-family: inherit;
        }

        /* Force popup action text to remain black in dark mode */
        [data-theme="dark"] .popup-action {
            color: #202123;
        }

        .popup-action:first-child {
            border-radius: 8px 8px 0 0;
        }

        .popup-action:last-child {
            border-radius: 0 0 8px 8px;
        }

        .popup-action:only-child {
            border-radius: 8px;
        }

        .popup-action:hover {
            background: #f7f7f8;
        }

        .popup-action-icon {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .popup-action-text {
            flex: 1;
            font-weight: 400;
        }

        /* ChatGPT-style Modal Popup */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.show {
            display: flex;
            animation: modalFadeIn 0.2s ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                backdrop-filter: blur(0px);
            }
            to {
                opacity: 1;
                backdrop-filter: blur(4px);
            }
        }

        .modal-content {
            background: var(--assistant-bg);
            border-radius: 12px;
            padding: 24px;
            min-width: 320px;
            max-width: 90vw;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            animation: modalSlideIn 0.2s ease-out;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            color: var(--text-primary);
        }

        @keyframes modalSlideIn {
            from {
                transform: scale(0.95) translateY(-10px);
                opacity: 0;
            }
            to {
                transform: scale(1) translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Keep Changes Button Styling */
        .popup-action[onclick="keepChanges(this)"] {
            background: rgba(16, 185, 129, 0.1) !important;
            border: 1px solid #10b981 !important;
        }

        .popup-action[onclick="keepChanges(this)"]:hover {
            background: rgba(16, 185, 129, 0.2) !important;
        }

        /* Visualization Menu Styling */
        .popup-action-arrow {
            margin-left: auto;
            font-size: 12px;
            opacity: 0.7;
        }

        .visualization-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        .visual-option-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--assistant-bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
            font-family: inherit;
            width: 100%;
        }

        .visual-option-btn:hover {
            border-color: var(--accent-color);
            background: rgba(26, 115, 232, 0.05);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.15);
        }

        .visual-icon {
            font-size: 24px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(26, 115, 232, 0.1);
            border-radius: 8px;
            flex-shrink: 0;
        }

        .visual-text {
            flex: 1;
        }

        .visual-text strong {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .visual-text small {
            font-size: 12px;
            color: var(--text-secondary);
            opacity: 0.8;
        }

        /* Dark mode support for visualization options */
        [data-theme="dark"] .visual-option-btn {
            background: var(--assistant-bg) !important;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .visual-option-btn:hover {
            border-color: var(--accent-color) !important;
            background: rgba(26, 115, 232, 0.1) !important;
        }

        [data-theme="dark"] .visual-text strong {
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .visual-text small {
            color: var(--text-secondary) !important;
        }

        /* Personalization Modal */
        .personalization-modal {
            background: var(--assistant-bg);
            border-radius: 16px;
            padding: 0;
            min-width: 500px;
            max-width: 600px;
            max-height: 90vh;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            animation: modalSlideIn 0.3s ease-out;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            overflow: hidden;
            color: var(--text-primary);
        }

        .personalization-header {
            background: linear-gradient(135deg, #2c2c2c, #1a1a1a);
            color: white;
            padding: 24px;
            position: relative;
        }

        .personalization-content {
            padding: 24px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .personalization-section {
            margin-bottom: 24px;
        }

        .personalization-section h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #2c2c2c;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        [data-theme="dark"] .personalization-modal {
            background: var(--assistant-bg) !important;
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .personalization-content {
            background: var(--assistant-bg) !important;
        }

        [data-theme="dark"] .personalization-section h3 {
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .enable-label {
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .enable-description {
            color: var(--text-secondary) !important;
        }

        [data-theme="dark"] .personalization-input {
            background: var(--assistant-bg) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .personalization-textarea {
            background: var(--assistant-bg) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .personalization-input:focus {
            border-color: var(--accent-color) !important;
            background: var(--assistant-bg) !important;
        }

        [data-theme="dark"] .personalization-textarea:focus {
            border-color: var(--accent-color) !important;
            background: var(--assistant-bg) !important;
        }

        /* Dark mode specific styles for message edit area */
        [data-theme="dark"] .message-edit-area {
            background: var(--code-bg) !important;
            color: var(--code-fg) !important;
            border-color: var(--border-color) !important;
        }

        .info-icon {
            font-size: 14px;
            color: #666;
            cursor: help;
        }

        .personalization-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s ease;
            background: #f8f9fa;
        }

        .personalization-input:focus {
            border-color: #2c2c2c;
            background: white;
        }

        .personalization-textarea {
            width: 100%;
            min-height: 100px;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s ease;
            background: #f8f9fa;
            resize: vertical;
        }
        .personalization-textarea:focus {
            border-color: #2c2c2c;
            background: white;
        }

        .trait-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .trait-btn {
            padding: 8px 16px;
            background: #f0f0f0;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            color: #2c2c2c;
        }

        .trait-btn:hover {
            background: #e8e8e8;
            border-color: #d0d0d0;
        }

        .trait-btn.active {
            background: #2c2c2c;
            color: white;
            border-color: #2c2c2c;
        }

        .refresh-btn {
            background: #f8f9fa !important;
            border: 2px solid #e0e0e0 !important;
            width: 40px;
            height: 40px;
            border-radius: 50% !important;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .refresh-btn:hover {
            background: #e8e8e8 !important;
            transform: rotate(180deg);
        }

        .enable-section {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .toggle-switch-large {
            position: relative;
            width: 56px;
            height: 32px;
            background: #e0e0e0;
            border-radius: 16px;
            cursor: pointer;
            transition: background 0.3s ease;
            flex-shrink: 0;
        }

        .toggle-switch-large.active {
            background: #2c2c2c;
        }

        .toggle-switch-large::after {
            content: '';
            position: absolute;
            top: 4px;
            left: 4px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle-switch-large.active::after {
            transform: translateX(24px);
        }

        .enable-label {
            font-size: 16px;
            font-weight: 600;
            color: #2c2c2c;
        }

        .enable-description {
            font-size: 14px;
            color: #666;
            margin-top: 2px;
        }

        .personalization-footer {
            padding: 20px 24px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            background: #f8f9fa;
        }

        [data-theme="dark"] .personalization-footer {
            background: var(--assistant-bg) !important;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .modal-button.secondary {
            background: var(--hover-bg) !important;
            color: var(--text-primary) !important;
            border: 1px solid var(--border-color) !important;
        }

        [data-theme="dark"] .modal-button.secondary:hover {
            background: var(--border-color) !important;
        }

        [data-theme="dark"] .modal-button.primary {
            background: var(--accent-color) !important;
            color: white !important;
        }

        [data-theme="dark"] .modal-button.primary:hover {
            background: var(--accent-hover) !important;
        }

        /* Archive Modal */
        .archive-modal {
            background: white;
            border-radius: 12px;
            padding: 0;
            min-width: 500px;
            max-width: 90vw;
            max-height: 70vh;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            animation: modalSlideIn 0.2s ease-out;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            overflow: hidden;
        }

        .archive-header {
            background: linear-gradient(135deg, #2c2c2c, #1a1a1a);
            color: white;
            padding: 20px;
            position: relative;
        }

        .archive-content {
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .archive-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .archived-chat-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: #f8f9fa;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .archived-chat-item:hover {
            background: #f1f3f4;
            border-color: #d1d5db;
        }

        .archived-chat-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            flex: 1;
        }

        .archived-chat-date {
            font-size: 12px;
            color: var(--text-secondary);
            margin-right: 12px;
        }

        .archived-chat-actions {
            display: flex;
            gap: 8px;
        }

        .archive-action-btn {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s;
        }

        .unarchive-btn {
            background: #10b981;
            color: white;
        }

        .unarchive-btn:hover {
            background: #059669;
            transform: scale(1.05);
        }

        .delete-archive-btn {
            background: #ef4444;
            color: white;
        }

        .delete-archive-btn:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        .empty-archive {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        /* Settings Modal */
        .settings-modal {
            background: white;
            border-radius: 12px;
            padding: 0;
            min-width: 400px;
            max-width: 90vw;
            max-height: 80vh;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            animation: modalSlideIn 0.2s ease-out;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            overflow: hidden;
        }

        .settings-header {
            background: linear-gradient(135deg, #2c2c2c, #1a1a1a);
            color: white;
            padding: 20px;
            position: relative;
        }

        .settings-separator {
            height: 1px;
            background: #e5e7eb;
            margin: 16px 0;
        }

        .settings-content {
            padding: 24px;
            max-height: 400px;
            overflow-y: auto;
        }

        [data-theme="dark"] .settings-modal {
            background: var(--assistant-bg) !important;
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .settings-content {
            background: var(--assistant-bg) !important;
        }

        [data-theme="dark"] .setting-label {
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .setting-description {
            color: var(--text-secondary) !important;
        }

        [data-theme="dark"] .settings-section h3 {
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .modal-content {
            background: var(--assistant-bg) !important;
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .modal-title {
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .modal-message {
            color: var(--text-secondary) !important;
        }

        [data-theme="dark"] .modal-input {
            background: var(--assistant-bg) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-color) !important;
        }

        .settings-section {
            margin-bottom: 24px;
        }

        .settings-section h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-label {
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .setting-description {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .toggle-switch.active {
            background: var(--accent-color);
            border-color: var(--accent-color);
        }

        .toggle-switch:hover {
            background: #d0d0d0;
        }

        .toggle-switch.active:hover {
            background: var(--accent-hover);
            border-color: var(--accent-hover);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .toggle-switch.active::after {
            transform: translateX(20px);
        }

        [data-theme="dark"] .toggle-switch {
            background: var(--border-color) !important;
        }

        [data-theme="dark"] .toggle-switch:hover {
            background: var(--hover-bg) !important;
        }

        [data-theme="dark"] .toggle-switch.active {
            background: var(--accent-color) !important;
            border-color: var(--accent-color) !important;
        }

        [data-theme="dark"] .toggle-switch.active:hover {
            background: var(--accent-hover) !important;
            border-color: var(--accent-hover) !important;
        }

        .dropdown-setting {
            min-width: 120px;
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background: white;
            font-size: 14px;
            cursor: pointer;
        }

        .provider-list {
            display: none;
            margin-top: 12px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .provider-list.active {
            display: block;
        }

        .provider-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .provider-checkbox {
            margin-right: 8px;
        }

        .slider-setting {
            width: 120px;
            margin: 0 8px;
        }

        .personalization-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #1a73e8, #1557b0);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            min-width: 120px;
        }

        .personalization-btn:hover {
            background: linear-gradient(135deg, #1764b0, #1348a0);
            transform: translateY(-1px);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .modal-message {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .modal-input {
            width: 100%;
            padding: 12px 16px;
            border: 1.5px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s ease;
            margin-bottom: 24px;
        }

        .modal-input:focus {
            border-color: var(--accent-color);
        }

        .modal-buttons {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .modal-button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
            min-width: 80px;
        }

        .modal-button.secondary {
            background: var(--hover-bg);
            color: var(--text-secondary);
        }

        .modal-button.secondary:hover {
            background: var(--border-color);
        }

        .modal-button.primary {
            background: var(--text-primary);
            color: white;
        }

        .modal-button.primary:hover {
            background: rgba(32, 33, 35, 0.8);
        }

        .modal-button.danger {
            background: #ef4444;
            color: white;
        }

        .modal-button.danger:hover {
            background: #dc2626;
        }

        /* Enhanced message content formatting - Custom prose styles */
        .message .prose,
        .message .custom-prose {
            color: var(--text-primary) !important;
            max-width: none !important;
            line-height: 1.7 !important;
        }

        .message .prose h1,
        .message .prose h2,
        .message .prose h3,
        .message .prose h4,
        .message .prose h5,
        .message .prose h6 {
            color: var(--text-primary) !important;
            font-weight: 600 !important;
            margin-top: 1.5em !important;
            margin-bottom: 0.5em !important;
        }

        .message .prose h1 { font-size: 1.5em !important; }
        .message .prose h2 { font-size: 1.3em !important; }
        .message .prose h3 { font-size: 1.1em !important; }

        .message .prose p {
            color: var(--text-primary) !important;
            line-height: 1.6 !important;
            margin: 0.8em 0 !important;
        }

        .message .prose ul,
        .message .prose ol {
            color: var(--text-primary) !important;
            margin: 1em 0 !important;
            padding-left: 1.5em !important;
        }

        .message .prose li {
            color: var(--text-primary) !important;
            line-height: 1.6 !important;
            margin: 0.3em 0 !important;
        }

        .message .prose code {
            background: var(--code-bg) !important;
            color: var(--code-fg) !important;
            padding: 0.125rem 0.375rem !important;
            border-radius: 0.375rem !important;
            font-family: 'Fira Mono', 'Consolas', monospace !important;
            font-size: 0.875em !important;
            font-weight: 500 !important;
        }

        .message .prose pre {
            background: var(--code-bg) !important;
            color: var(--code-fg) !important;
            padding: 1rem !important;
            border-radius: 0.5rem !important;
            overflow-x: auto !important;
            margin: 1em 0 !important;
            font-family: 'Fira Mono', 'Consolas', monospace !important;
            font-size: 0.875em !important;
            line-height: 1.7 !important;
        }

        .message .prose pre code {
            background: transparent !important;
            padding: 0 !important;
            border-radius: 0 !important;
            font-size: inherit !important;
        }

        .message .prose a {
            color: var(--accent-color) !important;
            text-decoration: underline !important;
            word-break: break-all !important;
        }

        .message .prose blockquote {
            border-left: 4px solid var(--accent-color) !important;
            padding-left: 1rem !important;
            margin: 1em 0 !important;
            font-style: italic !important;
            color: var(--text-secondary) !important;
        }

        .message .prose table {
            border-collapse: collapse !important;
            width: 100% !important;
            margin: 1em 0 !important;
            border-radius: 8px !important;
            overflow: hidden !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1) !important;
        }

        .message .prose th,
        .message .prose td {
            border: 1px solid var(--border-color) !important;
            padding: 12px 16px !important;
            text-align: left !important;
            vertical-align: top !important;
        }

        .message .prose th {
            background: linear-gradient(135deg, var(--accent-color), var(--accent-hover)) !important;
            color: white !important;
            font-weight: 600 !important;
            font-size: 14px !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
        }

        .message .prose td {
            background: var(--assistant-bg) !important;
            transition: background-color 0.2s ease !important;
        }

        .message .prose tr:nth-child(even) td {
            background: var(--hover-bg) !important;
        }

        .message .prose tr:hover td {
            background: rgba(26, 115, 232, 0.1) !important;
        }

        /* Enhanced table responsiveness */
        @media (max-width: 768px) {
            .message .prose table {
                font-size: 14px !important;
            }

            .message .prose th,
            .message .prose td {
                padding: 8px 12px !important;
            }
        }

        /* Chart and diagram containers */
        .chart-container {
            margin: 20px 0;
            padding: 20px;
            background: var(--assistant-bg);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .mermaid {
            text-align: center;
            background: var(--assistant-bg);
            border-radius: 8px;
            padding: 20px;
            margin: 16px 0;
            border: 1px solid var(--border-color);
        }

        [data-theme="dark"] .mermaid {
            background: var(--assistant-bg) !important;
            color: var(--text-primary) !important;
        }

        /* Legacy fallback styles for non-prose content */
        .message h1, .message h2, .message h3 {
            margin: 24px 0 12px 0;
            font-weight: 700;
            color: var(--text-primary);
        }

        .message h1 { font-size: 24px; }
        .message h2 { font-size: 20px; }
        .message h3 { font-size: 18px; }

        .message p {
            margin: 12px 0;
            line-height: 1.6;
            color: var(--text-primary);
        }

        .message ul, .message ol {
            margin: 12px 0 12px 32px;
            color: var(--text-secondary);
        }

        .message li {
            margin-bottom: 8px;
            line-height: 1.6;
            color: var(--text-primary);
        }

        .message code {
            background: var(--code-bg);
            color: var(--code-fg);
            padding: 2px 6px;
            border-radius: 6px;
            font-family: 'Fira Mono', 'Consolas', monospace;
            font-size: 15px;
            margin: 2px 0;
            display: inline-block;
        }

        .message pre {
            background: var(--code-bg);
            color: var(--code-fg);
            padding: 8px 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 12px 0;
            font-family: 'Fira Mono', 'Consolas', monospace;
            font-size: 15px;
            display: block;
        }

        .message a {
            color: var(--accent-color);
            text-decoration: underline;
            word-break: break-all;
        }

        .message blockquote {
            border-left: 4px solid var(--accent-color);
            padding-left: 16px;
            margin: 12px 0;
            font-style: italic;
            color: var(--text-secondary);
        }

        /* Enhanced DataTables and Tabulator styling */
        .datatable-container {
            font-family: 'Inter', 'Segoe UI', Arial, sans-serif !important;
        }

        /* AI Message Toolbar */
        .message-toolbar {
            display: flex;
            align-items: center;
            gap: 4px;
            position: absolute;
            top: 12px;
            right: 12px;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }

        .message-bubble:hover .message-toolbar,
        .message.assistant:hover .message-toolbar {
            opacity: 1;
        }

        .toolbar-btn {
            background-color: var(--hover-bg);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: background-color 0.2s, color 0.2s;
        }

        .toolbar-btn:hover {
            background-color: var(--accent-color);
            color: white;
        }

        /* Message Edit Styling */
        .message-edit-area {
            width: 100%;
            min-height: 150px;
            font-family: inherit;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--assistant-bg);
            color: var(--text-primary);
            font-size: 16px;
            line-height: 1.6;
            resize: vertical;
            outline: none;
        }

        .message-content.editing {
            padding: 5px;
        }

        /* Rich Text Editing Toolbar */
        .edit-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            padding: 8px;
            background: var(--hover-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px 8px 0 0;
            border-bottom: none;
            margin-bottom: 0;
        }

        .toolbar-group {
            display: flex;
            gap: 2px;
            padding-right: 8px;
            border-right: 1px solid var(--border-color);
        }

        .toolbar-group:last-child {
            border-right: none;
            padding-right: 0;
        }

        .toolbar-btn {
            background: transparent;
            border: 1px solid transparent;
            color: var(--text-secondary);
            border-radius: 4px;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
            position: relative;
        }

        .toolbar-btn:hover {
            background: var(--assistant-bg);
            border-color: var(--border-color);
            color: var(--text-primary);
        }

        .toolbar-btn.active {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .toolbar-select {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            outline: none;
            min-width: 80px;
        }

        .toolbar-select:hover, .toolbar-select:focus {
            border-color: var(--accent-color);
        }

        /* New Color Picker Styles */
        .color-palette {
            position: fixed;
            background: var(--assistant-bg);
            border: 2px solid var(--accent-color);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            z-index: 10001;
            display: none;
            width: 280px;
            max-height: 400px;
            overflow-y: auto;
        }

        .color-palette.show {
            display: block;
            animation: colorPaletteSlideIn 0.3s ease-out;
        }

        @keyframes colorPaletteSlideIn {
            from {
                opacity: 0;
                transform: translateY(-10px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .color-palette-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .color-palette-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .color-palette-close {
            width: 24px;
            height: 24px;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .color-palette-close:hover {
            background: var(--hover-bg);
            color: var(--text-primary);
        }

        .color-section {
            margin-bottom: 16px;
        }

        .color-section-title {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .color-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 6px;
            margin-bottom: 12px;
        }

        .color-option {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .color-option:hover {
            border-color: var(--accent-color);
            transform: scale(1.15);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .color-option:active {
            transform: scale(1.05);
        }

        .color-option.selected {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.3);
        }

        .custom-color-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 12px;
            font-family: monospace;
            background: var(--assistant-bg);
            color: var(--text-primary);
            outline: none;
            transition: border-color 0.2s;
        }

        .custom-color-input:focus {
            border-color: var(--accent-color);
        }

        .edit-area-with-toolbar {
            border-radius: 0 0 8px 8px;
            border-top: none;
        }

        /* Ensure proper list formatting in edit area */
        .message-edit-area ol {
            list-style-type: decimal !important;
            padding-left: 20px !important;
            margin-left: 0 !important;
        }

        .message-edit-area ul {
            list-style-type: disc !important;
            padding-left: 20px !important;
            margin-left: 0 !important;
        }

        .message-edit-area ol li,
        .message-edit-area ul li {
            display: list-item !important;
            list-style-position: outside !important;
            margin-bottom: 5px;
        }

        .message-edit-area ol li {
            list-style-type: decimal !important;
        }

        .message-edit-area ul li {
            list-style-type: disc !important;
        }

        /* Dark mode support for toolbar */
        [data-theme="dark"] .edit-toolbar {
            background: var(--hover-bg) !important;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .toolbar-btn {
            color: var(--text-secondary) !important;
        }

        [data-theme="dark"] .toolbar-btn:hover {
            background: var(--assistant-bg) !important;
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .toolbar-select {
            background: var(--assistant-bg) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .color-picker {
            background: var(--assistant-bg) !important;
            border-color: var(--border-color) !important;
        }

        .message-edit-cancel {
            position: absolute;
            top: 8px;
            right: 95px;
            width: 36px;
            height: 36px;
            border: 2px solid #e74c3c;
            background: var(--hover-bg);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #e74c3c;
            transition: all 0.2s ease;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .message-edit-cancel:hover {
            background: #fee2e2;
            border-color: #e74c3c;
            transform: scale(1.05);
        }

        /* Tabulator table styling */
        .tabulator {
            border: 1px solid var(--border-color) !important;
            border-radius: 8px !important;
            font-family: 'Inter', 'Segoe UI', Arial, sans-serif !important;
            font-size: 14px !important;
        }

        .tabulator .tabulator-header {
            background: linear-gradient(135deg, var(--accent-color), var(--accent-hover)) !important;
            color: white !important;
            border-bottom: 2px solid var(--accent-color) !important;
        }

        .tabulator .tabulator-header .tabulator-col {
            background: transparent !important;
            color: white !important;
            border-right: 1px solid rgba(255,255,255,0.2) !important;
        }

        .tabulator .tabulator-header .tabulator-col-title {
            color: white !important;
            font-weight: 600 !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
        }

        .tabulator .tabulator-tableholder .tabulator-table .tabulator-row {
            background: var(--assistant-bg) !important;
            color: var(--text-primary) !important;
            border-bottom: 1px solid var(--border-color) !important;
        }

        .tabulator .tabulator-tableholder .tabulator-table .tabulator-row:nth-child(even) {
            background: var(--hover-bg) !important;
        }

        .tabulator .tabulator-tableholder .tabulator-table .tabulator-row:hover {
            background: rgba(26, 115, 232, 0.1) !important;
        }

        .tabulator .tabulator-tableholder .tabulator-table .tabulator-row .tabulator-cell {
            border-right: 1px solid var(--border-color) !important;
            color: var(--text-primary) !important;
            padding: 12px 16px !important;
        }

        .tabulator .tabulator-footer {
            background: var(--assistant-bg) !important;
            color: var(--text-primary) !important;
            border-top: 1px solid var(--border-color) !important;
        }

        .tabulator .tabulator-footer .tabulator-page {
            background: var(--assistant-bg) !important;
            color: var(--text-primary) !important;
            border: 1px solid var(--border-color) !important;
        }

        .tabulator .tabulator-footer .tabulator-page.active {
            background: var(--accent-color) !important;
            color: white !important;
        }

        /* Dark mode support for Tabulator */
        [data-theme="dark"] .tabulator {
            background: var(--assistant-bg) !important;
        }

        [data-theme="dark"] .tabulator .tabulator-header {
            background: linear-gradient(135deg, var(--accent-color), var(--accent-hover)) !important;
        }

        [data-theme="dark"] .tabulator .tabulator-tableholder .tabulator-table .tabulator-row {
            background: var(--assistant-bg) !important;
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .tabulator .tabulator-tableholder .tabulator-table .tabulator-row:nth-child(even) {
            background: var(--hover-bg) !important;
        }

        /* Medical table specific styling with enhanced borders */
        .medical-table-container .tabulator {
            border: 3px solid var(--accent-color) !important;
            border-radius: 10px !important;
            box-shadow: 0 4px 16px rgba(26, 115, 232, 0.2) !important;
        }

        .medical-table-container .tabulator .tabulator-header {
            background: linear-gradient(135deg, #1a73e8, #1557b0) !important;
            border-bottom: 3px solid var(--accent-color) !important;
        }

        .medical-table-container .tabulator .tabulator-header .tabulator-col {
            border-right: 2px solid rgba(255,255,255,0.3) !important;
            font-weight: 700 !important;
            text-transform: uppercase !important;
            letter-spacing: 0.8px !important;
            padding: 15px 20px !important;
        }

        .medical-table-container .tabulator .tabulator-tableholder .tabulator-table .tabulator-row {
            border-bottom: 2px solid var(--border-color) !important;
        }

        .medical-table-container .tabulator .tabulator-tableholder .tabulator-table .tabulator-row .tabulator-cell {
            border-right: 2px solid var(--border-color) !important;
            padding: 15px 20px !important;
            font-size: 14px !important;
            line-height: 1.6 !important;
        }

        .medical-table-container .tabulator .tabulator-tableholder .tabulator-table .tabulator-row .tabulator-cell:first-child {
            background: rgba(26, 115, 232, 0.05) !important;
            font-weight: 600 !important;
            color: var(--accent-color) !important;
        }

        .medical-table-container .tabulator .tabulator-tableholder .tabulator-table .tabulator-row:hover {
            background: rgba(26, 115, 232, 0.08) !important;
        }

        /* Dark mode for medical tables */
        [data-theme="dark"] .medical-table-container .tabulator .tabulator-tableholder .tabulator-table .tabulator-row .tabulator-cell:first-child {
            background: rgba(26, 115, 232, 0.1) !important;
            color: var(--accent-color) !important;
        }

        .dataTables_wrapper {
            color: var(--text-primary) !important;
        }

        .dataTables_wrapper .dataTables_length select,
        .dataTables_wrapper .dataTables_filter input {
            background: var(--assistant-bg) !important;
            color: var(--text-primary) !important;
            border: 1px solid var(--border-color) !important;
            border-radius: 6px !important;
            padding: 6px 12px !important;
        }

        .dataTables_wrapper .dataTables_filter input:focus {
            border-color: var(--accent-color) !important;
            outline: none !important;
        }

        .table-striped tbody tr:nth-of-type(odd) {
            background-color: var(--hover-bg) !important;
        }

        .table-bordered th,
        .table-bordered td {
            border: 1px solid var(--border-color) !important;
            color: var(--text-primary) !important;
        }

        .table thead th {
            background: linear-gradient(135deg, var(--accent-color), var(--accent-hover)) !important;
            color: white !important;
            font-weight: 600 !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
            font-size: 12px !important;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button {
            color: var(--text-primary) !important;
            background: var(--assistant-bg) !important;
            border: 1px solid var(--border-color) !important;
            border-radius: 4px !important;
            margin: 0 2px !important;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
            background: var(--hover-bg) !important;
            border-color: var(--accent-color) !important;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            background: var(--accent-color) !important;
            color: white !important;
            border-color: var(--accent-color) !important;
        }

        .dt-buttons {
            margin-bottom: 15px !important;
        }

        .dt-button {
            background: linear-gradient(135deg, #6b7280, #4b5563) !important;
            color: white !important;
            border: none !important;
            border-radius: 6px !important;
            padding: 6px 12px !important;
            margin: 0 3px !important;
            font-size: 12px !important;
            transition: all 0.2s ease !important;
        }

        .dt-button:hover {
            background: linear-gradient(135deg, #4b5563, #374151) !important;
            transform: translateY(-1px) !important;
        }

        /* Chart container enhancements */
        .chart-container {
            position: relative;
            margin: 20px 0;
            padding: 20px;
            background: var(--assistant-bg);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .chart-download-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }

        [data-theme="dark"] .datatable-container,
        [data-theme="dark"] .chart-container {
            background: var(--assistant-bg) !important;
            color: var(--text-primary) !important;
        }

        /* Dark mode support for Tailwind prose styles */
        [data-theme="dark"] .message .prose,
        [data-theme="dark"] .message .prose * {
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .message .prose h1,
        [data-theme="dark"] .message .prose h2,
        [data-theme="dark"] .message .prose h3,
        [data-theme="dark"] .message .prose h4,
        [data-theme="dark"] .message .prose h5,
        [data-theme="dark"] .message .prose h6 {
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .message .prose p,
        [data-theme="dark"] .message .prose li,
        [data-theme="dark"] .message .prose strong,
        [data-theme="dark"] .message .prose em {
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .message .prose blockquote {
            color: var(--text-secondary) !important;
        }

        [data-theme="dark"] .message .prose code {
            background: var(--code-bg) !important;
            color: var(--code-fg) !important;
        }

        [data-theme="dark"] .message .prose pre {
            background: var(--code-bg) !important;
            color: var(--code-fg) !important;
        }

        [data-theme="dark"] .message .prose a {
            color: var(--accent-color) !important;
        }

        [data-theme="dark"] .message .prose th {
            background: var(--hover-bg) !important;
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .message .prose td {
            color: var(--text-primary) !important;
        }

        /* Dark mode specific text overrides for all message content (fallback) */
        [data-theme="dark"] .message.assistant {
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .message.assistant * {
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .message.assistant h1,
        [data-theme="dark"] .message.assistant h2,
        [data-theme="dark"] .message.assistant h3,
        [data-theme="dark"] .message.assistant p,
        [data-theme="dark"] .message.assistant div,
        [data-theme="dark"] .message.assistant span,
        [data-theme="dark"] .message.assistant li,
        [data-theme="dark"] .message.assistant strong,
        [data-theme="dark"] .message.assistant em,
        [data-theme="dark"] .message.assistant .message-content {
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .message.assistant ul,
        [data-theme="dark"] .message.assistant ol {
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .message.assistant blockquote {
            color: var(--text-secondary) !important;
        }

        /* Arabic RTL text styling */
        [dir="rtl"] {
            direction: rtl;
            text-align: justify;
            unicode-bidi: bidi-override;
            font-family: 'Arial', 'Tahoma', 'Segoe UI', sans-serif;
            line-height: 1.8;
            letter-spacing: 0.02em;
        }

        /* Dark mode support for RTL text */
        [data-theme="dark"] [dir="rtl"] {
            background: var(--assistant-bg) !important;
            color: var(--text-primary) !important;
            border-right-color: var(--accent-color) !important;
        }

        /* Enhanced Arabic text container */
        .arabic-text-container {
            direction: rtl;
            text-align: justify;
            font-family: 'Arial', 'Tahoma', 'Segoe UI', sans-serif;
            line-height: 1.8;
            margin: 10px 0;
            padding: 15px;
            background: rgba(0,0,0,0.05);
            border-radius: 8px;
            border-right: 4px solid #1a73e8;
            word-spacing: 0.1em;
            letter-spacing: 0.02em;
        }

        [data-theme="dark"] .arabic-text-container {
            background: rgba(255,255,255,0.05) !important;
            color: var(--text-primary) !important;
            border-right-color: var(--accent-color) !important;
        }

        /* Responsive Design - ChatGPT Mobile Specifications */
        @media (max-width: 768px) {
            body {
                font-size: 15px;
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                order: 2;
            }

            .main-area {
                width: 100%;
                order: 1;
                height: calc(100vh - 200px);
                border-radius: 0;
                max-width: 100vw;
            }

            .chat-area, .chat-header, .chat-input-container {
                padding: 12px !important;
            }

            .input-wrapper {
                gap: 8px;
            }

            #messageInput {
                padding: 12px 16px;
                font-size: 15px;
            }

            .send-button {
                width: 44px;
                height: 44px;
                font-size: 18px;
            }

            .message {
                max-width: 90%;
                padding: 12px 12px;
                font-size: 15px;
            }

            .sidebar-content {
                padding: 12px;
            }

            .chat-item {
                padding: 12px;
            }
        }

        .typing-indicator {
            display: none;
            padding: 15px 20px;
            margin: 10px 0;
            background: #f8f9fa;
            border-radius: 12px;
            max-width: 80%;
            align-self: flex-start;
            font-style: italic;
            color: #666;
        }

        .thinking-animation {
            display: none;
            padding: 0;
            margin: 0;
            background: transparent;
            border: none;
            box-shadow: none;
            position: relative;
            font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.6;
        }

        [data-theme="dark"] .thinking-animation {
            color: #ececec !important;
        }

        [data-theme="dark"] .thinking-text {
            color: #ececec !important;
        }

        .thinking-text {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 400;
        }

        .thinking-dots {
            display: flex;
            gap: 2px;
            margin-left: 2px;
        }

        .thinking-dot {
            width: 3px;
            height: 3px;
            border-radius: 50%;
            background: var(--text-primary);
            animation: genspark-pulse 1.2s ease-in-out infinite;
        }

        [data-theme="dark"] .thinking-dot {
            background: #ececec !important;
        }

        .thinking-dot:nth-child(1) {
            animation-delay: 0s;
        }

        .thinking-dot:nth-child(2) {
            animation-delay: 0.15s;
        }

        .thinking-dot:nth-child(3) {
            animation-delay: 0.3s;
        }

        @keyframes genspark-pulse {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1.1);
                opacity: 1;
            }
        }

        .thinking-animation.fade-out {
            opacity: 0;
            transform: translateY(-5px);
            transition: opacity 300ms ease-out, transform 300ms ease-out;
        }

        /* Custom styles for chat list scrollability */
        .chat-list-scrollable {
            overflow-y: auto;
            flex: 1;
            min-height: 0;
            padding-right: 4px;
        }

        .chat-list-scrollable::-webkit-scrollbar {
            width: 6px;
        }

        .chat-list-scrollable::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-list-scrollable::-webkit-scrollbar-thumb {
            background: var(--sidebar-hover);
            border-radius: 3px;
        }

        /* New Provider Selector Popup - Compact & Smart */
        .provider-selector-popup {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--assistant-bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            width: 280px;
            max-height: 400px;
            display: none;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            backdrop-filter: blur(8px);
        }

        .provider-selector-popup.show {
            display: block;
            animation: providerPopupSlideUp 0.3s ease-out;
        }

        @keyframes providerPopupSlideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .provider-popup-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .provider-popup-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .provider-popup-close {
            width: 24px;
            height: 24px;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .provider-popup-close:hover {
            background: var(--hover-bg);
            color: var(--text-primary);
        }

        .provider-options-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 12px;
            max-height: 280px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .provider-options-list::-webkit-scrollbar {
            width: 4px;
        }

        .provider-options-list::-webkit-scrollbar-track {
            background: var(--hover-bg);
            border-radius: 2px;
        }

        .provider-options-list::-webkit-scrollbar-thumb {
            background: var(--accent-color);
            border-radius: 2px;
        }

        .provider-options-list::-webkit-scrollbar-thumb:hover {
            background: var(--accent-hover);
        }

        .provider-choice {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            background: var(--assistant-bg);
        }

        .provider-choice:hover {
            background: var(--hover-bg);
            border-color: var(--accent-color);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .provider-choice.active {
            background: rgba(26, 115, 232, 0.25);
            border-color: var(--accent-color);
            box-shadow: 0 0 0 1px rgba(26, 115, 232, 0.4);
        }

        .provider-radio {
            display: none;
        }

        .provider-details {
            flex: 1;
            min-width: 0;
        }

        .provider-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 1px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .provider-desc {
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.3;
        }

        .provider-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 8px;
            background: #10b981;
            transition: all 0.3s ease;
        }

        .provider-indicator.connected {
            background: #10b981;
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.6);
        }

        .provider-indicator.disconnected {
            background: #f59e0b;
            animation: blink-warning 1.5s infinite;
        }

        .provider-indicator.offline {
            background: #ef4444;
        }

        @keyframes blink-warning {
            0%, 50% {
                opacity: 1;
                background: #f59e0b;
                box-shadow: 0 0 6px rgba(245, 158, 11, 0.8);
            }
            51%, 100% {
                opacity: 0.4;
                background: #fbbf24;
                box-shadow: 0 0 3px rgba(245, 158, 11, 0.4);
            }
        }

        .provider-controls {
            display: flex;
            gap: 6px;
            justify-content: flex-end;
            padding-top: 8px;
            border-top: 1px solid var(--border-color);
        }

        .provider-control-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            min-width: 60px;
        }

        .provider-control-btn.test-btn {
            background: var(--hover-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .provider-control-btn.test-btn:hover {
            background: var(--border-color);
        }

        .provider-control-btn.apply-btn {
            background: var(--accent-color);
            color: white;
        }

        .provider-control-btn.apply-btn:hover {
            background: var(--accent-hover);
        }

        .provider-control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Dark mode support */
        [data-theme="dark"] .provider-selector-popup {
            background: var(--assistant-bg) !important;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .provider-label {
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .provider-desc {
            color: var(--text-secondary) !important;
        }

        [data-theme="dark"] .provider-popup-title {
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .provider-popup-close {
            color: var(--text-secondary) !important;
        }

        [data-theme="dark"] .provider-popup-close:hover {
            color: var(--text-primary) !important;
            background: var(--hover-bg) !important;
        }

        [data-theme="dark"] .provider-control-btn.test-btn {
            background: var(--hover-bg) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-color) !important;
        }

        [data-theme="dark"] .provider-control-btn.test-btn:hover {
            background: var(--border-color) !important;
        }

        [data-theme="dark"] .provider-control-btn.apply-btn {
            background: var(--accent-color) !important;
            color: white !important;
        }

        [data-theme="dark"] .provider-control-btn.apply-btn:hover {
            background: var(--accent-hover) !important;
        }

        [data-theme="dark"] .provider-choice.active {
            background: rgba(26, 115, 232, 0.35) !important;
            border-color: var(--accent-color) !important;
            box-shadow: 0 0 0 1px rgba(26, 115, 232, 0.5) !important;
        }

        /* Diagram Option Buttons */
        .diagram-option-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
            color: white;
            background: linear-gradient(135deg, #1a73e8, #1557b0);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .diagram-option-btn:hover {
            background: linear-gradient(135deg, #1764b0, #1348a0);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
        }

        .diagram-option-btn.chart-btn {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .diagram-option-btn.chart-btn:hover {
            background: linear-gradient(135deg, #059669, #047857);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .diagram-option-btn.table-btn {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .diagram-option-btn.table-btn:hover {
            background: linear-gradient(135deg, #d97706, #b45309);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        .diagram-option-btn.custom-btn {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }

        .diagram-option-btn.custom-btn:hover {
            background: linear-gradient(135deg, #7c3aed, #6d28d9);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        /* Dark mode support for diagram buttons */
        [data-theme="dark"] .diagram-option-btn {
            color: white !important;
        }

        /* Confirmation Toast */
        .confirmation-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            display: none;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            font-size: 14px;
            font-weight: 500;
            max-width: 300px;
        }

        .confirmation-toast.show {
            display: block;
            animation: toastSlideIn 0.3s ease-out;
        }

        .confirmation-toast.hide {
            animation: toastSlideOut 0.3s ease-in;
        }

        @keyframes toastSlideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes toastSlideOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar hidden" id="sidebar">
        <div class="sidebar-header">
            <h1>Ahmed Abdelrazik</h1>
        </div>

        <!-- Separator -->
        <div class="sidebar-separator"></div>

        <div class="sidebar-content">
            <!-- Action Buttons Section -->
            <div class="sidebar-actions">
                <button class="new-chat-btn" onclick="startNewChat()">
                    <span>+</span>
                    New chat
                </button>

                <div class="search-container-fixed">
                    <input type="text" class="search-input-fixed" placeholder="Search chats" id="searchInput" oninput="searchChats()">
                    <span class="search-icon">ðŸ”</span>
                </div>



                <button class="archive-btn" onclick="toggleArchivePopup()">
                    <span>ðŸ“¦</span>
                    Archive
                </button>
            </div>

            <div class="divider"></div>

            <!-- Separator above CHATS -->
            <div class="sidebar-separator"></div>

            <div class="sidebar-section">
                <h3>Chats</h3>
                <div id="chatList" class="chat-list-scrollable">
                    <div class="chat-item active" data-chat-id="1" onclick="selectChat(this, event)">
                        <div class="chat-content">
                            <span class="chat-title">Current Conversation</span>
                        </div>
                        <div class="chat-menu">
                            <button class="chat-menu-btn" onclick="toggleChatMenu(event, this)">â€¦</button>
                            <div class="chat-dropdown">
                                <button class="dropdown-item" onclick="renameChat(event, 1)">
                                    <span class="dropdown-icon">âœï¸</span>
                                    <span class="dropdown-text">Rename</span>
                                </button>
                                <button class="dropdown-item" onclick="archiveChat(event, 1)">
                                    <span class="dropdown-icon">ðŸ“¦</span>
                                    <span class="dropdown-text">Archive</span>
                                </button>
                                <button class="dropdown-item" onclick="deleteChat(event, 1)">
                                    <span class="dropdown-icon">ðŸ—‘ï¸</span>
                                    <span class="dropdown-text">Delete</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="chat-item" data-chat-id="2" onclick="selectChat(this, event)">
                        <div class="chat-content">
                            <span class="chat-title">Medical Diagnosis Help</span>
                        </div>
                        <div class="chat-menu">
                            <button class="chat-menu-btn" onclick="toggleChatMenu(event, this)">â€¦</button>
                            <div class="chat-dropdown">
                                <button class="dropdown-item" onclick="renameChat(event, 2)">
                                    <span class="dropdown-icon">âœï¸</span>
                                    <span class="dropdown-text">Rename</span>
                                </button>
                                <button class="dropdown-item" onclick="archiveChat(event, 2)">
                                    <span class="dropdown-icon">ðŸ“¦</span>
                                    <span class="dropdown-text">Archive</span>
                                </button>
                                <button class="dropdown-item" onclick="deleteChat(event, 2)">
                                    <span class="dropdown-icon">ðŸ—‘ï¸</span>
                                    <span class="dropdown-text">Delete</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="chat-item" data-chat-id="3" onclick="selectChat(this, event)">
                        <div class="chat-content">
                            <span class="chat-title">Treatment Planning</span>
                        </div>
                        <div class="chat-menu">
                            <button class="chat-menu-btn" onclick="toggleChatMenu(event, this)">â€¦</button>
                            <div class="chat-dropdown">
                                <button class="dropdown-item" onclick="renameChat(event, 3)">
                                    <span class="dropdown-icon">âœï¸</span>
                                    <span class="dropdown-text">Rename</span>
                                </button>
                                <button class="dropdown-item" onclick="archiveChat(event, 3)">
                                    <span class="dropdown-icon">ðŸ“¦</span>
                                    <span class="dropdown-text">Archive</span>
                                </button>
                                <button class="dropdown-item" onclick="deleteChat(event, 3)">
                                    <span class="dropdown-icon">ðŸ—‘ï¸</span>
                                    <span class="dropdown-text">Delete</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="chat-item" data-chat-id="4" onclick="selectChat(this, event)">
                        <div class="chat-content">
                            <span class="chat-title">Patient Care Guidelines</span>
                        </div>
                        <div class="chat-menu">
                            <button class="chat-menu-btn" onclick="toggleChatMenu(event, this)">â€¦</button>
                            <div class="chat-dropdown">
                                <button class="dropdown-item" onclick="renameChat(event, 4)">
                                    <span class="dropdown-icon">âœï¸</span>
                                    <span class="dropdown-text">Rename</span>
                                </button>
                                <button class="dropdown-item" onclick="archiveChat(event, 4)">
                                    <span class="dropdown-icon">ðŸ“¦</span>
                                    <span class="dropdown-text">Archive</span>
                                </button>
                                <button class="dropdown-item" onclick="deleteChat(event, 4)">
                                    <span class="dropdown-icon">ðŸ—‘ï¸</span>
                                    <span class="dropdown-text">Delete</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="chat-item" data-chat-id="5" onclick="selectChat(this, event)">
                        <div class="chat-content">
                            <span class="chat-title">Research Analysis</span>
                        </div>
                        <div class="chat-menu">
                            <button class="chat-menu-btn" onclick="toggleChatMenu(event, this)">â€¦</button>
                            <div class="chat-dropdown">
                                <button class="dropdown-item" onclick="renameChat(event, 5)">
                                    <span class="dropdown-icon">âœï¸</span>
                                    <span class="dropdown-text">Rename</span>
                                </button>
                                <button class="dropdown-item" onclick="archiveChat(event, 5)">
                                    <span class="dropdown-icon">ðŸ“¦</span>
                                    <span class="dropdown-text">Archive</span>
                                </button>
                                <button class="dropdown-item" onclick="deleteChat(event, 5)">
                                    <span class="dropdown-icon">ðŸ—‘ï¸</span>
                                    <span class="dropdown-text">Delete</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Chat Area -->
    <div class="main-area full-width" id="mainArea">
        <div class="chat-header">
            <button class="sidebar-toggle" id="sidebarToggle" onclick="toggleSidebar()" title="Toggle sidebar">
                <span class="toggle-icon" id="toggleIcon">â˜°</span>
            </button>
            <h2>MavericPro</h2>
            <button class="settings-toggle" onclick="toggleSettings()" title="Settings">
                <span>âš™ï¸</span>
            </button>
        </div>

        <div class="chat-area" id="chatArea">
            <div class="welcome-message centered" id="welcomeMessage">
                <h3>What can I help with?</h3>
            </div>
        </div>

        <div class="loading" id="loading">AI is thinking...</div>

        <div class="input-area centered" id="inputArea">
            <div class="input-container">
                <textarea id="messageInput" placeholder="Ask MavericPro" rows="1"></textarea>
                <div class="input-buttons-group">
                    <button class="input-icon-button" onclick="toggleProviderSelector()" title="Select AI Provider" id="providerToggleBtn">
                        <span id="providerIcon">ðŸŒ</span>
                    </button>
                    <button class="input-icon-button" onclick="handleAttachment()" title="Attach Files">+</button>
                    <button class="input-icon-button" onclick="handleDictate()" title="Dictate">ðŸŽ¤</button>
                    <button class="input-icon-button" onclick="handleVoiceMode()" title="Voice Mode">ðŸ—£ï¸</button>
                    <button class="send-button" id="newSendButton" title="Send Message" disabled>â†‘</button>
                </div>
            </div>
        </div>

        <!-- Fixed bottom input area for subsequent messages -->
        <div class="input-area" id="bottomInputArea" style="display: none; position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000; background: var(--main-bg); padding: 20px 90px; transition: left 0.3s ease;">
            <div class="input-container" style="max-width: 700px; width: 100%; margin: 0 auto; min-height: 60px;">
                <textarea id="bottomMessageInput" placeholder="Ask MavericPro" rows="1" style="flex: 1; border: none; outline: none; background: transparent; font-size: 16px; font-family: inherit; color: var(--text-primary); resize: none; overflow-y: auto; line-height: 1.5; min-height: 44px; max-height: 120px; width: 100%; padding: 12px 0;"></textarea>
                <div class="input-buttons-group">
                    <button class="input-icon-button" onclick="toggleProviderSelector()" title="Select AI Provider" id="bottomProviderToggleBtn">
                        <span id="bottomProviderIcon">ðŸŒ</span>
                    </button>
                    <button class="input-icon-button" onclick="handleAttachment()" title="Attach Files">+</button>
                    <button class="input-icon-button" onclick="handleDictate()" title="Dictate">ðŸŽ¤</button>
                    <button class="input-icon-button" onclick="handleVoiceMode()" title="Voice Mode">ðŸ—£ï¸</button>
                    <button class="send-button" id="newBottomSendButton" title="Send Message" disabled>â†‘</button>
                </div>
            </div>
        </div>


    </div>

    <!-- Modal Popup -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle">Confirm Action</div>
            <div class="modal-message" id="modalMessage">Are you sure you want to proceed?</div>
            <input type="text" class="modal-input" id="modalInput" style="display: none;" placeholder="Enter new name">
            <div class="modal-buttons">
                <button class="modal-button secondary" onclick="closeModal()">Cancel</button>
                <button class="modal-button primary" id="modalConfirmBtn" onclick="confirmModalAction()">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Archive Popup Modal -->
    <div class="modal-overlay" id="archiveOverlay">
        <div class="archive-modal">
            <div class="archive-header">
                <h2 style="margin: 0; font-size: 18px; font-weight: 600;">Archived Chats</h2>
                <button onclick="toggleArchivePopup()" style="position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.2); border: none; color: white; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">Ã—</button>
            </div>

            <div class="archive-content" id="archiveContent">
                <div class="archive-list" id="archivedChatsList">
                    <!-- Archived chats will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsOverlay">
        <div class="settings-modal">
            <div class="settings-header">
                <h2 style="margin: 0; font-size: 18px; font-weight: 600;">Settings</h2>
                <button onclick="toggleSettings()" style="position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.2); border: none; color: white; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">Ã—</button>
            </div>

            <div class="settings-content">
                <!-- Theme Section -->
                <div class="settings-section">
                    <h3>Theme</h3>
                    <div class="setting-item">
                        <div>
                            <div class="setting-label">Dark Mode</div>
                            <div class="setting-description">Switch between light and dark themes</div>
                        </div>
                        <div class="toggle-switch" id="darkModeToggle" onclick="toggleDarkModeSetting()"></div>
                    </div>
                </div>

                <div class="settings-separator"></div>

                <!-- Memory Section -->
                <div class="settings-section">
                    <h3>Memory</h3>
                    <div class="setting-item">
                        <div>
                            <div class="setting-label">Conversation Memory</div>
                            <div class="setting-description">Remember conversation history</div>
                        </div>
                        <div class="toggle-switch active" id="memoryToggle" onclick="toggleMemorySetting()"></div>
                    </div>
                </div>

                <div class="settings-separator"></div>

                <!-- Customization -->
                <div class="settings-section">
                    <h3>Customization</h3>
                    <div class="setting-item">
                        <div>
                            <div class="setting-label">Personalization</div>
                            <div class="setting-description">Customize AI personality and behavior</div>
                        </div>
                        <button class="personalization-btn" onclick="openPersonalizationModal()">
                            <span>ðŸŽ¯</span>
                            <span>Customize</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="personalization-footer">
                <button class="modal-button secondary" onclick="cancelSettings()">Cancel</button>
                <button class="modal-button primary" onclick="saveSettings()">Save</button>
            </div>
        </div>
    </div>



    <!-- New Provider Selector Popup -->
    <div class="provider-selector-popup" id="newProviderSelectorPopup">
        <div class="provider-popup-header">
        </div>

        <div class="provider-options-list" id="newProviderOptions">
            <div class="provider-choice active" data-provider="deepseek-chat" onclick="selectNewProvider('deepseek-chat')">
                <input type="radio" class="provider-radio" name="newProvider" id="new-check-deepseek-chat" checked>
                <div class="provider-details">
                    <div class="provider-label">DeepSeek Chat</div>
                </div>
                <div class="provider-indicator" id="new-status-deepseek-chat"></div>
            </div>

            <div class="provider-choice" data-provider="deepseek-reasoning" onclick="selectNewProvider('deepseek-reasoning')">
                <input type="radio" class="provider-radio" name="newProvider" id="new-check-deepseek-reasoning">
                <div class="provider-details">
                    <div class="provider-label">DeepSeek Reasoner</div>
                </div>
                <div class="provider-indicator" id="new-status-deepseek-reasoning"></div>
            </div>

            <div class="provider-choice" data-provider="mistral" onclick="selectNewProvider('mistral')">
                <input type="radio" class="provider-radio" name="newProvider" id="new-check-mistral">
                <div class="provider-details">
                    <div class="provider-label">Mistral AI</div>
                </div>
                <div class="provider-indicator" id="new-status-mistral"></div>
            </div>

            <div class="provider-choice" data-provider="openai" onclick="selectNewProvider('openai')">
                <input type="radio" class="provider-radio" name="newProvider" id="new-check-openai">
                <div class="provider-details">
                    <div class="provider-label">OpenAI GPT-4o</div>
                </div>
                <div class="provider-indicator" id="new-status-openai"></div>
            </div>

            <div class="provider-choice" data-provider="grok" onclick="selectNewProvider('grok')">
                <input type="radio" class="provider-radio" name="newProvider" id="new-check-grok">
                <div class="provider-details">
                    <div class="provider-label">Grok (xAI)</div>
                </div>
                <div class="provider-indicator" id="new-status-grok"></div>
            </div>

            <div class="provider-choice" data-provider="google" onclick="selectNewProvider('google')">
                <input type="radio" class="provider-radio" name="newProvider" id="new-check-google">
                <div class="provider-details">
                    <div class="provider-label">Google Gemini</div>
                </div>
                <div class="provider-indicator" id="new-status-google"></div>
            </div>

            <div class="provider-choice" data-provider="wolfram" onclick="selectNewProvider('wolfram')">
                <input type="radio" class="provider-radio" name="newProvider" id="new-check-wolfram">
                <div class="provider-details">
                    <div class="provider-label">Wolfram Alpha</div>
                </div>
                <div class="provider-indicator" id="new-status-wolfram"></div>
            </div>

        </div>

        <div class="provider-controls">
            <button class="provider-control-btn apply-btn" onclick="applyNewProvider()">Apply</button>
        </div>
    </div>

    <!-- Confirmation Toast -->
    <div class="confirmation-toast" id="confirmationToast"></div>

    <!-- Personalization Modal -->
    <div class="modal-overlay" id="personalizationOverlay">
        <div class="personalization-modal">
            <div class="personalization-header">
                <h2 style="margin: 0; font-size: 24px; font-weight: 600; color: white;">Customize MavericPro</h2>
                <p style="margin: 8px 0 0 0; font-size: 16px; color: rgba(255,255,255,0.8);">Introduce yourself to get better, more personalized responses</p>
                <button onclick="closePersonalizationModal()" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px;">Ã—</button>
            </div>

            <div class="personalization-content">
                <div class="personalization-section">
                    <h3>What should MavericPro call you?</h3>
                    <input type="text" class="personalization-input" id="userName" placeholder="Enter your preferred name or title" value="Medical Professional">
                </div>

                <div class="personalization-section">
                    <h3>What do you do?</h3>
                    <textarea class="personalization-textarea" id="userRole" placeholder="Describe your role, profession, or area of expertise">For any medical questions, make your answer based 100% on RCOG, NICE, FSRH, RCGP, UKGRC, MEDPAC, UK GMC, AMD Digital, GM & BON, PUH PO guidelines. Make answers formatted properly and professional for medical professionals.</textarea>
                </div>

                <div class="personalization-section">
                    <h3>What traits should MavericPro have? <span class="info-icon" title="These traits help customize the AI's personality and communication style">â„¹ï¸</span></h3>
                    <textarea class="personalization-textarea" id="aiTraits" placeholder="Describe how you'd like the AI to behave and communicate">Ensure that all answers to my questions are accurate and come from reputable sources, and always include citations and links to the sources of information.

When answer any of my questions, don't show the results as a separate page.</textarea>
                </div>

                <div class="personalization-section">
                    <h3>Communication Style</h3>
                    <div class="trait-buttons">
                        <button class="trait-btn" data-trait="chatty" onclick="toggleTrait(this)">+ Chatty</button>
                        <button class="trait-btn" data-trait="witty" onclick="toggleTrait(this)">+ Witty</button>
                        <button class="trait-btn" data-trait="straight-shooting" onclick="toggleTrait(this)">+ Straight shooting</button>
                        <button class="trait-btn" data-trait="encouraging" onclick="toggleTrait(this)">+ Encouraging</button>
                        <button class="trait-btn" data-trait="gen-z" onclick="toggleTrait(this)">+ Gen Z</button>
                        <button class="trait-btn" data-trait="skeptical" onclick="toggleTrait(this)">+ Skeptical</button>
                        <button class="trait-btn" data-trait="traditional" onclick="toggleTrait(this)">+ Traditional</button>
                        <button class="trait-btn" data-trait="forward-thinking" onclick="toggleTrait(this)">+ Forward thinking</button>
                        <button class="trait-btn" data-trait="poetic" onclick="toggleTrait(this)">+ Poetic</button>
                        <button class="trait-btn refresh-btn" onclick="refreshTraits()" title="Refresh traits">ðŸ”„</button>
                    </div>
                </div>

                <div class="personalization-section">
                    <div class="enable-section">
                        <div class="toggle-switch-large active" id="enablePersonalization" onclick="togglePersonalizationEnabled()"></div>
                        <div>
                            <div class="enable-label">Enable for new chats</div>
                            <div class="enable-description">This customization will be applied to new conversations</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="personalization-footer">
                <button class="modal-button secondary" onclick="closePersonalizationModal()">Cancel</button>
                <button class="modal-button primary" onclick="savePersonalization()">Save</button>
            </div>
        </div>
    </div>

    <!-- Enhanced DOM initialization with error handling -->
    <script>
    let initializationComplete = false;
    let retryCount = 0;
    const maxRetries = 3;

    function initializeApp() {
        if (initializationComplete) return;

        try {
            console.log('Starting app initialization...');

            // Wait for DOM to be fully ready
            if (document.readyState !== 'complete') {
                setTimeout(initializeApp, 100);
                return;
            }

            // Remove duplicate elements by ID
            const seen = new Set();
            document.querySelectorAll('[id]').forEach(el => {
                if (seen.has(el.id)) {
                    console.log(`Removing duplicate element with ID: ${el.id}`);
                    el.remove();
                } else {
                    seen.add(el.id);
                }
            });

            // Ensure all required elements exist
            const requiredElements = ['newSendButton', 'newBottomSendButton', 'messageInput', 'bottomMessageInput'];
            const missingElements = requiredElements.filter(id => !document.getElementById(id));

            if (missingElements.length > 0 && retryCount < maxRetries) {
                console.warn('Missing elements:', missingElements, '- retrying...');
                retryCount++;
                setTimeout(initializeApp, 200);
                return;
            }

            // Initialize button handlers with error boundaries
            const sendButton = document.getElementById('newSendButton');
            const bottomSendButton = document.getElementById('newBottomSendButton');

            if (sendButton && !sendButton.hasAttribute('data-initialized')) {
                sendButton.onclick = function(e) {
                    try {
                        e.preventDefault();
                        if (typeof sendMessage === 'function') {
                            sendMessage();
                        }
                    } catch (error) {
                        console.error('Send button error:', error);
                    }
                };
                sendButton.setAttribute('data-initialized', 'true');
            }

            if (bottomSendButton && !bottomSendButton.hasAttribute('data-initialized')) {
                bottomSendButton.onclick = function(e) {
                    try {
                        e.preventDefault();
                        if (typeof sendMessageFromBottom === 'function') {
                            sendMessageFromBottom();
                        }
                    } catch (error) {
                        console.error('Bottom send button error:', error);
                    }
                };
                bottomSendButton.setAttribute('data-initialized', 'true');
            }

            // Initialize input handlers with error boundaries
            const messageInput = document.getElementById('messageInput');
            const bottomMessageInput = document.getElementById('bottomMessageInput');

            if (messageInput && !messageInput.hasAttribute('data-initialized')) {
                messageInput.addEventListener('keydown', function(e) {
                    try {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            if (window.isGenerating && typeof stopGeneration === 'function') {
                                stopGeneration();
                            } else if (messageInput.value.trim() && typeof sendMessage === 'function') {
                                sendMessage();
                            }
                        }
                    } catch (error) {
                        console.error('Message input error:', error);
                    }
                });
                messageInput.setAttribute('data-initialized', 'true');
            }

            if (bottomMessageInput && !bottomMessageInput.hasAttribute('data-initialized')) {
                bottomMessageInput.addEventListener('keydown', function(e) {
                    try {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            if (window.isGenerating && typeof stopGeneration === 'function') {
                                stopGeneration();
                            } else if (bottomMessageInput.value.trim() && typeof sendMessageFromBottom === 'function') {
                                sendMessageFromBottom();
                            }
                        }
                    } catch (error) {
                        console.error('Bottom message input error:', error);
                    }
                });
                bottomMessageInput.setAttribute('data-initialized', 'true');
            }

            // Initialize auto-resize handlers
            if (messageInput) {
                messageInput.addEventListener('input', autoResizeTextarea);
            }
            if (bottomMessageInput) {
                bottomMessageInput.addEventListener('input', autoResizeTextarea);
            }

            // Initialize provider selector
            if (typeof initializeNewProviderSelector === 'function') {
                initializeNewProviderSelector();
            }

            initializationComplete = true;
            console.log('App initialization completed successfully');

            // Load settings
            if (typeof loadSettings === 'function') {
                loadSettings();
            }

        } catch (error) {
            console.error('Error in app initialization:', error);
            if (retryCount < maxRetries) {
                retryCount++;
                setTimeout(initializeApp, 500);
            }
        }
    }

    // Multiple initialization triggers with proper sequencing
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸ“ DOM Content Loaded');
            initializeApp();
        });
    } else {
        console.log('ðŸ“ DOM Already Ready');
        initializeApp();
    }

    window.addEventListener('load', function() {
        console.log('ðŸ“ Window Loaded');
        if (!initializationComplete) {
            initializeApp();
        }
        // Initialize button handlers after everything is loaded
        setTimeout(function() {
            if (typeof initializeButtonHandlers === 'function') {
                initializeButtonHandlers();
            }
        }, 500);
    });

    // Global error handler
    window.addEventListener('error', function(e) {
        console.error('Global error caught:', e.error);
        return true; // Prevent default browser error handling
    });

    window.addEventListener('unhandledrejection', function(e) {
        console.error('Unhandled promise rejection:', e.reason);
        e.preventDefault();
    });
    </script>

    <script>
        let conversation = [];
        let isGenerating = false;
        let currentController = null;

        // Auto-resize textarea function
        function autoResizeTextarea() {
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('newSendButton');
            const bottomMessageInput = document.getElementById('bottomMessageInput');
            const bottomSendButton = document.getElementById('newBottomSendButton');

            if (messageInput && sendButton) {
                try {
                    messageInput.style.height = 'auto';
                    messageInput.style.height = Math.min(messageInput.scrollHeight, 120) + 'px';

                    const hasContent = messageInput.value.trim().length > 0;
                    sendButton.disabled = !hasContent && !isGenerating;

                    // Update button appearance based on state
                    updateSendButtonState(sendButton, hasContent);
                } catch (error) {
                    console.error('Error in messageInput resize:', error);
                }
            }

            if (bottomMessageInput && bottomSendButton) {
                try {
                    bottomMessageInput.style.height = 'auto';
                    bottomMessageInput.style.height = Math.min(bottomMessageInput.scrollHeight, 120) + 'px';

                    const hasContent = bottomMessageInput.value.trim().length > 0;
                    bottomSendButton.disabled = !hasContent && !isGenerating;

                    // Update button appearance based on state
                    updateSendButtonState(bottomSendButton, hasContent);
                } catch (error) {
                    console.error('Error in bottomMessageInput resize:', error);
                }
            }

            // Refresh all button states after resize
            updateAllSendButtons();
        }

        // Update send button appearance based on generation state
        function updateSendButtonState(button, hasContent) {
            if (isGenerating) {
                button.innerHTML = 'â¹';
                button.style.background = '#ef4444';
                button.title = 'Stop Generation';
                button.disabled = false;
                button.onclick = stopGeneration;
            } else if (hasContent) {
                button.innerHTML = 'â†‘';
                button.style.background = 'var(--accent-color)';
                button.title = 'Send Message';
                button.disabled = false;
                // Restore original onclick based on button ID
                if (button.id === 'newBottomSendButton') {
                    button.onclick = sendMessageFromBottom;
                } else {
                    button.onclick = sendMessage;
                }
            } else {
                button.innerHTML = 'â†‘';
                button.style.background = 'var(--border-color)';
                button.title = 'Send Message';
                button.disabled = true;
                // Keep original onclick for when content is added
                if (button.id === 'bottomSendButton') {
                    button.onclick = sendMessageFromBottom;
                } else {
                    button.onclick = sendMessage;
                }
            }
        }

        // File attachment handler
        function handleAttachment() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.multiple = true;
            fileInput.accept = 'image/*,text/*,.pdf,.doc,.docx';

            fileInput.onchange = function(event) {
                const files = event.target.files;
                if (files.length > 0) {
                    console.log('Files selected:', files.length);
                    // Process files here
                    for (let i = 0; i < files.length; i++) {
                        console.log('File:', files[i].name, 'Size:', files[i].size);
                    }
                    showToast(`${files.length} file(s) selected`, 'success');
                }
            };

            fileInput.click();
        }

        // Global voice state management
        let currentRecognition = null;
        let currentSpeechButton = null;
        let isRecording = false;

        // Voice dictation handler with toggle functionality
        function handleDictate() {
            // If already recording, stop it
            if (isRecording && currentRecognition) {
                stopVoiceRecognition();
                return;
            }

            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showToast('Speech recognition not supported in this browser', 'error');
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();

            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            const messageInput = document.getElementById('messageInput');
            const bottomMessageInput = document.getElementById('bottomMessageInput');
            const bottomInputArea = document.getElementById('bottomInputArea');
            const activeInput = (bottomInputArea && bottomInputArea.style.display !== 'none') ? bottomMessageInput : messageInput;

            currentRecognition = recognition;
            isRecording = true;

            // Update mic button appearance
            updateMicButtonState(true);

            recognition.onstart = function() {
                showToast('ðŸŽ¤ Listening... Click mic again to stop', 'success');
            };

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                if (activeInput) {
                    activeInput.value = transcript;
                    autoResizeTextarea();
                }
                showToast('Voice input captured', 'success');
                stopVoiceRecognition();
            };

            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                showToast('Voice recognition failed', 'error');
                stopVoiceRecognition();
            };

            recognition.onend = function() {
                stopVoiceRecognition();
            };

            recognition.start();
        }

        function stopVoiceRecognition() {
            if (currentRecognition) {
                currentRecognition.stop();
                currentRecognition = null;
            }
            isRecording = false;
            updateMicButtonState(false);
        }

        function updateMicButtonState(recording) {
            // Update all mic buttons
            const micButtons = document.querySelectorAll('button[title="Dictate"]');
            micButtons.forEach(btn => {
                if (recording) {
                    btn.innerHTML = 'â¹ï¸';
                    btn.style.background = '#ef4444';
                    btn.style.color = 'white';
                    btn.title = 'Stop Recording';
                } else {
                    btn.innerHTML = 'ðŸŽ¤';
                    btn.style.background = '';
                    btn.style.color = '';
                    btn.title = 'Dictate';
                }
            });
        }

        // Voice mode handler with toggle functionality
        function handleVoiceMode() {
            // If already in voice mode, stop it
            if (currentSpeechButton) {
                stopSpeechMode();
                return;
            }

            currentSpeechButton = event.target;
            showToast('ðŸ—£ï¸ Voice mode activated - speak your message', 'success');

            // Update speak button appearance
            updateSpeakButtonState(true);
            handleDictate();
        }

        function stopSpeechMode() {
            if (currentRecognition) {
                stopVoiceRecognition();
            }
            updateSpeakButtonState(false);
            currentSpeechButton = null;
        }

        function updateSpeakButtonState(active) {
            const speakButtons = document.querySelectorAll('button[title*="Voice Mode"]');
            speakButtons.forEach(btn => {
                if (active) {
                    btn.innerHTML = 'â¹ï¸';
                    btn.style.background = '#ef4444';
                    btn.style.color = 'white';
                    btn.title = 'Stop Voice Mode';
                } else {
                    btn.innerHTML = 'ðŸ—£ï¸';
                    btn.style.background = '';
                    btn.style.color = '';
                    btn.title = 'Voice Mode';
                }
            });
        }

        // Auto-capitalize first letter function
        function autoCapitalizeFirstLetter(input) {
            if (!input || !input.value) return;
            const value = input.value;
            if (value.length === 1) {
                const firstChar = value.charAt(0);
                if (firstChar >= 'a' && firstChar <= 'z') {
                    input.value = firstChar.toUpperCase();
                }
            }
        }

        // Function to show bottom input after first message
        function showBottomInput() {
            const bottomInputArea = document.getElementById('bottomInputArea');
            const chatArea = document.getElementById('chatArea');

            if (bottomInputArea) {
                // Adjust positioning based on sidebar visibility
                bottomInputArea.style.left = sidebarVisible ? '17.5%' : '0';
                bottomInputArea.style.display = 'flex';
                bottomInputArea.style.opacity = '0';
                bottomInputArea.style.transition = 'opacity 0.3s ease-in, left 0.3s ease';

                setTimeout(() => {
                    bottomInputArea.style.opacity = '1';
                }, 100);

                // Add padding to chat area to account for fixed input
                if (chatArea) {
                    chatArea.style.paddingBottom = '100px';
                }

                // Focus on bottom input
                const bottomMessageInput = document.getElementById('bottomMessageInput');
                if (bottomMessageInput) {
                    setTimeout(() => {
                        bottomMessageInput.focus();
                    }, 400);
                }
            }
        }

        // Function to send message from bottom input
        function sendMessageFromBottom() {
            // If AI is generating, stop it instead of sending
            if (isGenerating) {
                stopGeneration();
                return;
            }

            const bottomMessageInput = document.getElementById('bottomMessageInput');
            const messageInput = document.getElementById('messageInput');

            if (bottomMessageInput && messageInput) {
                // Copy message to main input and clear bottom input
                const message = bottomMessageInput.value.trim();
                if (!message) return;

                messageInput.value = message;
                bottomMessageInput.value = '';
                autoResizeTextarea();
                sendMessage();
            }
        }



        // DeepSeek configuration object
        const deepseekConfig = {
            chat: {
                route: '/api/deepseek-chat',
                model: 'deepseek-chat',
                temperature: 0.5,
                max_tokens: 2048
            },
            reasoner: {
                route: '/api/deepseek-reasoner',
                model: 'deepseek-reasoner',
                temperature: 0.2,
                max_tokens: 4096
            }
        };

        // Send message function with streaming and error handling
        async function sendMessage() {
            try {
                // If AI is generating, stop it instead of sending
                if (isGenerating) {
                    stopGeneration();
                    return;
                }

                const messageInput = document.getElementById('messageInput');
                const sendButton = document.getElementById('newSendButton');
                const loading = document.getElementById('loading');

                if (!messageInput) {
                    console.error('Message input not found');
                    return;
                }

                const message = messageInput.value.trim();
                if (!message) return;

            // Ensure a provider is selected
            if (!currentSelectedProvider) {
                currentSelectedProvider = 'deepseek-chat'; // Default fallback
                selectedProvider = currentSelectedProvider; // Keep compatibility
                updateNewProviderIcon();
            }

            // Hide input area immediately after first message
            const inputArea = document.getElementById('inputArea');
            const welcomeMessage = document.getElementById('welcomeMessage');
            const chatArea = document.getElementById('chatArea');

            if (inputArea && inputArea.classList.contains('centered')) {
                // Hide the input area immediately with fade out
                inputArea.style.transition = 'opacity 0.3s ease-out';
                inputArea.style.opacity = '0';

                setTimeout(() => {
                    inputArea.style.display = 'none';
                    inputArea.classList.remove('centered', 'sidebar-visible', 'sidebar-hidden');
                }, 300);

                if (chatArea) {
                    chatArea.classList.remove('with-centered-input');
                }

                if (welcomeMessage) {
                    welcomeMessage.classList.add('hidden');
                    setTimeout(() => {
                        welcomeMessage.style.display = 'none';
                    }, 400);
                }
            }

            addMessageToChat('user', message);
            messageInput.value = '';
            autoResizeTextarea();

            // Show bottom input after hiding the centered one
            setTimeout(() => {
                showBottomInput();
            }, 300);

            isGenerating = true;

            // Update all send buttons to stop mode
            updateAllSendButtons();

            // Send button now handles stop functionality
            if (loading) loading.style.display = 'none';

            const streamingElements = createStreamingMessage();
            currentController = new AbortController();

            // Get the appropriate endpoint and configuration
            let apiEndpoint, requestBody;

            if (currentSelectedProvider === 'mistral') {
                apiEndpoint = '/api/mistral-stream';
                requestBody = {
                    message: message,
                    conversation: conversation,
                    model: 'mistral-small-latest',
                    temperature: 0.5,
                    max_tokens: 2048
                };
            } else {
                // Determine mode based on selected provider
                const selectedMode = currentSelectedProvider === 'deepseek-reasoning' ? 'reasoner' : 'chat';
                const cfg = deepseekConfig[selectedMode];
                apiEndpoint = cfg.route;
                requestBody = {
                    message: message,
                    conversation: conversation,
                    model: cfg.model,
                    temperature: cfg.temperature,
                    max_tokens: cfg.max_tokens
                };
            }

            console.log('ðŸš€ Sending request to:', apiEndpoint, 'with provider:', currentSelectedProvider);

            try {
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody),
                    signal: currentController.signal
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('âŒ HTTP Error:', response.status, errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText || 'Server error'}`);
                }

                console.log('âœ… Response received, starting to read stream...');

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let accumulatedContent = '';
                let chunkCount = 0;

                while (true) {
                    const { done, value } = await reader.read();

                    if (done) {
                        console.log('âœ… Stream completed, chunks received:', chunkCount, 'content length:', accumulatedContent.length);
                        break;
                    }

                    const chunk = decoder.decode(value, { stream: true });
                    if (chunk && chunk.trim()) {
                        chunkCount++;
                        accumulatedContent += chunk;
                        console.log('ðŸ“ Received chunk', chunkCount, '- length:', chunk.length, 'total:', accumulatedContent.length);
                        updateStreamingMessage(streamingElements, accumulatedContent);
                    }
                }

                if (accumulatedContent.trim()) {
                    finalizeStreamingMessage(streamingElements, accumulatedContent);
                    conversation.push({ user: message, assistant: accumulatedContent });
                } else {
                    updateStreamingMessage(streamingElements, 'No response received from the AI. Please try again.');
                    finalizeStreamingMessage(streamingElements, 'No response received from the AI. Please try again.');
                }

            } catch (error) {
                console.error('âŒ Fetch error:', error);
                console.error('âŒ Request details:', {
                    provider: currentSelectedProvider,
                    endpoint: cfg.route,
                    requestBody: requestBody
                });

                if (error.name === 'AbortError') {
                    updateStreamingMessage(streamingElements, 'Response generation was stopped.');
                    finalizeStreamingMessage(streamingElements, 'Response generation was stopped.');
                } else {
                    let errorMessage = `âŒ **Request Failed**\n\n**Provider:** ${currentSelectedProvider}\n**Endpoint:** ${cfg.route}\n**Error:** ${error.message}\n\n**Debug Info:**\n- Mode: ${selectedMode}\n- Model: ${cfg.model}\n- Time: ${new Date().toISOString()}\n\nPlease check your API configuration or try a different provider.`;
                    updateStreamingMessage(streamingElements, errorMessage);
                    finalizeStreamingMessage(streamingElements, errorMessage);
                }
            } finally {
                isGenerating = false;
                updateAllSendButtons();
                currentController = null;
                autoResizeTextarea();
            }
        } catch (outerError) {
            console.error('âŒ Critical error in sendMessage:', outerError);
            isGenerating = false;
            updateAllSendButtons();
            currentController = null;

            // Silent error handling - no user message displayed
        }
    }

        // Stop generation function
        function stopGeneration() {
            if (currentController && isGenerating) {
                currentController.abort();
                isGenerating = false;

                // Restore all send buttons to send mode
                updateAllSendButtons();

                const loading = document.getElementById('loading');
                if (loading) loading.style.display = 'none';

                // Find and completely remove the streaming message
                const existingMessage = document.querySelector('.message.assistant:last-child');
                if (existingMessage) {
                    const contentDiv = existingMessage.querySelector('.message-content');
                    const thinkingDiv = existingMessage.querySelector('.thinking-animation');

                    // Check if there's meaningful content
                    let hasContent = false;
                    if (contentDiv) {
                        // Get the current text content, excluding thinking animation
                        let currentHTML = contentDiv.innerHTML;

                        // Remove thinking animation HTML if present
                        if (thinkingDiv) {
                            const thinkingHTML = thinkingDiv.outerHTML;
                            currentHTML = currentHTML.replace(thinkingHTML, '');
                        }

                        // Clean up any remaining thinking-related content
                        currentHTML = currentHTML.replace(/<div[^>]*thinking-animation[^>]*>[\s\S]*?<\/div>/gi, '');
                        currentHTML = currentHTML.replace(/Thinking\s*<div[^>]*thinking-dots[^>]*>[\s\S]*?<\/div>/gi, '');

                        // Get plain text to check if there's meaningful content
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = currentHTML;
                        const plainText = (tempDiv.textContent || tempDiv.innerText || '').trim();

                        hasContent = plainText && plainText.length > 5 && !plainText.toLowerCase().includes('thinking');
                    }

                    // If there's no meaningful content or only thinking animation, remove the entire message
                    if (!hasContent) {
                        existingMessage.remove();
                    }
                }

                currentController = null;
                autoResizeTextarea();
            }
        }

        // Update all send buttons based on current state
        function updateAllSendButtons() {
            document.querySelectorAll('.send-button').forEach(button => {
                const linkedInput = button.id === 'newBottomSendButton'
                    ? document.getElementById('bottomMessageInput')
                    : document.getElementById('messageInput');

                const hasContent = linkedInput && linkedInput.value.trim().length > 0;
                updateSendButtonState(button, hasContent);
            });
        }

        // Create streaming message container with Genspark-style thinking animation
        function createStreamingMessage() {
            const mainChatArea = document.getElementById('chatArea');

            // Create the message container first
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            // Create thinking animation as part of the message content
            const thinkingDiv = document.createElement('div');
            thinkingDiv.className = 'thinking-animation';
            thinkingDiv.setAttribute('aria-live', 'polite');
            thinkingDiv.style.display = 'block';

            // Create the thinking content with animated dots
            thinkingDiv.innerHTML = `
                <div class="thinking-text">
                    <span>Thinking</span>
                    <div class="thinking-dots">
                        <div class="thinking-dot"></div>
                        <div class="thinking-dot"></div>
                        <div class="thinking-dot"></div>
                    </div>
                </div>
            `;

            contentDiv.appendChild(thinkingDiv);
            messageDiv.appendChild(contentDiv);
            mainChatArea.appendChild(messageDiv);

            // Only auto-scroll if user is already at or near the bottom (within 100px)
            const isNearBottom = (mainChatArea.scrollTop + mainChatArea.clientHeight) >= (mainChatArea.scrollHeight - 100);
            if (isNearBottom) {
                mainChatArea.scrollTop = mainChatArea.scrollHeight;
            }

            return { messageDiv, thinkingDiv, contentDiv };
        }

        // Update streaming message content
        function updateStreamingMessage(elements, content) {
            const mainChatArea = document.getElementById('chatArea');

            // Check if user is near bottom BEFORE updating content
            const isNearBottom = (mainChatArea.scrollTop + mainChatArea.clientHeight) >= (mainChatArea.scrollHeight - 100);

            // If this is the first content, replace thinking with actual response
            if (content.trim() && elements.thinkingDiv && elements.thinkingDiv.style.display !== 'none') {
                console.log('ðŸ”„ Hiding thinking animation, showing content');
                elements.thinkingDiv.style.display = 'none';
            }

            // Update content if we have content
            if (elements.contentDiv && content.trim()) {
                console.log('ðŸ“ Updating message content:', content.substring(0, 100) + '...');
                const formattedContent = formatMessage(content);
                elements.contentDiv.innerHTML = formattedContent;
            }

            // Ensure the message is visible
            if (elements.messageDiv) {
                elements.messageDiv.style.display = 'block';
                elements.messageDiv.style.opacity = '1';
            }

            // Only auto-scroll if user was already near the bottom before content update
            if (isNearBottom) {
                mainChatArea.scrollTop = mainChatArea.scrollHeight;
            }
        }

        // Finalize streaming message
        function finalizeStreamingMessage(elements, content) {
            // Hide any remaining thinking animation
            if (elements.thinkingDiv) {
                elements.thinkingDiv.style.display = 'none';
            }

            // Update final content
            if (elements.contentDiv) {
                elements.contentDiv.innerHTML = formatMessage(content);
            }

            // Add click area and popup for AI messages (persistent like user messages)
            const hoverArea = document.createElement('div');
            hoverArea.className = 'ai-message-hover-area';

            const actionsPopup = document.createElement('div');
            actionsPopup.className = 'message-actions-popup';
            actionsPopup.innerHTML = `
                <button class="popup-action" onclick="editMessage(this)">
                    <span class="popup-action-icon">âœï¸</span>
                    <span class="popup-action-text">Edit</span>
                </button>
                <button class="popup-action" onclick="deleteMessage(this)">
                    <span class="popup-action-icon">ðŸ—‘ï¸</span>
                    <span class="popup-action-text">Delete</span>
                </button>
                <button class="popup-action" onclick="copyMessage(this)">
                    <span class="popup-action-icon">ðŸ“‹</span>
                    <span class="popup-action-text">Copy</span>
                </button>
                <button class="popup-action" onclick="saveAsPDF(this)">
                    <span class="popup-action-icon">ðŸ“„</span>
                    <span class="popup-action-text">Save as PDF</span>
                </button>
                <button class="popup-action" onclick="summarizeMessage(this)">
                    <span class="popup-action-icon">ðŸ“</span>
                    <span class="popup-action-text">Summarise</span>
                </button>
                <button class="popup-action" onclick="showVisualizationMenu(this)">
                    <span class="popup-action-icon">ðŸ“Š</span>
                    <span class="popup-action-text">Create Visual</span>
                    <span class="popup-action-arrow">â–¶</span>
                </button>
                <button class="popup-action" onclick="translateMessage(this)">
                    <span class="popup-action-icon">ðŸŒ</span>
                    <span class="popup-action-text">Translate</span>
                </button>
                <button class="popup-action" onclick="readAloud(this)">
                    <span class="popup-action-icon">ðŸ”Š</span>
                    <span class="popup-action-text">Read aloud</span>
                </button>
                <button class="popup-action" onclick="speakToAI(this)">
                    <span class="popup-action-icon">ðŸŽ¤</span>
                    <span class="popup-action-text">Speak to AI</span>
                </button>
            `;

            // Add click handler to AI message to show popup (like user messages)
            elements.messageDiv.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleAIMessageActions(e, elements.messageDiv, actionsPopup);
            });

            elements.messageDiv.appendChild(hoverArea);
            elements.messageDiv.appendChild(actionsPopup);
        }

        // Add message to chat area
        function addMessageToChat(sender, content) {
            const mainChatArea = document.getElementById('chatArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            if (sender === 'assistant') {
                // Use the new AI message format with toolbar
                const aiMessageElement = createAiMessage(content);
                if (aiMessageElement && aiMessageElement.length > 0) {
                    mainChatArea.appendChild(aiMessageElement[0]);
                } else {
                    // Fallback to original format with hover area only
                    contentDiv.innerHTML = formatMessage(content);
                    messageDiv.appendChild(contentDiv);

                    // Add click area and popup for assistant messages (persistent like user messages)
                    const hoverArea = document.createElement('div');
                    hoverArea.className = 'ai-message-hover-area';

                    const actionsPopup = document.createElement('div');
                    actionsPopup.className = 'message-actions-popup';
                    actionsPopup.innerHTML = `
                        <button class="popup-action" onclick="editMessage(this)">
                            <span class="popup-action-icon">âœï¸</span>
                            <span class="popup-action-text">Edit</span>
                        </button>
                        <button class="popup-action" onclick="deleteMessage(this)">
                            <span class="popup-action-icon">ðŸ—‘ï¸</span>
                            <span class="popup-action-text">Delete</span>
                        </button>
                        <button class="popup-action" onclick="copyMessage(this)">
                            <span class="popup-action-icon">ðŸ“‹</span>
                            <span class="popup-action-text">Copy</span>
                        </button>
                        <button class="popup-action" onclick="saveAsPDF(this)">
                            <span class="popup-action-icon">ðŸ“„</span>
                            <span class="popup-action-text">Save as PDF</span>
                        </button>
                        <button class="popup-action" onclick="summarizeMessage(this)">
                            <span class="popup-action-icon">ðŸ“</span>
                            <span class="popup-action-text">Summarise</span>
                        </button>
                        <button class="popup-action" onclick="showVisualizationMenu(this)">
                            <span class="popup-action-icon">ðŸ“Š</span>
                            <span class="popup-action-text">Create Visual</span>
                            <span class="popup-action-arrow">â–¶</span>
                        </button>
                        <button class="popup-action" onclick="translateMessage(this)">
                            <span class="popup-action-icon">ðŸŒ</span>
                            <span class="popup-action-text">Translate</span>
                        </button>
                        <button class="popup-action" onclick="readAloud(this)">
                            <span class="popup-action-icon">ðŸ”Š</span>
                            <span class="popup-action-text">Read aloud</span>
                        </button>
                        <button class="popup-action" onclick="speakToAI(this)">
                            <span class="popup-action-icon">ðŸŽ¤</span>
                            <span class="popup-action-text">Speak to AI</span>
                        </button>
                    `;

                    // Add click handler to AI message to show popup (like user messages)
                    messageDiv.addEventListener('click', (e) => {
                        e.stopPropagation();
                        toggleAIMessageActions(e, messageDiv, actionsPopup);
                    });

                    messageDiv.appendChild(hoverArea);
                    messageDiv.appendChild(actionsPopup);
                    mainChatArea.appendChild(messageDiv);
                }
            } else {
                contentDiv.textContent = content;

                // Add popup for user messages (shown on click)
                const userActionsPopup = document.createElement('div');
                userActionsPopup.className = 'user-message-actions-popup';
                userActionsPopup.innerHTML = `
                    <button class="popup-action" onclick="deleteUserMessage(this)">
                        <span class="popup-action-icon">ðŸ—‘ï¸</span>
                        <span class="popup-action-text">Delete</span>
                    </button>
                    <button class="popup-action" onclick="copyUserMessage(this)">
                        <span class="popup-action-icon">ðŸ“‹</span>
                        <span class="popup-action-text">Copy</span>
                    </button>
                    <button class="popup-action" onclick="editUserMessage(this)">
                        <span class="popup-action-icon">âœï¸</span>
                        <span class="popup-action-text">Edit</span>
                    </button>
                `;

                // Add click handler to user message to show popup
                messageDiv.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleUserMessageActions(e, messageDiv, userActionsPopup);
                });

                messageDiv.appendChild(userActionsPopup);
                messageDiv.appendChild(contentDiv);
                mainChatArea.appendChild(messageDiv);
            }

            // Only auto-scroll if user is already at or near the bottom (within 100px)
            if (mainChatArea.lastElementChild) {
                const isNearBottom = (mainChatArea.scrollTop + mainChatArea.clientHeight) >= (mainChatArea.scrollHeight - 100);
                if (isNearBottom) {
                    mainChatArea.scrollTop = mainChatArea.scrollHeight;
                }
            }
        }

        // Enhanced Tabulator table creation function
        function createEnhancedDataTable(tableData, containerId) {
            if (!window.Tabulator) {
                console.error('Tabulator not loaded');
                return;
            }

            const container = document.getElementById(containerId);
            if (!container) {
                console.error('Container not found:', containerId);
                return;
            }

            // Ensure we have valid data
            if (!Array.isArray(tableData) || tableData.length === 0) {
                container.innerHTML = '<p>No data available for table</p>';
                return;
            }

            const tableId = 'table-' + Math.random().toString(36).substr(2, 9);

            // Get column definitions from first row
            const columns = Object.keys(tableData[0]).map(key => ({
                title: key,
                field: key,
                sorter: "string",
                headerFilter: "input",
                responsive: 0,
                resizable: true
            }));

            // Create enhanced table HTML
            let tableHtml = `
                <div class="datatable-container" style="margin: 20px 0; padding: 20px; background: var(--assistant-bg); border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div class="datatable-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="margin: 0; color: var(--text-primary);">ðŸ“Š Interactive Data Table</h4>
                        <div class="datatable-controls" style="display: flex; gap: 10px;">
                            <button onclick="convertTableToChart('${tableId}')" class="btn btn-sm" style="background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px;">ðŸ“Š Convert to Chart</button>
                            <button onclick="exportTableData('${tableId}')" class="btn btn-sm" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px;">ðŸ’¾ Export CSV</button>
                        </div>
                    </div>
                    <div id="${tableId}" style="border: 1px solid var(--border-color); border-radius: 8px;"></div>
                </div>
            `;

            container.innerHTML = tableHtml;

            // Initialize Tabulator with enhanced features
            setTimeout(() => {
                new Tabulator("#" + tableId, {
                    data: tableData,
                    columns: columns,
                    layout: "fitColumns",
                    responsiveLayout: "hide",
                    pagination: "local",
                    paginationSize: 10,
                    paginationSizeSelector: [5, 10, 25, 50, 100],
                    movableColumns: true,
                    resizableRows: true,
                    headerSort: true,
                    headerFilter: true,
                    downloadConfig: {
                        columnHeaders: true,
                        columnGroups: false,
                        rowGroups: false,
                        columnCalcs: false,
                        dataTree: false,
                    },
                    downloadRowRange: "all",
                    placeholder: "No data available",
                    tooltips: true,
                    history: true,
                    addRowPos: "top",
                    index: "id",
                    selectable: true,
                    columnHeaderVertAlign: "middle",
                    columnHeaderSortMulti: true,
                    headerFilterPlaceholder: "Filter...",
                    theme: "simple"
                });
            }, 100);

            return tableId;
        }

        // Create medical reference tables with enhanced borders and styling
        function createMedicalReferenceTable(tableData, title, containerId) {
            if (!window.Tabulator) {
                console.error('Tabulator not loaded');
                return;
            }

            const container = document.getElementById(containerId) || document.createElement('div');
            if (!containerId) {
                document.body.appendChild(container);
            }

            // Ensure we have valid data
            if (!Array.isArray(tableData) || tableData.length === 0) {
                container.innerHTML = '<p>No data available for table</p>';
                return;
            }

            const tableId = 'medical-table-' + Math.random().toString(36).substr(2, 9);

            // Get column definitions from first row with medical styling
            const columns = Object.keys(tableData[0]).map((key, index) => ({
                title: key,
                field: key,
                sorter: "string",
                headerFilter: index === 0 ? false : "input", // No filter on first column (usually categories)
                responsive: 0,
                resizable: true,
                width: index === 0 ? 200 : undefined, // First column wider for categories
                formatter: index === 0 ? "textarea" : "html" // Format first column as textarea for better readability
            }));

            // Create enhanced medical table HTML
            let tableHtml = `
                <div class="medical-table-container" style="
                    margin: 20px 0; 
                    padding: 20px; 
                    background: var(--assistant-bg); 
                    border-radius: 12px; 
                    border: 2px solid var(--accent-color); 
                    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
                ">
                    <div class="medical-table-header" style="
                        display: flex; 
                        justify-content: space-between; 
                        align-items: center; 
                        margin-bottom: 20px;
                        padding-bottom: 15px;
                        border-bottom: 2px solid var(--border-color);
                    ">
                        <h3 style="
                            margin: 0; 
                            color: var(--text-primary);
                            font-size: 18px;
                            font-weight: 700;
                            display: flex;
                            align-items: center;
                            gap: 10px;
                        ">ðŸ¥ ${title}</h3>
                        <div class="medical-table-controls" style="display: flex; gap: 10px;">
                            <button onclick="printMedicalTable('${tableId}')" class="btn btn-sm" style="
                                background: linear-gradient(135deg, #8b5cf6, #7c3aed); 
                                color: white; 
                                border: none; 
                                padding: 8px 16px; 
                                border-radius: 8px; 
                                font-size: 12px;
                                font-weight: 600;
                            ">ðŸ–¨ï¸ Print</button>
                            <button onclick="exportMedicalTable('${tableId}')" class="btn btn-sm" style="
                                background: linear-gradient(135deg, #3b82f6, #1d4ed8); 
                                color: white; 
                                border: none; 
                                padding: 8px 16px; 
                                border-radius: 8px; 
                                font-size: 12px;
                                font-weight: 600;
                            ">ðŸ’¾ Export PDF</button>
                        </div>
                    </div>
                    <div id="${tableId}" style="
                        border: 2px solid var(--border-color); 
                        border-radius: 8px;
                        box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
                    "></div>
                </div>
            `;

            container.innerHTML = tableHtml;

            // Initialize Tabulator with medical-specific styling
            setTimeout(() => {
                new Tabulator("#" + tableId, {
                    data: tableData,
                    columns: columns,
                    layout: "fitDataFill",
                    responsiveLayout: "collapse",
                    pagination: false, // Medical tables should show all data
                    movableColumns: false, // Keep medical data in order
                    resizableRows: true,
                    headerSort: false, // Medical tables shouldn't be sorted
                    headerFilter: false, // No filtering for medical reference
                    placeholder: "No medical data available",
                    tooltips: true,
                    selectable: false, // Read-only medical reference
                    columnHeaderVertAlign: "middle",
                    rowHeight: 40, // Taller rows for medical content
                    theme: "simple"
                });
            }, 100);

            return tableId;
        }

        // Print medical table function
        function printMedicalTable(tableId) {
            const tabulatorTable = Tabulator.findTable("#" + tableId);
            if (tabulatorTable && tabulatorTable.length > 0) {
                tabulatorTable[0].print(false, true);
            }
        }

        // Export medical table as PDF
        function exportMedicalTable(tableId) {
            const tabulatorTable = Tabulator.findTable("#" + tableId);
            if (tabulatorTable && tabulatorTable.length > 0) {
                tabulatorTable[0].download("pdf", "medical-reference-table.pdf", {
                    orientation: "landscape",
                    title: "Medical Reference Table"
                });
            }
        }

        // Convert DataTable to Chart.js visualization
        function convertTableToChart(tableId) {
            if (!window.Chart) {
                console.error('Chart.js not loaded');
                return;
            }

            const table = document.getElementById(tableId);
            if (!table) return;

            const rows = table.querySelectorAll('tbody tr');
            const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent);

            const data = Array.from(rows).map(row => {
                return Array.from(row.querySelectorAll('td')).map(td => td.textContent);
            });

            // Create chart container
            const chartId = 'chart-' + Math.random().toString(36).substr(2, 9);
            const chartContainer = document.createElement('div');
            chartContainer.className = 'chart-container';
            chartContainer.style.cssText = 'margin: 20px 0; padding: 20px; background: var(--assistant-bg); border-radius: 12px; border: 1px solid var(--border-color);';
            chartContainer.innerHTML = `
                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px;">
                    <h4 style="margin: 0; color: var(--text-primary);">ðŸ“ˆ Chart Visualization</h4>
                    <button onclick="downloadChart('${chartId}')" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px;">ðŸ’¾ Download PNG</button>
                </div>
                <canvas id="${chartId}" width="400" height="200"></canvas>
            `;

            table.parentElement.parentElement.insertAdjacentElement('afterend', chartContainer);

            // Create chart with sample data
            setTimeout(() => {
                const ctx = document.getElementById(chartId).getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.map((row, index) => `Row ${index + 1}`),
                        datasets: [{
                            label: headers[1] || 'Data',
                            data: data.map(row => parseFloat(row[1]) || Math.random() * 100),
                            backgroundColor: 'rgba(59, 130, 246, 0.8)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Data Visualization from Table'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }, 100);
        }

        // Export table data as CSV
        function exportTableData(tableId) {
            // Check if this is a Tabulator table
            const tabulatorTable = Tabulator.findTable("#" + tableId);
            if (tabulatorTable && tabulatorTable.length > 0) {
                // Use Tabulator's built-in download functionality
                tabulatorTable[0].download("csv", "table-data.csv");
                return;
            }

            // Fallback for regular tables
            const table = document.getElementById(tableId);
            if (!table) return;

            const rows = table.querySelectorAll('tr');
            let csv = '';

            rows.forEach(row => {
                const cols = row.querySelectorAll('td, th');
                const rowData = Array.from(cols).map(col => `"${col.textContent}"`).join(',');
                csv += rowData + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'table-data.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Download chart as PNG
        function downloadChart(chartId) {
            const canvas = document.getElementById(chartId);
            if (!canvas) return;

            const link = document.createElement('a');
            link.download = 'chart.png';
            link.href = canvas.toDataURL();
            link.click();
        }

        // Format assistant messages with Marked.js, DOMPurify, and enhanced visualizations
        function formatMessage(text) {
            // Clean up citations and references first
            const cleanedText = text
                .replace(/\[\d+(?:,\s*\d+)*\]/g, '')
                .replace(/\[[^\]]*\]\([^)]*\)/g, '')
                .replace(/https?:\/\/[^\s]+/g, '')
                .replace(/(?:^|\n)Sources?:.*$/gim, '')
                .replace(/(?:^|\n)References?:.*$/gim, '')
                .replace(/\([^)]*\d{4}[^)]*\)/g, '')
                .replace(/[ \t]+/g, ' ')
                .replace(/\n[ \t]+/g, '\n')
                .trim();

            try {
                // Use Marked.js to parse markdown and DOMPurify to sanitize
                if (typeof marked !== 'undefined' && typeof DOMPurify !== 'undefined') {
                    let rawHtml = marked.parse(cleanedText);

                    // Process DataTables
                    rawHtml = rawHtml.replace(/```datatable\n([\s\S]*?)\n```/g, (match, tableData) => {
                        const containerId = 'datatable-' + Math.random().toString(36).substr(2, 9);
                        setTimeout(() => {
                            try {
                                const data = JSON.parse(tableData);
                                createEnhancedDataTable(data, containerId);
                            } catch (error) {
                                console.error('DataTable creation error:', error);
                                document.getElementById(containerId).innerHTML = `<pre><code>${tableData}</code></pre>`;
                            }
                        }, 100);
                        return `<div id="${containerId}"></div>`;
                    });

                    // Process Mermaid diagrams
                    rawHtml = rawHtml.replace(/```mermaid\n([\s\S]*?)\n```/g, (match, diagram) => {
                        const diagramId = 'mermaid-' + Math.random().toString(36).substr(2, 9);
                        setTimeout(() => {
                            const element = document.getElementById(diagramId);
                            if (element && typeof mermaid !== 'undefined') {
                                try {
                                    mermaid.render(diagramId + '-svg', diagram, (svgCode) => {
                                        element.innerHTML = svgCode;
                                    });
                                } catch (error) {
                                    console.error('Mermaid rendering error:', error);
                                    element.innerHTML = `<pre><code>${diagram}</code></pre>`;
                                }
                            }
                        }, 100);
                        return `<div class="mermaid" id="${diagramId}">${diagram}</div>`;
                    });

                    // Process Chart.js configurations
                    rawHtml = rawHtml.replace(/```chart\n([\s\S]*?)\n```/g, (match, chartConfig) => {
                        const chartId = 'chart-' + Math.random().toString(36).substr(2, 9);
                        setTimeout(() => {
                            const canvas = document.getElementById(chartId);
                            if (canvas && typeof Chart !== 'undefined') {
                                try {
                                    const config = JSON.parse(chartConfig);
                                    const chart = new Chart(canvas, config);

                                    // Add download button
                                    const downloadBtn = document.createElement('button');
                                    downloadBtn.textContent = 'ðŸ’¾ Download Chart';
                                    downloadBtn.className = 'chart-download-btn';
                                    downloadBtn.style.cssText = 'position: absolute; top: 10px; right: 10px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;';
                                    downloadBtn.onclick = () => downloadChart(chartId);
                                    canvas.parentElement.style.position = 'relative';
                                    canvas.parentElement.appendChild(downloadBtn);
                                } catch (error) {
                                    console.error('Chart.js rendering error:', error);
                                    canvas.parentElement.innerHTML = `<pre><code>${chartConfig}</code></pre>`;
                                }
                            }
                        }, 100);
                        return `<div class="chart-container">
                            <canvas id="${chartId}" width="400" height="200"></canvas>
                        </div>`;
                    });

                    const sanitizedHtml = DOMPurify.sanitize(rawHtml);
                    return `<div class="custom-prose">${sanitizedHtml}</div>`;
                }
            } catch (error) {
                console.warn('Enhanced formatting not available, falling back to basic formatting:', error);
            }

            // Fallback to original formatting if libraries aren't loaded
            return cleanedText
                .replace(/###\s*([^#\n]+)/g, '<h3 style="font-weight: 600; margin: 16px 0 8px 0; color: #202123; font-size: 16px;">$1</h3>')
                .replace(/##\s*([^#\n]+)/g, '<h2 style="font-weight: 600; margin: 20px 0 10px 0; color: #202123; font-size: 18px;">$1</h2>')
                .replace(/#\s*([^#\n]+)/g, '<h1 style="font-weight: 700; margin: 24px 0 12px 0; color: #202123; font-size: 20px;">$1</h1>')
                .replace(/\*\*([^*\n]+)\*\*/g, '<strong style="font-weight: 600; color: #202123;">$1</strong>')
                .replace(/\*([^*\n]+)\*/g, '<em style="font-style: italic; color: #353740;">$1</em>')
                .replace(/`([^`]+)`/g, '<code style="background: #f6f8fa; padding: 2px 6px; border-radius: 4px; font-family: monospace; color: #24292e;">$1</code>')
                .replace(/^(\d+)\.\s+(.+)$/gm, '<div style="margin: 8px 0; color: #202123; line-height: 1.6;"><strong style="font-weight: 600;">$1.</strong> $2</div>')
                .replace(/^[-*â€¢]\s+(.+)$/gm, '<div style="margin: 8px 0; padding-left: 16px; color: #202123; line-height: 1.6; position: relative;"><span style="position: absolute; left: 0;">â€¢</span>$1</div>')
                .replace(/\n\n+/g, '</p><p style="margin: 12px 0; line-height: 1.6; color: #202123;">')
                .replace(/^(.+)$/, '<p style="margin: 12px 0; line-height: 1.6; color: #202123;">$1</p>')
                .replace(/\n/g, '<br>');
        }

        // Sidebar toggle functionality
        let sidebarVisible = false;

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainArea = document.getElementById('mainArea');
            const toggleIcon = document.getElementById('toggleIcon');
            const inputArea = document.getElementById('inputArea');
            const welcomeMessage = document.getElementById('welcomeMessage');
            const bottomInputArea = document.getElementById('bottomInputArea');

            sidebarVisible = !sidebarVisible;

            if (sidebarVisible) {
                sidebar.classList.remove('hidden');
                mainArea.classList.remove('full-width');
                toggleIcon.textContent = 'â˜°';

                // Adjust bottom input area if visible
                if (bottomInputArea && bottomInputArea.style.display === 'flex') {
                    bottomInputArea.style.left = '17.5%';
                }

                if (inputArea && inputArea.classList.contains('centered')) {
                    inputArea.classList.remove('sidebar-hidden');
                    inputArea.classList.add('sidebar-visible');
                }

                if (welcomeMessage && welcomeMessage.classList.contains('centered')) {
                    welcomeMessage.style.transition = 'none';
                    welcomeMessage.classList.remove('sidebar-hidden');
                    welcomeMessage.classList.add('sidebar-visible');
                    setTimeout(() => {
                        welcomeMessage.style.transition = '';
                    }, 10);
                }
            } else {
                sidebar.classList.add('hidden');
                mainArea.classList.add('full-width');
                toggleIcon.textContent = 'â˜°';

                // Adjust bottom input area if visible
                if (bottomInputArea && bottomInputArea.style.display === 'flex') {
                    bottomInputArea.style.left = '0';
                }

                if (inputArea && inputArea.classList.contains('centered')) {
                    inputArea.classList.remove('sidebar-visible');
                    inputArea.classList.add('sidebar-hidden');
                }

                if (welcomeMessage && welcomeMessage.classList.contains('centered')) {
                    welcomeMessage.style.transition = 'none';
                    welcomeMessage.classList.remove('sidebar-visible');
                    welcomeMessage.classList.add('sidebar-hidden');
                    setTimeout(() => {
                        welcomeMessage.style.transition = '';
                    }, 10);
                }
            }
        }

        // Archive system
        let archivedChats = JSON.parse(localStorage.getItem('archivedChats') || '[]');

        function toggleArchivePopup() {
            const overlay = document.getElementById('archiveOverlay');
            const isVisible = overlay.classList.contains('show');

            if (isVisible) {
                overlay.classList.remove('show');
            } else {
                overlay.classList.add('show');
                loadArchivedChats();
            }
        }

        function loadArchivedChats() {
            const archiveList = document.getElementById('archivedChatsList');

            if (archivedChats.length === 0) {
                archiveList.innerHTML = '<div class="empty-archive">No archived chats</div>';
                return;
            }

            archiveList.innerHTML = archivedChats.map((chat, index) => `
                <div class="archived-chat-item">
                    <div class="archived-chat-title">${chat.title}</div>
                    <div class="archived-chat-date">${chat.dateArchived}</div>
                    <div class="archived-chat-actions">
                        <button class="archive-action-btn unarchive-btn" onclick="unarchiveChat(${index})" title="Unarchive">
                            â†©ï¸
                        </button>
                        <button class="archive-action-btn delete-archive-btn" onclick="deleteArchivedChat(${index})" title="Delete">
                            ðŸ—‘ï¸
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function unarchiveChat(index) {
            const chat = archivedChats[index];

            // Add back to main chat list
            const chatList = document.getElementById('chatList');
            const newChatId = Date.now();
            const newChatElement = document.createElement('div');
            newChatElement.className = 'chat-item';
            newChatElement.setAttribute('data-chat-id', newChatId);
            newChatElement.onclick = (event) => selectChat(newChatElement, event);

            newChatElement.innerHTML = `
                <div class="chat-content">
                    <span class="chat-title">${chat.title}</span>
                </div>
                <div class="chat-menu">
                    <button class="chat-menu-btn" onclick="toggleChatMenu(event, this)">â€¦</button>
                    <div class="chat-dropdown">
                        <button class="dropdown-item" onclick="renameChat(event, ${newChatId})">
                            <span class="dropdown-icon">âœï¸</span>
                            <span class="dropdown-text">Rename</span>
                        </button>
                        <button class="dropdown-item" onclick="archiveChat(event, ${newChatId})">
                            <span class="dropdown-icon">ðŸ“¦</span>
                            <span class="dropdown-text">Archive</span>
                        </button>
                        <button class="dropdown-item" onclick="deleteChat(event, ${newChatId})">
                            <span class="dropdown-icon">ðŸ—‘ï¸</span>
                            <span class="dropdown-text">Delete</span>
                        </button>
                    </div>
                </div>
            `;

            chatList.appendChild(newChatElement);

            // Remove from archived chats
            archivedChats.splice(index, 1);
            localStorage.setItem('archivedChats', JSON.stringify(archivedChats));

            // Refresh archive list
            loadArchivedChats();
        }

        function deleteArchivedChat(index) {
            if (confirm('Are you sure you want to permanently delete this archived chat?')) {
                archivedChats.splice(index, 1);
                localStorage.setItem('archivedChats', JSON.stringify(archivedChats));
                loadArchivedChats();
            }
        }

        // Sidebar functions
        function startNewChat() {
            const inputArea = document.getElementById('inputArea');
            const chatArea = document.getElementById('chatArea');
            const messageInput = document.getElementById('messageInput');

            if (chatArea) {
                chatArea.innerHTML = '<div class="welcome-message centered" id="welcomeMessage"><h3>Hi! How can I help you today?</h3></div>';

                const newWelcomeMessage = document.getElementById('welcomeMessage');
                if (newWelcomeMessage && newWelcomeMessage.classList.contains('centered')) {
                    newWelcomeMessage.style.transition = 'none';
                    newWelcomeMessage.classList.add(sidebarVisible ? 'sidebar-visible' : 'sidebar-hidden');
                    setTimeout(() => {
                        newWelcomeMessage.style.transition = '';
                    }, 10);
                }
            }
            conversation = [];

            if (inputArea) {
                inputArea.style.transition = 'none';
                inputArea.classList.add('centered');
                inputArea.classList.remove('sidebar-visible', 'sidebar-hidden');
                inputArea.classList.add(sidebarVisible ? 'sidebar-visible' : 'sidebar-hidden');

                if (chatArea) {
                    chatArea.classList.add('with-centered-input');
                }

                setTimeout(() => {
                    inputArea.style.transition = '';
                }, 10);
            }

            if (messageInput) {
                messageInput.value = '';
                autoResizeTextarea();
            }

            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
            });

            document.querySelectorAll('.chat-dropdown').forEach(dropdown => {
                dropdown.classList.remove('show');
            });
        }



        function selectChat(element, event) {
            if (event.target.closest('.chat-menu-btn')) return;

            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
            });
            element.classList.add('active');

            const chatName = element.querySelector('.chat-title').textContent;
            const mainChatArea = document.getElementById('chatArea');
            const inputArea = document.getElementById('inputArea');

            mainChatArea.innerHTML = `<div class="welcome-message"><h3>${chatName}</h3><p>This would load the conversation history for: ${chatName}</p></div>`;

            inputArea.classList.remove('centered');
            mainChatArea.classList.remove('with-centered-input');

            document.querySelectorAll('.chat-dropdown').forEach(dropdown => {
                dropdown.classList.remove('show');
            });
        }

        function toggleChatMenu(event, button) {
            event.stopPropagation();

            document.querySelectorAll('.chat-dropdown').forEach(dropdown => {
                if (dropdown !== button.nextElementSibling) {
                    dropdown.classList.remove('show');
                }
            });

            const dropdown = button.nextElementSibling;
            dropdown.classList.toggle('show');
        }

        // Modal system variables
        let currentModalAction = null;
        let currentModalData = null;

        function showModal(title, message, type, data = null) {
            const modalOverlay = document.getElementById('modalOverlay');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const modalInput = document.getElementById('modalInput');
            const modalConfirmBtn = document.getElementById('modalConfirmBtn');

            modalTitle.textContent = title;
            modalMessage.textContent = message;
            currentModalAction = type;
            currentModalData = data;

            // Configure modal based on type
            if (type === 'rename') {
                modalInput.style.display = 'block';
                modalInput.value = data.currentTitle;
                modalInput.focus();
                modalInput.select();
                modalConfirmBtn.textContent = 'Rename';
                modalConfirmBtn.className = 'modal-button primary';
            } else if (type === 'archive') {
                modalInput.style.display = 'none';
                modalConfirmBtn.textContent = 'Archive';
                modalConfirmBtn.className = 'modal-button primary';
            } else if (type === 'delete') {
                modalInput.style.display = 'none';
                modalConfirmBtn.textContent = 'Delete';
                modalConfirmBtn.className = 'modal-button danger';
            }

            modalOverlay.classList.add('show');

            // Handle Enter key for rename
            if (type === 'rename') {
                modalInput.addEventListener('keydown', handleModalEnter);
            }
        }

        function handleModalEnter(e) {
            if (e.key === 'Enter') {
                confirmModalAction();
            } else if (e.key === 'Escape') {
                closeModal();
            }
        }

        function closeModal() {
            const modalOverlay = document.getElementById('modalOverlay');
            const modalInput = document.getElementById('modalInput');

            modalOverlay.classList.remove('show');
            currentModalAction = null;
            currentModalData = null;

            modalInput.removeEventListener('keydown', handleModalEnter);
        }

        function confirmModalAction() {
            if (!currentModalAction || !currentModalData) return;

            // Close all dropdowns first
            document.querySelectorAll('.chat-dropdown').forEach(dropdown => {
                dropdown.classList.remove('show');
            });

            const { chatId, chatItem, titleElement } = currentModalData;

            if (currentModalAction === 'rename') {
                const modalInput = document.getElementById('modalInput');
                const newTitle = modalInput.value.trim();

                if (newTitle && newTitle !== titleElement.textContent) {
                    titleElement.textContent = newTitle;
                }
            } else if (currentModalAction === 'archive') {
                chatItem.style.opacity = '0.5';
                titleElement.textContent += ' (Archived)';
            } else if (currentModalAction === 'delete') {
                chatItem.remove();
            }

            closeModal();
        }

        function renameChat(event, chatId) {
            event.stopPropagation();
            const chatItem = document.querySelector(`[data-chat-id="${chatId}"]`);
            const titleElement = chatItem.querySelector('.chat-title');
            const currentTitle = titleElement.textContent;

            showModal(
                'Rename chat',
                'Choose a new name for your chat.',
                'rename',
                { chatId, chatItem, titleElement, currentTitle }
            );
        }

        function archiveChat(event, chatId) {
            event.stopPropagation();

            // Close dropdown first
            document.querySelectorAll('.chat-dropdown').forEach(dropdown => {
                dropdown.classList.remove('show');
            });

            const chatItem = document.querySelector(`[data-chat-id="${chatId}"]`);
            const titleElement = chatItem.querySelector('.chat-title');

            // Add to archived chats
            const archivedChat = {
                id: chatId,
                title: titleElement.textContent,
                dateArchived: new Date().toLocaleDateString(),
                conversation: [] // You can store conversation history here if needed
            };

            archivedChats.push(archivedChat);
            localStorage.setItem('archivedChats', JSON.stringify(archivedChats));

            // Remove from main chat list
            chatItem.remove();
        }

        function deleteChat(event, chatId) {
            event.stopPropagation();
            const chatItem = document.querySelector(`[data-chat-id="${chatId}"]`);
            const titleElement = chatItem.querySelector('.chat-title');

            showModal(
                'Delete chat',
                'This will permanently delete this chat.',
                'delete',
                { chatId, chatItem, titleElement }
            );
        }

        function searchChats() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const chatItems = document.querySelectorAll('.chat-item');

            chatItems.forEach(item => {
                const title = item.querySelector('.chat-title').textContent.toLowerCase();
                if (title.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Note: Toggle message actions function removed - now using hover behavior

        // Action button functions
        function keepChanges(btn) {
            const messageContainer = btn.closest('.message');
            const messageContent = messageContainer.querySelector('.message-content');

            // Add visual feedback
            const originalBorder = messageContainer.style.border;
            messageContainer.style.border = '2px solid #10b981';
            messageContainer.style.background = 'rgba(16, 185, 129, 0.1)';

            // Show success notification
            const notification = document.createElement('div');
            notification.innerHTML = `
                <div style="
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #10b981, #059669);
                    color: white;
                    padding: 12px 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
                    z-index: 10000;
                    font-weight: 500;
                    animation: slideInRight 0.3s ease-out;
                ">
                    âœ… Changes accepted and saved!
                </div>
            `;

            document.body.appendChild(notification);

            // Remove notification after 3 seconds
            setTimeout(() => {
                notification.remove();
                // Reset message styling
                messageContainer.style.border = originalBorder;
                messageContainer.style.background = '';
            }, 3000);

            // Save to localStorage for persistence
            const chatHistory = JSON.parse(localStorage.getItem('mavericPro_chatHistory') || '[]');
            const messageText = messageContent.textContent || messageContent.innerText || '';
            const timestamp = new Date().toISOString();

            chatHistory.push({
                type: 'accepted_change',
                content: messageText,
                timestamp: timestamp,
                id: Date.now()
            });

            localStorage.setItem('mavericPro_chatHistory', JSON.stringify(chatHistory));

            // Close popup
            btn.closest('.message-actions-popup').classList.remove('show');

            console.log('Changes accepted and saved:', messageText.substring(0, 150) + '...');
        }

        // Add the editMessage function for the popup with rich text editing
        function editMessage(btn) {
            const messageContainer = btn.closest('.message');
            const messageContent = messageContainer.querySelector('.message-content');

            if (messageContent.classList.contains('editing')) return;

            // Get the current HTML content
            const currentHtml = messageContent.innerHTML;

            // Store original HTML for cancel
            const originalHtml = messageContent.innerHTML;

            // Create rich text edit interface
            const editContainer = document.createElement('div');
            editContainer.className = 'message-edit-container';
            editContainer.innerHTML = `
                <div class="edit-toolbar">
                    <div class="toolbar-group">
                        <select class="toolbar-select" onchange="formatText('fontSize', this.value)" title="Font Size">
                            <option value="10px">10px</option>
                            <option value="12px">12px</option>
                            <option value="14px">14px</option>
                            <option value="16px" selected>16px</option>
                            <option value="18px">18px</option>
                            <option value="20px">20px</option>
                            <option value="24px">24px</option>
                            <option value="28px">28px</option>
                            <option value="32px">32px</option>
                        </select>
                        <select class="toolbar-select" onchange="formatText('fontName', this.value)" title="Font Family">
                            <option value="inherit">Default</option>
                            <option value="Arial, sans-serif">Arial</option>
                            <option value="Georgia, serif">Georgia</option>
                            <option value="'Times New Roman', serif">Times</option>
                            <option value="'Courier New', monospace">Courier</option>
                            <option value="Verdana, sans-serif">Verdana</option>
                            <option value="Helvetica, sans-serif">Helvetica</option>
                            <option value="'Comic Sans MS', cursive">Comic Sans</option>
                        </select>
                    </div>
                    <div class="toolbar-group">
                        <button type="button" class="toolbar-btn" onclick="formatText('bold')" title="Bold"><b>B</b></button>
                        <button type="button" class="toolbar-btn" onclick="formatText('italic')" title="Italic"><i>I</i></button>
                        <button type="button" class="toolbar-btn" onclick="formatText('underline')" title="Underline"><u>U</u></button>
                        <button type="button" class="toolbar-btn" onclick="formatText('strikeThrough')" title="Strikethrough"><s>S</s></button>
                    </div>
                    <div class="toolbar-group">
                        <button type="button" class="toolbar-btn" onclick="showTextColorPicker(event)" title="Text Color" id="textColorBtn">
                            <span style="color: #000; font-weight: bold;">A</span>
                        </button>
                        <button type="button" class="toolbar-btn" onclick="showHighlightColorPicker(event)" title="Highlight Color" id="highlightColorBtn">ðŸ–</button>
                    </div>
                    <div class="toolbar-group">
                        <button type="button" class="toolbar-btn" onclick="formatText('justifyLeft')" title="Align Left">â¬…</button>
                        <button type="button" class="toolbar-btn" onclick="formatText('justifyCenter')" title="Align Center">â¬›</button>
                        <button type="button" class="toolbar-btn" onclick="formatText('justifyRight')" title="Align Right">âž¡</button>
                        <button type="button" class="toolbar-btn" onclick="formatText('justifyFull')" title="Justify">â¬œ</button>
                    </div>
                    <div class="toolbar-group">
                        <button type="button" class="toolbar-btn" onclick="formatText('insertUnorderedList')" title="Bullet List">â€¢</button>
                        <button type="button" class="toolbar-btn" onclick="formatText('insertOrderedList')" title="Number List">1.</button>
                        <button type="button" class="toolbar-btn" onclick="formatText('outdent')" title="Decrease Indent">â¬…</button>
                        <button type="button" class="toolbar-btn" onclick="formatText('indent')" title="Increase Indent">âž¡</button>
                    </div>
                    <div class="toolbar-group">
                        <button type="button" class="toolbar-btn" onclick="formatText('removeFormat')" title="Clear Formatting">âŒ«</button>
                        <button type="button" class="toolbar-btn" onclick="formatText('undo')" title="Undo">â†¶</button>
                        <button type="button" class="toolbar-btn" onclick="formatText('redo')" title="Redo">â†·</button>
                    </div>
                </div>
                <div contenteditable="true" class="message-edit-area edit-area-with-toolbar" style="width:100%;min-height:150px;font-family:inherit;padding:12px;border:1px solid var(--border-color);border-radius:0 0 8px 8px;border-top:none;background-color:var(--assistant-bg);color:var(--text-primary);font-size:16px;line-height:1.6;resize:vertical;outline:none;">${currentHtml}</div>
                <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end;">
                    <button class="edit-save-btn" style="padding:6px 16px;background:var(--accent-color);color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;font-weight:500;">Save</button>
                    <button class="edit-cancel-btn" style="padding:6px 16px;background:var(--hover-bg);color:var(--text-primary);border:1px solid var(--border-color);border-radius:4px;cursor:pointer;font-size:12px;">Cancel</button>
                </div>
            `;

            // Replace content with edit interface
            messageContent.innerHTML = '';
            messageContent.appendChild(editContainer);
            messageContent.classList.add('editing');

            // Focus the contenteditable area
            const editArea = editContainer.querySelector('.message-edit-area');
            editArea.focus();

            // Save button functionality
            editContainer.querySelector('.edit-save-btn').onclick = function() {
                const editedHtml = editArea.innerHTML.trim();
                if (editedHtml) {
                    messageContent.innerHTML = editedHtml;
                } else {
                    messageContent.innerHTML = originalHtml;
                }
                messageContent.classList.remove('editing');
            };

            // Cancel button functionality
            editContainer.querySelector('.edit-cancel-btn').onclick = function() {
                messageContent.innerHTML = originalHtml;
                messageContent.classList.remove('editing');
            };

            // Close popup
            btn.closest('.message-actions-popup').classList.remove('show');
        }

        // Color picker functionality
        let currentColorPalette = null;

        function showTextColorPicker(event) {
            event.preventDefault();
            event.stopPropagation();

            const button = event.target.closest('.toolbar-btn');
            hideAllColorPickers();

            const palette = createColorPalette('text', 'Text Color');
            positionColorPalette(palette, button);
            currentColorPalette = palette;

            // Force show the palette
            palette.style.display = 'block';
            palette.classList.add('show');
        }

        function showHighlightColorPicker(event) {
            event.preventDefault();
            event.stopPropagation();

            const button = event.target.closest('.toolbar-btn');
            hideAllColorPickers();

            const palette = createColorPalette('highlight', 'Highlight Color');
            positionColorPalette(palette, button);
            currentColorPalette = palette;

            // Force show the palette
            palette.style.display = 'block';
            palette.classList.add('show');
        }

        function createColorPalette(type, title) {
            const palette = document.createElement('div');
            palette.className = 'color-palette show';
            palette.id = `${type}ColorPalette`;

            const textColors = [
                '#000000', '#333333', '#666666', '#999999', '#CCCCCC', '#FFFFFF', '#FF0000', '#00FF00',
                '#0000FF', '#FFFF00', '#FF00FF', '#00FFFF', '#800000', '#008000', '#000080', '#808000',
                '#800080', '#008080', '#C0C0C0', '#808080', '#FF4500', '#32CD32', '#1E90FF', '#FFD700',
                '#FF1493', '#00CED1', '#DC143C', '#228B22', '#4169E1', '#FFA500', '#9932CC', '#20B2AA'
            ];

            const highlightColors = [
                '#FFFF00', '#FFE135', '#FFCCCC', '#CCFFCC', '#CCCCFF', '#FFCC99', '#FF99CC', '#99CCFF',
                '#99FFCC', '#CCFF99', '#FFFF99', '#FFB3BA', '#BAFFC9', '#BAE1FF', '#FFFFBA', '#FFD1DC',
                '#E0E0E0', '#F0F8FF', '#FFF8DC', '#F5F5DC', '#FDF5E6', '#FFFACD', '#F0FFFF', '#F5FFFA'
            ];

            const colors = type === 'text' ? textColors : highlightColors;

            palette.innerHTML = `
                <div class="color-palette-header">
                    <div class="color-palette-title">${title}</div>
                    <button class="color-palette-close" onclick="hideAllColorPickers()">Ã—</button>
                </div>

                <div class="color-section">
                    <div class="color-section-title">${type === 'text' ? 'Text Colors' : 'Highlight Colors'}</div>
                    <div class="color-grid">
                        ${colors.map(color => `
                            <div class="color-option" 
                                 style="background-color: ${color}; ${color === '#FFFFFF' ? 'border: 1px solid #ddd;' : ''}" 
                                 onclick="applyColor('${type}', '${color}'); event.stopPropagation();" 
                                 onmousedown="event.preventDefault();"
                                 title="${color}">
                            </div>
                        `).join('')}
                    </div>
                </div>

                ${type === 'highlight' ? `
                <div class="color-section">
                    <div class="color-section-title">Remove Highlight</div>
                    <div class="color-grid">
                        <div class="color-option" 
                             style="background: linear-gradient(45deg, #ff0000 25%, transparent 25%), linear-gradient(-45deg, #ff0000 25%, transparent 25%); background-size: 4px 4px; border: 1px solid #ff0000;" 
                             onclick="removeHighlight()" 
                             title="Remove Highlight">
                            <span style="color: #ff0000; font-weight: bold; font-size: 12px;">Ã—</span>
                        </div>
                    </div>
                </div>
                ` : ''}

                <div class="color-section">
                    <div class="color-section-title">Custom Color</div>
                    <input type="text" 
                           class="custom-color-input" 
                           placeholder="#000000 or rgb(0,0,0)" 
                           onkeypress="handleCustomColorInput(event, '${type}')"
                           oninput="validateColorInput(this)">
                </div>
            `;

            document.body.appendChild(palette);
            return palette;
        }

        function positionColorPalette(palette, button) {
            const rect = button.getBoundingClientRect();
            const paletteWidth = 280;
            const paletteHeight = 400;

            let top = rect.bottom + 8;
            let left = rect.left;

            // Adjust if palette would go off screen
            if (left + paletteWidth > window.innerWidth) {
                left = rect.right - paletteWidth;
            }
            if (top + paletteHeight > window.innerHeight) {
                top = rect.top - paletteHeight - 8;
            }

            // Ensure palette stays on screen
            if (left < 0) left = 8;
            if (top < 0) top = 8;

            palette.style.position = 'fixed';
            palette.style.top = top + 'px';
            palette.style.left = left + 'px';
        }

        function applyColor(type, color) {
            const editArea = document.querySelector('.message-edit-area[contenteditable="true"]');
            if (!editArea) {
                console.log('No edit area found');
                hideAllColorPickers();
                return;
            }

            editArea.focus();

            const selection = window.getSelection();

            // Force enable style with CSS
            document.execCommand('styleWithCSS', false, true);

            if (type === 'text') {
                // Apply text color
                if (selection && selection.rangeCount > 0 && !selection.getRangeAt(0).collapsed) {
                    // Text is selected
                    document.execCommand('foreColor', false, color);
                    console.log('Applied text color:', color);
                } else {
                    // No selection - apply to future typing
                    document.execCommand('foreColor', false, color);
                    editArea.style.color = color;
                    console.log('Set text color for future typing:', color);
                }
            } else if (type === 'highlight') {
                // Apply highlight color
                if (selection && selection.rangeCount > 0 && !selection.getRangeAt(0).collapsed) {
                    // Text is selected
                    document.execCommand('hiliteColor', false, color);
                    document.execCommand('backColor', false, color);
                    console.log('Applied highlight color:', color);
                } else {
                    // No selection - apply to future typing
                    document.execCommand('hiliteColor', false, color);
                    document.execCommand('backColor', false, color);
                    console.log('Set highlight color for future typing:', color);
                }
            }

            // Visual feedback
            showToast(`${type} color applied: ${color}`, 'success');

            hideAllColorPickers();
            if (typeof updateToolbarStates === 'function') {
                updateToolbarStates();
            }
        }

        function removeHighlight() {
            const editArea = document.querySelector('.message-edit-area[contenteditable="true"]');
            if (!editArea) return;

            editArea.focus();

            const selection = window.getSelection();
            if (!selection || selection.rangeCount === 0) return;

            const range = selection.getRangeAt(0);

            if (!range.collapsed) {
                // Remove highlight from selected text
                try {
                    const selectedContent = range.extractContents();

                    // Remove any background-color styles from the selected content
                    const walker = document.createTreeWalker(
                        selectedContent,
                        NodeFilter.SHOW_ELEMENT,
                        null,
                        false
                    );

                    const elements = [];
                    let node;
                    while (node = walker.nextNode()) {
                        elements.push(node);
                    }

                    elements.forEach(el => {
                        if (el.style && el.style.backgroundColor) {
                            el.style.backgroundColor = '';
                            if (!el.style.cssText.trim()) {
                                // Remove the style attribute if it's empty
                                el.removeAttribute('style');
                            }
                        }
                    });

                    range.insertNode(selectedContent);

                    // Clear selection
                    selection.removeAllRanges();
                } catch (e) {
                    // Fallback using execCommand
                    document.execCommand('styleWithCSS', false, true);
                    document.execCommand('backColor', false, 'transparent');
                }
            } else {
                // Set no highlight for future typing
                document.execCommand('styleWithCSS', false, true);
                document.execCommand('backColor', false, 'transparent');
            }

            hideAllColorPickers();
        }

        function handleCustomColorInput(event, type) {
            if (event.key === 'Enter') {
                const color = event.target.value.trim();
                if (isValidColor(color)) {
                    applyColor(type, color);
                }
            }
        }

        function validateColorInput(input) {
            const color = input.value.trim();
            if (isValidColor(color)) {
                input.style.borderColor = 'var(--accent-color)';
            } else {
                input.style.borderColor = '#ff4444';
            }
        }

        function isValidColor(color) {
            if (!color) return false;

            // Check hex format
            if (/^#[0-9A-F]{6}$/i.test(color) || /^#[0-9A-F]{3}$/i.test(color)) {
                return true;
            }

            // Check rgb/rgba format
            if (/^rgb\(\s*\d+\s*,\s*\d+\s*,\s*\d+\s*\)$/i.test(color)) {
                return true;
            }

            if (/^rgba\(\s*\d+\s*,\s*\d+\s*,\s*\d+\s*,\s*[\d.]+\s*\)$/i.test(color)) {
                return true;
            }

            // Check named colors
            const namedColors = ['red', 'blue', 'green', 'yellow', 'orange', 'purple', 'pink', 'black', 'white', 'gray', 'grey'];
            return namedColors.includes(color.toLowerCase());
        }

        function hideAllColorPickers() {
            document.querySelectorAll('.color-palette').forEach(palette => {
                palette.remove();
            });
            currentColorPalette = null;
        }

        // Rich text formatting functions (updated)
        function formatText(command, value = null) {
            const editArea = document.querySelector('.message-edit-area[contenteditable="true"]');
            if (editArea) {
                editArea.focus();
            }

            if (command === 'fontSize') {
                document.execCommand('fontSize', false, '7');
                const fontElements = document.getElementsByTagName('font');
                for (let i = 0; i < fontElements.length; i++) {
                    if (fontElements[i].size === '7') {
                        fontElements[i].removeAttribute('size');
                        fontElements[i].style.fontSize = value;
                    }
                }
            } else if (command === 'fontName') {
                document.execCommand('fontName', false, value);
            } else if (command === 'removeFormat') {
                document.execCommand('removeFormat', false, null);
                document.execCommand('unlink', false, null);
            } else if (command === 'insertOrderedList') {
                // Special handling for ordered lists to ensure proper numbering
                document.execCommand('insertOrderedList', false, null);

                // Force proper list styling
                setTimeout(() => {
                    const lists = editArea.querySelectorAll('ol');
                    lists.forEach(list => {
                        list.style.listStyleType = 'decimal';
                        list.style.paddingLeft = '20px';
                        list.style.marginLeft = '0';

                        // Ensure list items have proper styling
                        const listItems = list.querySelectorAll('li');
                        listItems.forEach(item => {
                            item.style.display = 'list-item';
                            item.style.listStyleType = 'decimal';
                            item.style.listStylePosition = 'outside';
                        });
                    });
                }, 10);
            } else if (command === 'insertUnorderedList') {
                // Special handling for unordered lists
                document.execCommand('insertUnorderedList', false, null);

                // Force proper list styling
                setTimeout(() => {
                    const lists = editArea.querySelectorAll('ul');
                    lists.forEach(list => {
                        list.style.listStyleType = 'disc';
                        list.style.paddingLeft = '20px';
                        list.style.marginLeft = '0';

                        // Ensure list items have proper styling
                        const listItems = list.querySelectorAll('li');
                        listItems.forEach(item => {
                            item.style.display = 'list-item';
                            item.style.listStyleType = 'disc';
                            item.style.listStylePosition = 'outside';
                        });
                    });
                }, 10);
            } else {
                document.execCommand(command, false, value);
            }

            updateToolbarStates();
        }

        function updateToolbarStates() {
            // Update button active states based on current selection
            const buttons = document.querySelectorAll('.toolbar-btn');
            buttons.forEach(btn => {
                btn.classList.remove('active');
            });

            // Check which formatting is active at cursor position
            const commands = ['bold', 'italic', 'underline', 'strikeThrough'];
            commands.forEach(command => {
                if (document.queryCommandState(command)) {
                    const btn = document.querySelector(`.toolbar-btn[onclick*="${command}"]`);
                    if (btn) btn.classList.add('active');
                }
            });
        }

        // Toggle user message actions popup
        function toggleUserMessageActions(event, messageDiv, popup) {
            event.stopPropagation();

            // Close all other user message popups first
            document.querySelectorAll('.user-message-actions-popup').forEach(otherPopup => {
                if (otherPopup !== popup) {
                    otherPopup.classList.remove('show');
                }
            });

            // Close all AI message popups
            document.querySelectorAll('.message-actions-popup').forEach(otherPopup => {
                if (otherPopup !== popup) {
                    otherPopup.classList.remove('show');
                }
            });

            // Toggle current popup
            popup.classList.toggle('show');
        }

        // Toggle AI message actions popup (same behavior as user messages)
        function toggleAIMessageActions(event, messageDiv, popup) {
            event.stopPropagation();

            // Close all other AI message popups first
            document.querySelectorAll('.message-actions-popup').forEach(otherPopup => {
                if (otherPopup !== popup) {
                    otherPopup.classList.remove('show');
                }
            });

            // Close all user message popups
            document.querySelectorAll('.user-message-actions-popup').forEach(otherPopup => {
                if (otherPopup !== popup) {
                    otherPopup.classList.remove('show');
                }
            });

            // Toggle current popup
            popup.classList.toggle('show');
        }

        // Global click handler to close popups when clicking outside
        document.addEventListener('click', function(event) {
            // Close color pickers when clicking outside
            if (!event.target.closest('.color-palette') && 
                !event.target.closest('#textColorBtn') && 
                !event.target.closest('#highlightColorBtn')) {
                hideAllColorPickers();
            }

            // Close user message popups when clicking outside
            if (!event.target.closest('.message.user') && 
                !event.target.closest('.user-message-actions-popup')) {
                document.querySelectorAll('.user-message-actions-popup').forEach(popup => {
                    popup.classList.remove('show');
                });
            }

            // Close AI message popups when clicking outside
            if (!event.target.closest('.message.assistant') && 
                !event.target.closest('.message-actions-popup')) {
                document.querySelectorAll('.message-actions-popup').forEach(popup => {
                    popup.classList.remove('show');
                });
            }
        });

        function deleteMessage(btn) {
            const messageContainer = btn.closest('.message');
            if (messageContainer) {
                messageContainer.remove();
            }
            // Close popup
            btn.closest('.message-actions-popup').classList.remove('show');
        }

        // User message action functions
        function deleteUserMessage(btn) {
            const messageContainer = btn.closest('.message.user');
            if (messageContainer) {
                messageContainer.remove();
            }
            // Close popup
            btn.closest('.user-message-actions-popup').classList.remove('show');
        }

        function copyUserMessage(btn) {
            const messageContainer = btn.closest('.message.user');
            const messageContent = messageContainer.querySelector('.message-content');
            const text = messageContent.textContent || messageContent.innerText || '';

            navigator.clipboard.writeText(text.trim()).then(() => {
                // Visual feedback
                const originalText = btn.querySelector('.popup-action-text').textContent;
                btn.querySelector('.popup-action-text').textContent = 'Copied!';
                setTimeout(() => {
                    btn.querySelector('.popup-action-text').textContent = originalText;
                }, 1000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });

            // Close popup
            btn.closest('.user-message-actions-popup').classList.remove('show');
        }

        function editUserMessage(btn) {
            const messageContainer = btn.closest('.message.user');
            const messageContent = messageContainer.querySelector('.message-content');

            if (messageContent.classList.contains('editing')) return;

            const currentText = messageContent.textContent || messageContent.innerText || '';

            // Create enhanced edit interface with Send button to regenerate AI response
            const editContainer = document.createElement('div');
            editContainer.innerHTML = `
                <textarea class="user-message-edit-area" style="width:100%;min-height:60px;font-family:inherit;padding:8px;border:1px solid var(--border-color);border-radius:6px;background-color:var(--assistant-bg);color:var(--text-primary);font-size:14px;resize:vertical;outline:none;">${currentText}</textarea>
                <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end;">
                    <button class="edit-send-btn" style="padding:6px 12px;background:var(--accent-color);color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;">Send</button>
                    <button class="edit-cancel-btn" style="padding:6px 12px;background:#ef4444;color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;">Cancel</button>
                </div>
            `;

            const originalContent = messageContent.innerHTML;
            messageContent.innerHTML = '';
            messageContent.appendChild(editContainer);
            messageContent.classList.add('editing');

            const editArea = editContainer.querySelector('.user-message-edit-area');
            editArea.focus();
            editArea.select();

            // Send button - sends the edited message and regenerates AI response
            editContainer.querySelector('.edit-send-btn').onclick = async function() {
                const newText = editArea.value.trim();
                if (!newText) {
                    messageContent.innerHTML = originalContent;
                    messageContent.classList.remove('editing');
                    return;
                }

                // Update the message content first
                messageContent.textContent = newText;
                messageContent.classList.remove('editing');

                // Show progress notification
                showToast('Regenerating AI response...', 'info');

                // Regenerate AI response with the edited message, passing the message container
                try {
                    await regenerateAIResponse(newText, messageContainer);
                    showToast('Response regenerated successfully', 'success');
                } catch (error) {
                    console.error('Regeneration error:', error);
                    showToast('Failed to regenerate response', 'error');
                }
            };

            // Cancel button
            editContainer.querySelector('.edit-cancel-btn').onclick = function() {
                messageContent.innerHTML = originalContent;
                messageContent.classList.remove('editing');
            };

            // Close popup
            btn.closest('.user-message-actions-popup').classList.remove('show');
        }

        // Function to regenerate AI response
        async function regenerateAIResponse(userMessage, editedMessageContainer) {
            // Set generation state
            isGenerating = true;
            updateAllSendButtons();

            // Find and remove the AI response that follows the edited user message
            if (editedMessageContainer) {
                let nextElement = editedMessageContainer.nextElementSibling;
                while (nextElement) {
                    if (nextElement.classList && nextElement.classList.contains('message') && 
                        nextElement.classList.contains('assistant')) {
                        const elementToRemove = nextElement;
                        nextElement = nextElement.nextElementSibling;
                        elementToRemove.remove();
                        break;
                    }
                    nextElement = nextElement.nextElementSibling;
                }
            }

            // Update conversation history - remove the old exchange
            const chatMessages = document.querySelectorAll('.message');
            const userMessages = Array.from(chatMessages).filter(msg => msg.classList.contains('user'));
            const editedMessageIndex = Array.from(userMessages).indexOf(editedMessageContainer);

            if (editedMessageIndex >= 0 && conversation.length > editedMessageIndex) {
                // Remove all conversation entries from this point onwards
                conversation.splice(editedMessageIndex);
            }

            // Create streaming message container
            const streamingElements = createStreamingMessage();
            currentController = new AbortController();

            // Use current selected provider for regeneration
            const selectedMode = currentSelectedProvider === 'deepseek-reasoning' ? 'reasoner' : 'chat';
            const cfg = deepseekConfig[selectedMode];
            let apiEndpoint = cfg.route;
            let requestBody = {
                message: userMessage,
                conversation: conversation,
                model: cfg.model,
                temperature: cfg.temperature,
                max_tokens: cfg.max_tokens
            };

            // Handle different providers
            if (currentSelectedProvider === 'mistral') {
                apiEndpoint = '/api/mistral-stream';
                requestBody = {
                    message: userMessage,
                    conversation: conversation,
                    model: 'mistral-small-latest',
                    temperature: 0.5,
                    max_tokens: 2048
                };
            }

            try {
                const response = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody),
                    signal: currentController.signal
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText || 'Server error'}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let accumulatedContent = '';

                while (true) {
                    const { done, value } = await reader.read();

                    if (done) {
                        break;
                    }

                    const chunk = decoder.decode(value, { stream: true });
                    if (chunk && chunk.trim()) {
                        accumulatedContent += chunk;
                        updateStreamingMessage(streamingElements, accumulatedContent);
                    }
                }

                if (accumulatedContent.trim()) {
                    finalizeStreamingMessage(streamingElements, accumulatedContent);
                    conversation.push({ user: userMessage, assistant: accumulatedContent });
                } else {
                    updateStreamingMessage(streamingElements, 'No response received from the AI. Please try again.');
                    finalizeStreamingMessage(streamingElements, 'No response received from the AI. Please try again.');
                }

            } catch (error) {
                if (error.name === 'AbortError') {
                    updateStreamingMessage(streamingElements, 'Response generation was stopped.');
                    finalizeStreamingMessage(streamingElements, 'Response generation was stopped.');
                } else {
                    let errorMessage = `âŒ **Regeneration Failed**\n\n**Provider:** ${currentSelectedProvider}\n**Error:** ${error.message}\n\nPlease try again or select a different provider.`;
                    updateStreamingMessage(streamingElements, errorMessage);
                    finalizeStreamingMessage(streamingElements, errorMessage);
                }
            } finally {
                isGenerating = false;
                updateAllSendButtons();
                currentController = null;
                autoResizeTextarea();
            }
        }

        // Enhanced toast notification function
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = 'confirmation-toast show';
            toast.style.background = type === 'success' ? '#10b981' : 
                                   type === 'error' ? '#ef4444' : 
                                   type === 'info' ? '#3b82f6' : '#10b981';
            toast.textContent = message;

            document.body.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('hide');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        }

        function copyMessage(btn) {
            const messageContainer = btn.closest('.message');
            const messageDiv = messageContainer.querySelector('.message-content');
            let text = messageDiv.textContent || messageDiv.innerText || '';

            navigator.clipboard.writeText(text.trim()).then(() => {
                // Visual feedback
                const originalText = btn.querySelector('.popup-action-text').textContent;
                btn.querySelector('.popup-action-text').textContent = 'Copied!';
                setTimeout(() => {
                    btn.querySelector('.popup-action-text').textContent = originalText;
                }, 1000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });

            // Close popup
            btn.closest('.message-actions-popup').classList.remove('show');
        }

        function saveAsPDF(btn) {
            const messageContainer = btn.closest('.message');
            const messageDiv = messageContainer.querySelector('.message-content');
            const text = messageDiv.textContent || messageDiv.innerText || '';

            // Create a simple HTML document for PDF
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>MavericPro AI Response</title>
                    <style>
                        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; line-height: 1.6; padding: 20px; }
                        .header { border-bottom: 1px solid #ccc; padding-bottom: 10px; margin-bottom: 20px; }
                        .content { white-space: pre-wrap; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>MavericPro AI Response</h1>
                        <p>Generated on: ${new Date().toLocaleString()}</p>
                    </div>
                    <div class="content">${text.trim()}</div>
                </body>
                </html>
            `);
            printWindow.document.close();

            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);

            // Close popup
            btn.closest('.message-actions-popup').classList.remove('show');
        }

        async function summarizeMessage(btn) {
            const messageContainer = btn.closest('.message');
            const messageDiv = messageContainer.querySelector('.message-content');
            const text = messageDiv.textContent || messageDiv.innerText || '';

            if (!text.trim()) {
                addMessageToChat('assistant', 'No text found to summarize.');
                return;
            }

            // Visual feedback
            const originalText = btn.querySelector('.popup-action-text').textContent;
            const originalIcon = btn.querySelector('.popup-action-icon').textContent;
            btn.querySelector('.popup-action-text').textContent = 'Summarizing...';
            btn.querySelector('.popup-action-icon').textContent = 'â³';
            btn.disabled = true;

            // Close popup
            btn.closest('.message-actions-popup').classList.remove('show');

            // Create summary request
            const summaryPrompt = `Please provide a concise summary of the following text:\n\n${text.trim()}`;

            try {
                const response = await fetch('/api/deepseek-stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: summaryPrompt,
                        conversation: [],
                        provider: selectedProvider
                    })
                });

                if (!response.ok) {
                    throw new Error(`Summary failed: ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let accumulatedContent = '';

                // Create a streaming message for the summary
                const streamingElements = createStreamingMessage();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    accumulatedContent += chunk;
                    updateStreamingMessage(streamingElements, accumulatedContent);
                }

                finalizeStreamingMessage(streamingElements, accumulatedContent);

                // Show success feedback
                btn.querySelector('.popup-action-text').textContent = 'Summarized!';
                btn.querySelector('.popup-action-icon').textContent = 'âœ…';

                setTimeout(() => {
                    btn.querySelector('.popup-action-text').textContent = originalText;
                    btn.querySelector('.popup-action-icon').textContent = originalIcon;
                    btn.disabled = false;
                }, 2000);

            } catch (error) {
                console.error('Summary error:', error);
                addMessageToChat('assistant', 'âŒ **Summary Failed**\n\nUnable to generate summary. Please try again.');

                // Show error feedback
                btn.querySelector('.popup-action-text').textContent = 'Failed';
                btn.querySelector('.popup-action-icon').textContent = 'âŒ';

                setTimeout(() => {
                    btn.querySelector('.popup-action-text').textContent = originalText;
                    btn.querySelector('.popup-action-icon').textContent = originalIcon;
                    btn.disabled = false;
                }, 2000);
            }
        }

        let currentDiagramText = '';

        function createDiagram(btn) {
            const messageContainer = btn.closest('.message');
            const messageDiv = messageContainer.querySelector('.message-content');
            const text = messageDiv.textContent || messageDiv.innerText || '';

            if (!text.trim()) {
                addMessageToChat('assistant', 'No text found to create diagrams from.');
                return;
            }

            // Store text globally to avoid passing it in onclick attributes
            currentDiagramText = text.trim();

            // Close popup first
            btn.closest('.message-actions-popup').classList.remove('show');

            // Show enhanced diagram options modal
            const diagramModal = document.createElement('div');
            diagramModal.className = 'modal-overlay show';
            diagramModal.id = 'diagramModal';
            diagramModal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-title">ðŸŽ¨ Create Enhanced Diagram</div>
                    <div class="modal-message">Choose the type of visualization to create from your content:</div>

                    <div style="display: flex; flex-direction: column; gap: 12px; margin: 20px 0;">
                        <button class="diagram-option-btn" onclick="createMermaidDiagram()">
                            ðŸ“Š Mermaid Flowchart/Diagram
                            <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">Flowcharts, sequence diagrams, mind maps</div>
                        </button>
                        <button class="diagram-option-btn chart-btn" onclick="createChartDiagram()">
                            ðŸ“ˆ Chart.js Graph/Chart
                            <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">Bar, line, pie, radar charts with data</div>
                        </button>
                        <button class="diagram-option-btn table-btn" onclick="createTableDiagram()">
                            ðŸ“‹ Enhanced Data Table
                            <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">Organized tables with styling</div>
                        </button>
                        <button class="diagram-option-btn custom-btn" onclick="createCustomDiagram()">
                            ðŸ“Š Bichart (Bar + Line)
                            <div style="font-size: 12px; opacity: 0.8; margin-top: 4px;">Combination chart with dual y-axes</div>
                        </button>
                    </div>

                    <div class="modal-buttons">
                        <button class="modal-button secondary" onclick="closeDiagramModal()">Cancel</button>
                    </div>
                </div>
            `;

            document.body.appendChild(diagramModal);
        }

        function closeDiagramModal() {
            const modal = document.getElementById('diagramModal');
            if (modal) {
                modal.remove();
            }
            currentDiagramText = '';
        }

        function createMermaidDiagram() {
            const diagramPrompt = `Create a Mermaid.js diagram (flowchart, sequence, or mindmap) based on this content. Include the mermaid code block:\n\n${currentDiagramText}`;
            closeDiagramModal();
            setTimeout(() => {
                const messageInput = document.getElementById('messageInput');
                messageInput.value = diagramPrompt;
                sendMessage();
            }, 100);
        }

        function createChartDiagram() {
            const diagramPrompt = `Create an interactive Chart.js visualization from this content. Please provide the chart in this exact format:

\`\`\`chart
{
  "type": "bar",
  "data": {
    "labels": ["Category 1", "Category 2", "Category 3", "Category 4"],
    "datasets": [{
      "label": "Sample Data",
      "data": [65, 59, 80, 81],
      "backgroundColor": [
        "rgba(255, 99, 132, 0.8)",
        "rgba(54, 162, 235, 0.8)",
        "rgba(255, 205, 86, 0.8)",
        "rgba(75, 192, 192, 0.8)"
      ],
      "borderColor": [
        "rgba(255, 99, 132, 1)",
        "rgba(54, 162, 235, 1)",
        "rgba(255, 205, 86, 1)",
        "rgba(75, 192, 192, 1)"
      ],
      "borderWidth": 2
    }]
  },
  "options": {
    "responsive": true,
    "plugins": {
      "title": {
        "display": true,
        "text": "Chart Title"
      }
    },
    "scales": {
      "y": {
        "beginAtZero": true
      }
    }
  }
}
\`\`\`

Content to analyze: ${currentDiagramText}

Choose the most appropriate chart type (bar, line, pie, doughnut, radar, or scatter) and extract real data from the content.`;
            closeDiagramModal();
            setTimeout(() => {
                const messageInput = document.getElementById('messageInput');
                messageInput.value = diagramPrompt;
                sendMessage();
            }, 100);
        }

        function createTableDiagram() {
            const diagramPrompt = `Create an interactive DataTable from this content. Use this exact format for the response:

\`\`\`datatable
[
  {"Column1": "Value1", "Column2": "Value2", "Column3": "Value3"},
  {"Column1": "Value4", "Column2": "Value5", "Column3": "Value6"}
]
\`\`\`

Content to convert: ${currentDiagramText}`;
            closeDiagramModal();
            setTimeout(() => {
                const messageInput = document.getElementById('messageInput');
                messageInput.value = diagramPrompt;
                sendMessage();
            }, 100);
        }

        function createCustomDiagram() {
            const diagramPrompt = `Create a bichart (combination chart) with both bar and line elements using Chart.js. Format as:

\`\`\`chart
{
  "type": "bar",
  "data": {
    "labels": ["Q1", "Q2", "Q3", "Q4"],
    "datasets": [
      {
        "type": "bar",
        "label": "Sales Volume",
        "data": [120, 190, 300, 250],
        "backgroundColor": "rgba(54, 162, 235, 0.7)",
        "borderColor": "rgba(54, 162, 235, 1)",
        "borderWidth": 2,
        "yAxisID": "y"
      },
      {
        "type": "line",
        "label": "Growth Rate %",
        "data": [15, 25, 35, 20],
        "backgroundColor": "rgba(255, 99, 132, 0.2)",
        "borderColor": "rgba(255, 99, 132, 1)",
        "borderWidth": 3,
        "fill": false,
        "yAxisID": "y1"
      }
    ]
  },
  "options": {
    "responsive": true,
    "interaction": {
      "intersect": false,
      "mode": "index"
    },
    "plugins": {
      "title": {
        "display": true,
        "text": "Bichart: Volume vs Growth Rate"
      }
    },
    "scales": {
      "y": {
        "type": "linear",
        "display": true,
        "position": "left",
        "title": {
          "display": true,
          "text": "Volume"
        }
      },
      "y1": {
        "type": "linear",
        "display": true,
        "position": "right",
        "title": {
          "display": true,
          "text": "Percentage (%)"
        },
        "grid": {
          "drawOnChartArea": false
        }
      }
    }
  }
}
\`\`\`

Content to analyze: ${currentDiagramText}

Extract relevant data for both bar and line components from the content.`;
            closeDiagramModal();
            setTimeout(() => {
                const messageInput = document.getElementById('messageInput');
                messageInput.value = diagramPrompt;
                sendMessage();
            }, 100);
        }

        async function translateMessage(btn) {
            const messageContainer = btn.closest('.message');
            const messageDiv = messageContainer.querySelector('.message-content');
            let text = messageDiv.textContent || messageDiv.innerText || '';

            text = text.trim();

            if (!text) {
                addMessageToChat('assistant', 'No text found to translate.');
                return;
            }

            // Visual feedback
            const originalText = btn.querySelector('.popup-action-text').textContent;
            const originalIcon = btn.querySelector('.popup-action-icon').textContent;
            btn.querySelector('.popup-action-text').textContent = 'Translating...';
            btn.querySelector('.popup-action-icon').textContent = 'â³';
            btn.disabled = true;

            // Close popup first
            btn.closest('.message-actions-popup').classList.remove('show');

            try {
                // Try smart translation endpoint first
                const response = await fetch('/api/translate-smart', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        text: text,
                        targetLanguage: 'Arabic',
                        provider: 'auto'
                    })
                });

                if (!response.ok) {
                    throw new Error(`Translation failed: ${response.status}`);
                }

                const data = await response.json();

                // Format translation result with RTL support - show only translated text
                const translationResult = `<div dir="rtl" style="text-align: justify; font-family: 'Arial', 'Tahoma', sans-serif; line-height: 1.8; margin: 10px 0; padding: 15px; background: rgba(0,0,0,0.05); border-radius: 8px; border-right: 4px solid #1a73e8;">${data.translatedText}</div>`;

                addMessageToChat('assistant', translationResult);

                // Show success feedback
                btn.querySelector('.popup-action-text').textContent = 'Translated!';
                btn.querySelector('.popup-action-icon').textContent = 'âœ…';

                setTimeout(() => {
                    btn.querySelector('.popup-action-text').textContent = originalText;
                    btn.querySelector('.popup-action-icon').textContent = originalIcon;
                }, 2000);

            } catch (error) {
                console.error('Translation error:', error);

                // Detailed error handling
                let errorMessage = 'âŒ **Translation Failed**\n\n';
                if (error.message.includes('500')) {
                    errorMessage += 'Translation service temporarily unavailable. Please check API configuration.';
                } else if (error.message.includes('400')) {
                    errorMessage += 'Invalid text provided for translation.';
                } else if (error.message.includes('fetch')) {
                    errorMessage += 'Network connection issue. Please check your internet connection.';
                } else {
                    errorMessage += `Error: ${error.message}`;
                }

                addMessageToChat('assistant', errorMessage);

                // Show error feedback
                btn.querySelector('.popup-action-text').textContent = 'Failed';
                btn.querySelector('.popup-action-icon').textContent = 'âŒ';

                setTimeout(() => {
                    btn.querySelector('.popup-action-text').textContent = originalText;
                    btn.querySelector('.popup-action-icon').textContent = originalIcon;
                }, 2000);

            } finally {
                btn.disabled = false;
            }
        }

        // Toast notification function for immediate feedback
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = 'color-toast';
            toast.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: ${type === 'success' ? '#10b981' : '#3b82f6'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
                z-index: 10001;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
                font-size: 14px;
                font-weight: 500;
                max-width: 300px;
                animation: slideInRight 0.3s ease-out;
            `;
            toast.textContent = message;

            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        // Global audio state management
        let currentAudio = null;
        let currentTTSButton = null;

        async function readAloud(btn) {
            const messageContainer = btn.closest('.message');
            const messageDiv = messageContainer.querySelector('.message-content');
            const text = messageDiv.textContent || messageDiv.innerText || '';
            const cleanText = text.trim();

            if (!cleanText) {
                addMessageToChat('assistant', 'No text found to read aloud.');
                return;
            }

            const originalText = btn.querySelector('.popup-action-text').textContent;
            const originalIcon = btn.querySelector('.popup-action-icon').textContent;

            // If this button is currently playing, stop it
            if (currentTTSButton === btn && currentAudio && !currentAudio.paused) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                btn.querySelector('.popup-action-text').textContent = originalText;
                btn.querySelector('.popup-action-icon').textContent = originalIcon;
                currentTTSButton = null;
                currentAudio = null;
                btn.closest('.message-actions-popup').classList.remove('show');
                return;
            }

            // Stop any other playing audio
            if (currentAudio && !currentAudio.paused) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                if (currentTTSButton) {
                    currentTTSButton.querySelector('.popup-action-text').textContent = 'Read aloud';
                    currentTTSButton.querySelector('.popup-action-icon').textContent = 'ðŸ”Š';
                }
            }

            // Visual feedback - loading state
            btn.querySelector('.popup-action-text').textContent = 'Loading...';
            btn.querySelector('.popup-action-icon').textContent = 'â³';
            btn.disabled = true;

            try {
                const response = await fetch('/api/tts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        text: cleanText,
                        voice: 'nova' // You can make this configurable
                    })
                });

                if (!response.ok) {
                    throw new Error(`TTS failed: ${response.status}`);
                }

                // Create audio blob and play
                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);

                currentAudio = audio;
                currentTTSButton = btn;

                // Update button to show playing state
                btn.querySelector('.popup-action-text').textContent = 'Stop Reading';
                btn.querySelector('.popup-action-icon').textContent = 'â¹ï¸';
                btn.disabled = false;

                // Handle audio events
                audio.onplay = () => {
                    btn.querySelector('.popup-action-text').textContent = 'Stop Reading';
                    btn.querySelector('.popup-action-icon').textContent = 'â¹ï¸';
                };

                audio.onended = () => {
                    btn.querySelector('.popup-action-text').textContent = originalText;
                    btn.querySelector('.popup-action-icon').textContent = originalIcon;
                    currentTTSButton = null;
                    currentAudio = null;
                    URL.revokeObjectURL(audioUrl);
                };

                audio.onerror = (error) => {
                    console.error('Audio playback error:', error);
                    btn.querySelector('.popup-action-text').textContent = originalText;
                    btn.querySelector('.popup-action-icon').textContent = originalIcon;
                    currentTTSButton = null;
                    currentAudio = null;
                    URL.revokeObjectURL(audioUrl);
                    addMessageToChat('assistant', 'Audio playback failed. Please try again.');
                };

                // Start playing
                await audio.play();

            } catch (error) {
                console.error('TTS error:', error);
                btn.querySelector('.popup-action-text').textContent = originalText;
                btn.querySelector('.popup-action-icon').textContent = originalIcon;
                btn.disabled = false;
                currentTTSButton = null;
                currentAudio = null;

                let errorMessage = 'Text-to-speech failed. ';
                if (error.message.includes('TTS failed: 500')) {
                    errorMessage += 'Please check if OpenAI API key is configured.';
                } else if (error.message.includes('fetch')) {
                    errorMessage += 'Network connection issue.';
                } else {
                    errorMessage += 'Please try again later.';
                }

                addMessageToChat('assistant', errorMessage);
            }

            // Close popup
            btn.closest('.message-actions-popup').classList.remove('show');
        }

        function speakToAI(btn) {
            const messageContainer = btn.closest('.message');
            const messageDiv = messageContainer.querySelector('.message-content');
            const text = messageDiv.textContent || messageDiv.innerText || '';

            // Voice conversation feature implementation would go here
            console.log('Voice conversation about topic:', text.substring(0, 100));

            // Close popup
            btn.closest('.message-actions-popup').classList.remove('show');
        }





        // User message action functions
        function deleteUserMessage(btn) {
            const messageContainer = btn.closest('.message');
            if (messageContainer) {
                messageContainer.remove();
            }
            btn.closest('.user-message-actions-popup').classList.remove('show');
        }

        function copyUserMessage(btn) {
            const messageContainer = btn.closest('.message');
            const messageDiv = messageContainer.querySelector('.message-content');
            let text = messageDiv.textContent || messageDiv.innerText || '';

            navigator.clipboard.writeText(text.trim()).then(() => {
                const originalText = btn.querySelector('.popup-action-text').textContent;
                btn.querySelector('.popup-action-text').textContent = 'Copied!';
                setTimeout(() => {
                    btn.querySelector('.popup-action-text').textContent = originalText;
                }, 1000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });

            btn.closest('.user-message-actions-popup').classList.remove('show');
        }

        function editUserMessage(btn) {
            const messageContainer = btn.closest('.message');
            const messageDiv = messageContainer.querySelector('.message-content');
            const currentText = messageDiv.textContent || messageDiv.innerText || '';

            // Create input for editing
            const editInput = document.createElement('textarea');
            editInput.value = currentText.trim();
            editInput.style.cssText = `
                width: 100%;
                min-height: 40px;
                padding: 8px;
                border: 1px solid var(--border-color);
                border-radius: 6px;
                font-family: inherit;
                font-size: inherit;
                resize: vertical;
                outline: none;
            `;

            // Create save/cancel buttons
            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = 'margin-top: 8px; display: flex; gap: 8px; justify-content: flex-end;';

            const saveBtn = document.createElement('button');
            saveBtn.textContent = 'Save';
            saveBtn.style.cssText = 'padding: 4px 12px; background: var(--accent-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;';

            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Cancel';
            cancelBtn.style.cssText = 'padding: 4px 12px; background: var(--hover-bg); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 4px; cursor: pointer; font-size: 12px;';

            // Save functionality
            saveBtn.onclick = () => {
                const newText = editInput.value.trim();
                if (newText) {
                    messageDiv.textContent = newText;
                }
                messageDiv.appendChild(messageContainer.querySelector('.user-message-actions-popup'));
            };

            // Cancel functionality
            cancelBtn.onclick = () => {
                messageDiv.textContent = currentText;
                messageDiv.appendChild(messageContainer.querySelector('.user-message-actions-popup'));
            };

            buttonContainer.appendChild(saveBtn);
            buttonContainer.appendChild(cancelBtn);

            // Replace content with edit interface
            messageDiv.innerHTML = '';
            messageDiv.appendChild(editInput);
            messageDiv.appendChild(buttonContainer);
            editInput.focus();
            editInput.select();
        }

        // Close dropdowns and popups when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.chat-menu')) {
                document.querySelectorAll('.chat-dropdown').forEach(dropdown => {
                    dropdown.classList.remove('show');
                });
            }

            if (!event.target.closest('.message-toggle') && !event.target.closest('.message-actions-popup') &&
                !event.target.closest('.user-message-actions-popup')) {
                document.querySelectorAll('.message-actions-popup, .user-message-actions-popup').forEach(popup => {
                    popup.classList.remove('show');
                });
            }

            // Close modal when clicking on overlay (not on modal content)
            if (event.target.id === 'modalOverlay') {
                closeModal();
            }

            // Close settings when clicking on overlay
            if (event.target.id === 'settingsOverlay') {
                cancelSettings();
            }

            // Close archive popup when clicking on overlay
            if (event.target.id === 'archiveOverlay') {
                toggleArchivePopup();
            }

            // Close diagram modal when clicking on overlay
            if (event.target.id === 'diagramModal') {
                closeDiagramModal();
            }

            // Close provider selector when clicking outside
            if (!event.target.closest('.provider-selector-popup') && 
                !event.target.closest('#providerToggleBtn') &&
                !event.target.closest('#bottomProviderToggleBtn')) {
                closeNewProviderSelector();
            }
        });

        // Initialize button handlers with validation
        function initializeButtonHandlers() {
            try {
                console.log('ðŸ”§ Initializing button handlers...');

                const sendButton = document.getElementById('newSendButton');
                const bottomSendButton = document.getElementById('newBottomSendButton');

                if (sendButton && !sendButton.hasAttribute('data-handler-added')) {
                    sendButton.onclick = function(e) {
                        e.preventDefault();
                        sendMessage();
                    };
                    sendButton.setAttribute('data-handler-added', 'true');
                    console.log('âœ… Main send button initialized');
                }

                if (bottomSendButton && !bottomSendButton.hasAttribute('data-handler-added')) {
                    bottomSendButton.onclick = function(e) {
                        e.preventDefault();
                        sendMessageFromBottom();
                    };
                    bottomSendButton.setAttribute('data-handler-added', 'true');
                    console.log('âœ… Bottom send button initialized');
                }

                const providerToggleBtn = document.getElementById('providerToggleBtn');
                if (providerToggleBtn && !providerToggleBtn.hasAttribute('data-handler-added')) {
                    providerToggleBtn.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        toggleProviderSelector();
                    };
                    providerToggleBtn.setAttribute('data-handler-added', 'true');
                    console.log('âœ… Provider toggle button initialized');
                }

                const bottomProviderBtn = document.getElementById('bottomProviderToggleBtn');
                if (bottomProviderBtn && !bottomProviderBtn.hasAttribute('data-handler-added')) {
                    bottomProviderBtn.onclick = function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        toggleProviderSelector();
                    };
                    bottomProviderBtn.setAttribute('data-handler-added', 'true');
                    console.log('âœ… Bottom provider button initialized');
                }

                console.log('ðŸŽ‰ All button handlers initialized successfully');
            } catch (error) {
                console.error('âŒ Error initializing button handlers:', error);
            }
        }

        // Deployment readiness check
        function validateDeploymentReadiness() {
            const checks = [
                { name: 'DOM Elements', test: () => document.getElementById('chatArea') && document.getElementById('messageInput') },
                { name: 'Provider Config', test: () => typeof currentSelectedProvider !== 'undefined' && currentSelectedProvider },
                { name: 'Send Function', test: () => typeof sendMessage === 'function' },
                { name: 'Provider Selector', test: () => typeof toggleProviderSelector === 'function' },
                { name: 'Error Handlers', test: () => window.onerror !== null },
                { name: 'Auto Resize', test: () => typeof autoResizeTextarea === 'function' }
            ];

            let passed = 0;
            checks.forEach(check => {
                if (check.test()) {
                    console.log(`âœ… ${check.name} - Ready`);
                    passed++;
                } else {
                    console.warn(`âŒ ${check.name} - Failed`);
                }
            });

            const readiness = (passed / checks.length) * 100;
            console.log(`ðŸš€ Deployment Readiness: ${readiness.toFixed(1)}%`);

            if (readiness === 100) {
                console.log('ðŸŽ‰ MavericPro is ready for deployment!');
            } else {
                console.warn('âš ï¸ Some checks failed - review before deployment');
            }

            return readiness === 100;
        }

        // Run deployment check after initialization
        setTimeout(() => {
            if (initializationComplete) {
                validateDeploymentReadiness();
            }
        }, 2000);

        function showTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            indicator.style.display = 'block';
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            indicator.style.display = 'none';
        }

        let thinkingInterval = null;

        // Settings state
        let settings = {
            darkMode: false,
            memory: true,
            responseStyle: 'standard'
        };

        // New Provider management
        let currentSelectedProvider = 'deepseek-chat';
        let selectedProvider = 'deepseek-chat'; // Keep for compatibility
        let selectedProviders = ['deepseek-chat']; // Keep for compatibility
        let activeProviders = ['deepseek-chat']; // Keep for compatibility
        let newProviderStatus = {
            'deepseek-chat': 'disconnected',
            'deepseek-reasoning': 'disconnected',
            'wolfram': 'disconnected',
            'openai': 'disconnected',
            'grok': 'disconnected',
            'google': 'disconnected',
            'mistral': 'disconnected'
        };

        // Initialize new provider selector with error handling
        function initializeNewProviderSelector() {
            try {
                // Load saved provider from localStorage
                const savedSettings = localStorage.getItem('mavericSettings');
                if (savedSettings) {
                    try {
                        const settings = JSON.parse(savedSettings);
                        if (settings.selectedProvider) {
                            currentSelectedProvider = settings.selectedProvider;
                            selectedProvider = settings.selectedProvider;
                            activeProviders = [currentSelectedProvider];
                            selectedProviders = [currentSelectedProvider];
                        }
                    } catch (error) {
                        console.error('Error parsing provider settings:', error);
                        // Use default settings
                        currentSelectedProvider = 'deepseek-chat';
                        selectedProvider = 'deepseek-chat';
                        activeProviders = ['deepseek-chat'];
                        selectedProviders = ['deepseek-chat'];
                    }
                } else {
                    // Set defaults if no saved settings
                    currentSelectedProvider = 'deepseek-chat';
                    selectedProvider = 'deepseek-chat';
                    activeProviders = ['deepseek-chat'];
                    selectedProviders = ['deepseek-chat'];
                }

                // Initialize provider status with proper colors
                const allProviders = ['deepseek-chat', 'deepseek-reasoning', 'wolfram', 'openai', 'grok', 'google', 'mistral'];
                allProviders.forEach(provider => {
                    if (provider === currentSelectedProvider) {
                        newProviderStatus[provider] = 'connected';
                    } else {
                        newProviderStatus[provider] = 'offline';
                    }
                });

                updateNewProviderIcon();
                updateNewProviderUI();
            } catch (error) {
                console.error('Error initializing provider selector:', error);
                // Fallback to defaults
                currentSelectedProvider = 'deepseek-chat';
                selectedProvider = 'deepseek-chat';
                activeProviders = ['deepseek-chat'];
                selectedProviders = ['deepseek-chat'];
            }
        }

        // New provider selector functions
        // Provider selector toggle function
        function toggleProviderSelector() {
            console.log('ðŸ”„ toggleProviderSelector called');
            try {
                const popup = document.getElementById('newProviderSelectorPopup');
                if (!popup) {
                    console.error('âŒ Provider selector popup not found');
                    return;
                }

                const isVisible = popup.classList.contains('show');
                console.log('ðŸ“Š Popup currently visible:', isVisible);

                if (isVisible) {
                    closeNewProviderSelector();
                } else {
                    openNewProviderSelector();
                }
            } catch (error) {
                console.error('âŒ Error in toggleProviderSelector:', error);
            }
        }

        // Legacy compatibility function
        function toggleProvider(provider) {
            console.log('Legacy toggleProvider called for:', provider);
            selectNewProvider(provider);
        }

        function openNewProviderSelector() {
            console.log('openNewProviderSelector called');
            const popup = document.getElementById('newProviderSelectorPopup');
            if (!popup) {
                console.error('Provider popup element not found');
                return;
            }

            const bottomInputArea = document.getElementById('bottomInputArea');

            // Adjust popup position based on which input area is active
            if (bottomInputArea && bottomInputArea.style.display !== 'none') {
                popup.style.bottom = '100px';
                popup.style.left = '50%';
                popup.style.transform = 'translateX(-50%)';
            } else {
                popup.style.bottom = '50px';
                popup.style.left = '50%';
                popup.style.transform = 'translateX(-50%)';
            }

            popup.classList.add('show');
            updateNewProviderUI();
            console.log('Provider selector opened');
        }

        function closeNewProviderSelector() {
            console.log('closeNewProviderSelector called');
            const popup = document.getElementById('newProviderSelectorPopup');
            if (popup) {
                popup.classList.remove('show');
                console.log('Provider selector closed');
            }
        }

        function updateNewProviderUI() {
            try {
                // Clear all selections
                document.querySelectorAll('.provider-choice').forEach(choice => {
                    choice.classList.remove('active');
                });

                // Clear all radio buttons
                document.querySelectorAll('.provider-radio').forEach(radio => {
                    radio.checked = false;
                });

                // Update all provider indicators with three-state logic
                const allProviders = ['deepseek-chat', 'deepseek-reasoning', 'wolfram', 'openai', 'grok', 'google', 'mistral'];
                allProviders.forEach(provider => {
                    const indicator = document.getElementById(`new-status-${provider}`);
                    if (indicator) {
                        // Clear all existing classes
                        indicator.classList.remove('connected', 'disconnected', 'offline');

                        if (provider === currentSelectedProvider) {
                            // Check provider status using new logic
                            const status = checkProviderStatus(provider);

                            if (status === 'connected') {
                                // Green: Chosen and connected
                                indicator.classList.add('connected');
                                indicator.title = 'Active and connected';
                            } else if (status === 'disconnected') {
                                // Yellow (blinking): Chosen but not connected
                                indicator.classList.add('disconnected');
                                indicator.title = 'Active but not connected';
                            } else {
                                // Red: Not active/endpoint unavailable
                                indicator.classList.add('offline');
                                indicator.title = 'Endpoint unavailable';
                            }
                        } else {
                            // Red: Not active/not chosen
                            indicator.classList.add('offline');
                            indicator.title = 'Not active';
                            newProviderStatus[provider] = 'offline';
                        }
                    }
                });

                // Set current selection
                const selectedRadio = document.getElementById(`new-check-${currentSelectedProvider}`);
                const selectedChoice = document.querySelector(`.provider-choice[data-provider="${currentSelectedProvider}"]`);

                if (selectedRadio) selectedRadio.checked = true;
                if (selectedChoice) selectedChoice.classList.add('active');

                updateNewProviderIcon();
            } catch (error) {
                console.error('Error updating new provider UI:', error);
            }
        }

        function selectNewProvider(provider) {
            // Store previous provider
            const previousProvider = currentSelectedProvider;

            // Clear all selections first
            document.querySelectorAll('.provider-choice').forEach(choice => {
                choice.classList.remove('active');
            });
            document.querySelectorAll('.provider-radio').forEach(radio => {
                radio.checked = false;
            });

            // Set new selection
            currentSelectedProvider = provider;
            activeProviders = [provider]; // Update array for compatibility

            const radio = document.getElementById(`new-check-${provider}`);
            const choice = document.querySelector(`.provider-choice[data-provider="${provider}"]`);

            if (radio) radio.checked = true;
            if (choice) choice.classList.add('active');

            // Update previous provider to red (not active)
            if (previousProvider && previousProvider !== provider) {
                const prevIndicator = document.getElementById(`new-status-${previousProvider}`);
                if (prevIndicator) {
                    prevIndicator.classList.remove('connected', 'disconnected');
                    prevIndicator.classList.add('offline');
                    prevIndicator.title = 'Not active';
                    newProviderStatus[previousProvider] = 'offline';
                }
            }

            // Update provider status indicators immediately
            updateNewProviderUI();
        }

        // Provider status is now determined by API key availability and endpoint existence
        function checkProviderStatus(provider) {
            // Check if provider has required configuration
            const hasApiKey = checkApiKeyAvailability(provider);
            const hasEndpoint = checkEndpointAvailability(provider);

            if (hasApiKey && hasEndpoint) {
                newProviderStatus[provider] = 'connected';
                return 'connected';
            } else if (hasEndpoint) {
                newProviderStatus[provider] = 'disconnected';
                return 'disconnected';
            } else {
                newProviderStatus[provider] = 'offline';
                return 'offline';
            }
        }

        function checkApiKeyAvailability(provider) {
            // These would normally check environment variables, but we'll assume they're configured
            const apiKeyChecks = {
                'openai': true, // Assumes OPENAI_API_KEY is set
                'grok': true,   // Assumes GROK_API_KEY is set
                'google': true, // Assumes GOOGLE_API_KEY is set
                'deepseek-chat': true,
                'deepseek-reasoning': true,
                'wolfram': true,
                'mistral': true // Added Mistral support
            };
            return apiKeyChecks[provider] || false;
        }

        function checkEndpointAvailability(provider) {
            const availableEndpoints = ['deepseek-chat', 'deepseek-reasoning', 'wolfram', 'openai', 'grok', 'google', 'mistral'];
            return availableEndpoints.includes(provider);
        }

        function applyNewProvider() {
            // Update compatibility variables
            selectedProvider = currentSelectedProvider;
            selectedProviders = [currentSelectedProvider];

            // Save selected provider to localStorage
            const currentSettings = JSON.parse(localStorage.getItem('mavericSettings') || '{}');
            currentSettings.selectedProvider = currentSelectedProvider;
            localStorage.setItem('mavericSettings', JSON.stringify(currentSettings));

            // Update provider status indicators
            updateNewProviderUI();

            // Close popup
            closeNewProviderSelector();

            // Show connection status based on real provider state
            const providerNames = {
                'deepseek-chat': 'DeepSeek Chat',
                'deepseek-reasoning': 'DeepSeek Reasoning',
                'wolfram': 'Wolfram Alpha',
                'openai': 'OpenAI GPT-4',
                'grok': 'Grok (xAI)',
                'google': 'Google Gemini'
            };

            const providerName = providerNames[currentSelectedProvider] || currentSelectedProvider;
            const status = checkProviderStatus(currentSelectedProvider);

            if (status === 'connected') {
                showToast(`âœ… ${providerName} connected and active`, 'success');
            } else if (status === 'disconnected') {
                showToast(`ðŸ”„ ${providerName} connecting - configuration needed`, 'warning');
            } else {
                showToast(`âŒ ${providerName} not connecting - endpoint unavailable`, 'error');
            }
        }

        function getProviderEndpoint(provider) {
            const endpoints = {
                'deepseek-chat': '/api/deepseek-chat',
                'deepseek-reasoning': '/api/deepseek-reasoner',
                'deepseek': '/api/deepseek-chat',
                'openai': '/api/openai-stream',
                'grok': '/api/grok-stream',
                'google': '/api/google-stream',
                'wolfram': '/api/wolfram-stream',
                'mistral': '/api/mistral-stream'
            };
            return endpoints[provider] || '/api/deepseek-chat';
        }

        function getProviderDisplayName(provider) {
            const names = {
                'deepseek-chat': 'DeepSeek Chat',
                'deepseek-reasoning': 'DeepSeek Reasoning',
                'deepseek': 'DeepSeek',
                'openai': 'OpenAI GPT-4',
                'grok': 'Grok (xAI)',
                'google': 'Google Gemini',
                'wolfram': 'Wolfram Alpha'
            };
            return names[provider] || provider;
        }

        function updateNewProviderIcon() {
            const icon = document.getElementById('providerIcon');
            const bottomIcon = document.getElementById('bottomProviderIcon');
            const button = document.getElementById('providerToggleBtn');

            const providerNames = {
                'deepseek-chat': 'DeepSeek Chat',
                'deepseek-reasoning': 'DeepSeek Reasoning',
                'wolfram': 'Wolfram Alpha',
                'openai': 'OpenAI GPT-4',
                'grok': 'Grok (xAI)',
                'google': 'Google Gemini',
                'mistral': 'Mistral AI'
            };

            const providerIcons = {
                'deepseek-chat': 'ðŸŒ',
                'deepseek-reasoning': 'ðŸŒ',
                'wolfram': 'âˆ‘',
                'openai': 'ðŸ§ ',
                'grok': 'âš¡',
                'google': 'ðŸ”',
                'mistral': 'ðŸ”·'
            };

            const activeIcon = providerIcons[currentSelectedProvider] || 'ðŸŒ';

            if (icon) icon.textContent = activeIcon;
            if (bottomIcon) bottomIcon.textContent = activeIcon;
            if (button) button.title = `Active: ${providerNames[currentSelectedProvider] || currentSelectedProvider}`;
        }

        // Keep old function for compatibility
        function updateProviderIcon() {
            updateNewProviderIcon();
        }

        // Get the appropriate API endpoint based on selected provider
        function getAPIEndpoint() {
            console.log('Getting API endpoint for provider:', currentSelectedProvider);

            // Single provider - use direct endpoint
            const provider = currentSelectedProvider || selectedProvider || 'deepseek-chat';
            console.log('Using provider:', provider);
            return getProviderEndpoint(provider);
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('confirmationToast');
            if (!toast) {
                console.warn('Toast element not found');
                return;
            }

            // Clear any existing timeout
            if (toast.hideTimeout) {
                clearTimeout(toast.hideTimeout);
            }

            toast.textContent = message;
            toast.className = `confirmation-toast show`;

            if (type === 'error') {
                toast.style.background = '#ef4444';
            } else if (type === 'warning') {
                toast.style.background = '#f59e0b';
            } else {
                toast.style.background = '#10b981';
            }

            toast.hideTimeout = setTimeout(() => {
                toast.classList.add('hide');
                setTimeout(() => {
                    toast.classList.remove('show', 'hide');
                }, 300);
            }, 3000);
        }

        async function testSingleProvider(provider) {
            const statusEl = document.getElementById(`status-${provider}`);
            statusEl.className = 'provider-status loading';

            try {
                const endpoint = getProviderEndpoint(provider);
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message: 'test connection', 
                        conversation: [] 
                    })
                });

                if (response.ok) {
                    providerStatus[provider] = 'online';
                    statusEl.className = 'provider-status online';
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error(`Provider ${provider} test failed:`, error);
                providerStatus[provider] = 'offline';
                statusEl.className = 'provider-status offline';
            }
        }

        function updateProviderStatusUI(provider) {
            const statusEl = document.getElementById(`status-${provider}`);
            if (statusEl) {
                statusEl.className = `provider-status ${providerStatus[provider]}`;
            }
        }

        // Temporary settings for preview before save
        let tempSettings = {};

        function showThinkingAnimation() {
            const existingThinking = document.querySelector('.thinking-animation');
            if (existingThinking) {
                hideThinkingAnimation();
            }

            const thinkingDiv = document.createElement('div');
            thinkingDiv.className = 'thinking-animation';
            thinkingDiv.setAttribute('aria-live', 'polite');
            thinkingDiv.style.display = 'block';

            // Create Genspark-style thinking content
            thinkingDiv.innerHTML = `
                <div class="thinking-text">
                    <span>Thinking</span>
                    <div class="thinking-dots">
                        <div class="thinking-dot"></div>
                        <div class="thinking-dot"></div>
                        <div class="thinking-dot"></div>
                    </div>
                </div>
            `;

            const chatContainer = document.getElementById('chatArea');
            if (chatContainer) {
                chatContainer.appendChild(thinkingDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }

            // No interval needed for Genspark style - CSS handles the animation
            thinkingInterval = null;
        }

        function hideThinkingAnimation() {
            if (thinkingInterval) {
                clearInterval(thinkingInterval);
                thinkingInterval = null;
            }

            const thinkingDiv = document.querySelector('.thinking-animation');
            if (thinkingDiv) {
                thinkingDiv.classList.add('fade-out');
                setTimeout(() => {
                    if (thinkingDiv.parentNode) {
                        thinkingDiv.parentNode.removeChild(thinkingDiv);
                    }
                }, 300);
            }
        }

        // Settings Functions
        function toggleSettings() {
            const overlay = document.getElementById('settingsOverlay');
            const isVisible = overlay.classList.contains('show');

            if (isVisible) {
                overlay.classList.remove('show');
            } else {
                overlay.classList.add('show');
                loadSettings();
            }
        }

        function loadSettings() {
            try {
                // Initialize provider status first
                if (typeof window.providerStatus === 'undefined') {
                    window.providerStatus = {};
                }

                // Load settings from localStorage or use defaults
                const savedSettings = localStorage.getItem('mavericSettings');
                if (savedSettings) {
                    try {
                        const parsed = JSON.parse(savedSettings);
                        settings = { 
                            darkMode: false,
                            memory: true,
                            responseStyle: 'standard',
                            ...parsed 
                        };

                        // Load selected provider
                        if (parsed.selectedProvider) {
                            selectedProvider = parsed.selectedProvider;
                            currentSelectedProvider = parsed.selectedProvider;
                        } else {
                            // Default to DeepSeek Chat
                            selectedProvider = 'deepseek-chat';
                            currentSelectedProvider = 'deepseek-chat';
                        }
                    } catch (parseError) {
                        console.warn('Failed to parse saved settings, using defaults');
                        settings = {
                            darkMode: false,
                            memory: true,
                            responseStyle: 'standard'
                        };
                        selectedProvider = 'deepseek-chat';
                        currentSelectedProvider = 'deepseek-chat';
                    }
                } else {
                    // No saved settings, use defaults
                    settings = {
                        darkMode: false,
                        memory: true,
                        responseStyle: 'standard'
                    };
                    selectedProvider = 'deepseek-chat';
                    currentSelectedProvider = 'deepseek-chat';
                }

                // Initialize selectedProviders array for compatibility
                selectedProviders = [selectedProvider];

                // Set DeepSeek variants as online
                const deepseekProviders = ['deepseek-chat', 'deepseek-reasoning', 'deepseek-openrouter'];
                deepseekProviders.forEach(provider => {
                    if (window.providerStatus) {
                        window.providerStatus[provider] = 'online';
                    }
                });

                // Copy current settings to temporary settings
                tempSettings = { ...settings };

                // Apply current dark mode theme
                if (settings.darkMode) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                } else {
                    document.documentElement.removeAttribute('data-theme');
                }

                // Update UI elements safely
                const darkModeToggle = document.getElementById('darkModeToggle');
                if (darkModeToggle) darkModeToggle.classList.toggle('active', settings.darkMode);

                const memoryToggle = document.getElementById('memoryToggle');
                if (memoryToggle) memoryToggle.classList.toggle('active', settings.memory);

                console.log('Settings loaded successfully');
            } catch (error) {
                console.warn('Settings initialization issue, using safe defaults');
                // Set safe defaults
                settings = {
                    darkMode: false,
                    memory: true,
                    responseStyle: 'standard'
                };
                selectedProvider = 'deepseek-chat';
                currentSelectedProvider = 'deepseek-chat';
                selectedProviders = ['deepseek-chat'];
                tempSettings = { ...settings };

                // Initialize provider status safely
                if (typeof window.providerStatus === 'undefined') {
                    window.providerStatus = {
                        'deepseek-chat': 'online',
                        'deepseek-reasoning': 'online',
                        'deepseek-openrouter': 'online'
                    };
                }
            }
        }

        function saveSettings() {
            // Apply temporary settings to actual settings
            settings = { ...tempSettings };

            // Preserve selectedProviders
            settings.selectedProviders = [...selectedProviders];

            // Save to localStorage
            localStorage.setItem('mavericSettings', JSON.stringify(settings));

            // Apply dark mode theme immediately
            if (settings.darkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }

            // Visual feedback
            const saveBtn = document.querySelector('.personalization-footer .primary');
            if (saveBtn) {
                const originalText = saveBtn.textContent;
                const originalStyle = saveBtn.style.background;
                saveBtn.textContent = 'Saved!';
                saveBtn.style.background = '#10b981';
                saveBtn.style.color = 'white';

                setTimeout(() => {
                    saveBtn.textContent = originalText;
                    saveBtn.style.background = originalStyle;
                    saveBtn.style.color = '';
                    // Close the modal instead of toggling
                    const overlay = document.getElementById('settingsOverlay');
                    overlay.classList.remove('show');
                }, 1000);
            } else {
                // Close the modal instead of toggling
                const overlay = document.getElementById('settingsOverlay');
                overlay.classList.remove('show');
            }
        }

        function cancelSettings() {
            // Revert any visual changes
            if (settings.darkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }

            toggleSettings();
        }

        function toggleDarkModeSetting() {
            tempSettings.darkMode = !tempSettings.darkMode;
            const toggle = document.getElementById('darkModeToggle');
            if (toggle) {
                toggle.classList.toggle('active', tempSettings.darkMode);

                // Add visual feedback with smooth transition
                toggle.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    toggle.style.transform = 'scale(1)';
                }, 150);
            }

            // Preview the change immediately
            if (tempSettings.darkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }
        }



        function toggleMemorySetting() {
            tempSettings.memory = !tempSettings.memory;
            document.getElementById('memoryToggle').classList.toggle('active', tempSettings.memory);
        }





        // Get the appropriate API endpoint based on selected providers
        function getAPIEndpoint() {
            console.log('Selected providers for endpoint:', selectedProviders);

            // If multiple providers are selected, use meta-reasoning endpoint
            if (selectedProviders.length > 1) {
                console.log('Using meta-reasoning endpoint for', selectedProviders.length, 'providers');
                return '/api/meta-reasoning';
            }

            // Single provider - use direct endpoint
            const provider = selectedProviders[0] || 'deepseek-chat';
            console.log('Using single provider endpoint:', provider);
            return getProviderEndpoint(provider);
        }

        // Helper function to get single provider endpoint
        function getProviderEndpoint(provider) {
            const endpoints = {
                'deepseek-chat': '/api/deepseek-stream',
                'deepseek-reasoning': '/api/deepseek-stream',
                'deepseek-openrouter': '/api/deepseek-openrouter-stream',
                'deepseek': '/api/deepseek-stream',
                'openai': '/api/openai-stream',
                'perplexity': '/api/perplexity-stream'
            };
            return endpoints[provider] || '/api/deepseek-stream';
        }

        function getProviderDisplayName(provider) {
            const names = {
                'deepseek-chat': 'DeepSeek Chat',
                'deepseek-reasoning': 'DeepSeek Reasoning',
                'deepseek-openrouter': 'DeepSeek OpenRouter',
                'deepseek': 'DeepSeek',
                'openai': 'OpenAI GPT-4',
                'perplexity': 'Perplexity AI'
            };
            return names[provider] || provider;
        }

        // Personalization functions
        let personalizationSettings = {
            enabled: true,
            userName: 'Medical Professional',
            userRole: 'For any medical questions, make your answer based 100% on RCOG, NICE, FSRH, RCGP, UKGRC, MEDPAC, UK GMC, AMD Digital, GM & BON, PUH PO guidelines. Make answers formatted properly and professional for medical professionals.',
            aiTraits: 'Ensure that all answers to my questions are accurate and come from reputable sources, and always include citations and links to the sources of information.\n\nWhen answer any of my questions, don\'t show the results as a separate page.',
            selectedTraits: []
        };

        function openPersonalizationModal() {
            const overlay = document.getElementById('personalizationOverlay');
            overlay.classList.add('show');
            loadPersonalizationSettings();
        }

        function closePersonalizationModal() {
            const overlay = document.getElementById('personalizationOverlay');
            overlay.classList.remove('show');
        }

        function loadPersonalizationSettings() {
            const saved = localStorage.getItem('personalizationSettings');
            if (saved) {
                personalizationSettings = { ...personalizationSettings, ...JSON.parse(saved) };
            }

            document.getElementById('userName').value = personalizationSettings.userName;
            document.getElementById('userRole').value = personalizationSettings.userRole;
            document.getElementById('aiTraits').value = personalizationSettings.aiTraits;
            document.getElementById('enablePersonalization').classList.toggle('active', personalizationSettings.enabled);

            // Update trait buttons
            document.querySelectorAll('.trait-btn').forEach(btn => {
                const trait = btn.getAttribute('data-trait');
                if (trait && personalizationSettings.selectedTraits.includes(trait)) {
                    btn.classList.add('active');
                }
            });
        }

        function toggleTrait(button) {
            const trait = button.getAttribute('data-trait');
            if (!trait) return;

            button.classList.toggle('active');

            if (button.classList.contains('active')) {
                if (!personalizationSettings.selectedTraits.includes(trait)) {
                    personalizationSettings.selectedTraits.push(trait);
                }
            } else {
                personalizationSettings.selectedTraits = personalizationSettings.selectedTraits.filter(t => t !== trait);
            }
        }

        function refreshTraits() {
            document.querySelectorAll('.trait-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            personalizationSettings.selectedTraits = [];
        }

        function togglePersonalizationEnabled() {
            personalizationSettings.enabled = !personalizationSettings.enabled;
            document.getElementById('enablePersonalization').classList.toggle('active', personalizationSettings.enabled);
        }

        function savePersonalization() {
            personalizationSettings.userName = document.getElementById('userName').value;
            personalizationSettings.userRole = document.getElementById('userRole').value;
            personalizationSettings.aiTraits = document.getElementById('aiTraits').value;

            localStorage.setItem('personalizationSettings', JSON.stringify(personalizationSettings));

            // Visual feedback
            const saveBtn = document.querySelector('.personalization-footer .primary');
            const originalText = saveBtn.textContent;
            saveBtn.textContent = 'Saved!';
            saveBtn.style.background = '#10b981';

            setTimeout(() => {
                saveBtn.textContent = originalText;
                saveBtn.style.background = '';
                closePersonalizationModal();
            }, 1000);
        }

        // Demo function to create PPROM medical reference tables
        function createPPROMTables() {
            // Table 1: Diagnostic Criteria for PPROM
            const diagnosticCriteria = [
                {
                    "Feature": "Definition",
                    "Description": "Rupture of membranes before 37 weeks gestation AND before onset of labor"
                },
                {
                    "Feature": "Clinical Presentation",
                    "Description": "Sudden gush or persistent leakage of fluid from vagina"
                },
                {
                    "Feature": "Diagnostic Tests",
                    "Description": "â€¢ Pooling on speculum exam<br>â€¢ Positive nitrazine test (pH >6.5)<br>â€¢ Ferning pattern on microscopy<br>â€¢ Amnisure/ROM Plus tests"
                },
                {
                    "Feature": "Differential Diagnosis",
                    "Description": "Urinary incontinence, vaginal discharge, cervical mucus"
                }
            ];

            // Table 2: Management Based on Gestational Age
            const managementByAge = [
                {
                    "Gestational Age": "<24 weeks",
                    "Management Approach": "â€¢ Counseling about poor prognosis<br>â€¢ Consider expectant management vs termination"
                },
                {
                    "Gestational Age": "24-33+6 weeks",
                    "Management Approach": "â€¢ Expectant management with antibiotics, steroids<br>â€¢ Consider magnesium sulfate for neuroprotection<br>â€¢ Delivery if complications arise"
                },
                {
                    "Gestational Age": "34-36+6 weeks",
                    "Management Approach": "â€¢ Individualized approach<br>â€¢ Often deliver after steroid course"
                },
                {
                    "Gestational Age": "â‰¥37 weeks",
                    "Management Approach": "â€¢ Delivery recommended (no benefit to expectant management)"
                }
            ];

            // Table 3: Common Complications
            const complications = [
                {
                    "Complication": "Chorioamnionitis",
                    "Frequency": "15-25%",
                    "Prevention/Management": "Monitor for fever, maternal/fetal tachycardia; antibiotics"
                },
                {
                    "Complication": "Placental abruption",
                    "Frequency": "4-12%",
                    "Prevention/Management": "Monitor for vaginal bleeding, uterine tenderness"
                },
                {
                    "Complication": "Cord prolapse",
                    "Frequency": "0.3-0.6%",
                    "Prevention/Management": "Avoid unnecessary vaginal exams, monitor FHR"
                },
                {
                    "Complication": "Neonatal sepsis",
                    "Frequency": "1-4%",
                    "Prevention/Management": "GBS prophylaxis if positive, monitor neonate closely"
                },
                {
                    "Complication": "Pulmonary hypoplasia",
                    "Frequency": "(if <24 weeks)",
                    "Prevention/Management": "Counseling about poor prognosis"
                }
            ];

            // Table 4: Recommended Antibiotic Regimens
            const antibioticRegimens = [
                {
                    "Protocol": "NIH Consensus",
                    "Regimen": "Ampicillin 2g IV q6h + Erythromycin 250mg IV q6h x48h, then Amoxicillin 250mg PO q8h + Erythromycin 333mg PO q8h x5d"
                },
                {
                    "Protocol": "Alternative",
                    "Regimen": "Amoxicillin-clavulanate 875/125mg PO q12h x7d (if penicillin allergic: consult ID)"
                }
            ];

            // Create containers for each table
            const chatArea = document.querySelector('.chat-area');
            if (!chatArea) return;

            // Create a message container for the tables
            const messageContainer = document.createElement('div');
            messageContainer.className = 'message assistant';
            messageContainer.innerHTML = `
                <div class="message-content">
                    <h2 style="color: var(--accent-color); margin-bottom: 20px;">ðŸ¥ PPROM (Preterm Premature Rupture of Membranes) - Clinical Reference Tables</h2>
                    <div id="diagnostic-table"></div>
                    <div id="management-table"></div>
                    <div id="complications-table"></div>
                    <div id="antibiotics-table"></div>
                </div>
            `;

            chatArea.appendChild(messageContainer);

            // Create each table with enhanced borders
            setTimeout(() => {
                createMedicalReferenceTable(diagnosticCriteria, "Diagnostic Criteria for PPROM", "diagnostic-table");
                createMedicalReferenceTable(managementByAge, "Management Based on Gestational Age", "management-table");
                createMedicalReferenceTable(complications, "Common Complications", "complications-table");
                createMedicalReferenceTable(antibioticRegimens, "Recommended Antibiotic Regimens", "antibiotics-table");
            }, 500);

            // Scroll to show tables
            setTimeout(() => {
                messageContainer.scrollIntoView({ behavior: 'smooth' });
            }, 1000);
        }

        // Show visualization menu function
        function showVisualizationMenu(btn) {
            const messageContainer = btn.closest('.message');
            const messageDiv = messageContainer.querySelector('.message-content');
            const text = messageDiv.textContent || messageDiv.innerText || '';

            if (!text.trim()) {
                addMessageToChat('assistant', 'No content found to create visualizations from.');
                return;
            }

            // Store text globally for use in visualization functions
            window.currentVisualizationText = text.trim();

            // Close the main popup first
            btn.closest('.message-actions-popup').classList.remove('show');

            // Create visualization options modal
            const visualModal = document.createElement('div');
            visualModal.className = 'modal-overlay show';
            visualModal.id = 'visualizationModal';
            visualModal.innerHTML = `
                <div class="modal-content" style="min-width: 500px; max-width: 600px;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #1a73e8, #1557b0); color: white; padding: 20px; margin: -24px -24px 24px -24px; border-radius: 12px 12px 0 0;">
                        <h2 style="margin: 0; font-size: 18px; font-weight: 600;">ðŸ“Š Create Visual Content</h2>
                        <p style="margin: 8px 0 0 0; opacity: 0.9; font-size: 14px;">Choose the type of visualization to create from your content</p>
                    </div>

                    <div class="visualization-options" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
                        <button onclick="createDataTable()" class="visual-option-btn">
                            <span class="visual-icon">ðŸ“‹</span>
                            <div class="visual-text">
                                <strong>Data Table</strong>
                                <small>Interactive sortable table</small>
                            </div>
                        </button>

                        <button onclick="createMermaidDiagram()" class="visual-option-btn">
                            <span class="visual-icon">ðŸ”—</span>
                            <div class="visual-text">
                                <strong>Flowchart</strong>
                                <small>Process flow diagram</small>
                            </div>
                        </button>

                        <button onclick="createMindMap()" class="visual-option-btn">
                            <span class="visual-icon">ðŸ§ </span>
                            <div class="visual-text">
                                <strong>Mind Map</strong>
                                <small>Concept visualization</small>
                            </div>
                        </button>

                        <button onclick="createChartVisualization()" class="visual-option-btn">
                            <span class="visual-icon">ðŸ“Š</span>
                            <div class="visual-text">
                                <strong>Chart</strong>
                                <small>Statistical visualization</small>
                            </div>
                        </button>

                        <button onclick="createTimeline()" class="visual-option-btn">
                            <span class="visual-icon">â°</span>
                            <div class="visual-text">
                                <strong>Timeline</strong>
                                <small>Chronological sequence</small>
                            </div>
                        </button>

                        <button onclick="createInfographic()" class="visual-option-btn">
                            <span class="visual-icon">ðŸŽ¨</span>
                            <div class="visual-text">
                                <strong>Infographic</strong>
                                <small>Visual summary</small>
                            </div>
                        </button>
                    </div>

                    <div class="modal-buttons">
                        <button class="modal-button secondary" onclick="closeVisualizationModal()">Cancel</button>
                    </div>
                </div>
            `;

            document.body.appendChild(visualModal);
        }

        function closeVisualizationModal() {
            const modal = document.getElementById('visualizationModal');
            if (modal) {
                modal.remove();
            }
            window.currentVisualizationText = '';
        }

        // Visualization creation functions
        function createDataTable() {
            const prompt = `Create an interactive data table from this content. Format as a JSON datatable block with proper headers and rows:\n\n${window.currentVisualizationText}`;
            closeVisualizationModal();
            document.getElementById('messageInput').value = prompt;
            setTimeout(() => sendMessage(), 100);
        }

        function createMermaidDiagram() {
            const prompt = `Create a Mermaid.js flowchart diagram from this content. Use proper mermaid syntax in a code block:\n\n${window.currentVisualizationText}`;
            closeVisualizationModal();
            document.getElementById('messageInput').value = prompt;
            setTimeout(() => sendMessage(), 100);
        }

        function createMindMap() {
            const prompt = `Create a Mermaid.js mindmap diagram to visualize the key concepts and relationships from this content:\n\n${window.currentVisualizationText}`;
            closeVisualizationModal();
            document.getElementById('messageInput').value = prompt;
            setTimeout(() => sendMessage(), 100);
        }

        function createChartVisualization() {
            const prompt = `Create a Chart.js visualization (bar, line, or pie chart) from any numerical data or categories in this content:\n\n${window.currentVisualizationText}`;
            closeVisualizationModal();
            document.getElementById('messageInput').value = prompt;
            setTimeout(() => sendMessage(), 100);
        }

        function createTimeline() {
            const prompt = `Create a timeline visualization using Mermaid.js to show chronological events or processes from this content:\n\n${window.currentVisualizationText}`;
            closeVisualizationModal();
            document.getElementById('messageInput').value = prompt;
            setTimeout(() => sendMessage(), 100);
        }

        function createInfographic() {
            const prompt = `Create a visual infographic summary with key points, statistics, and visual elements from this content. Use HTML/CSS styling:\n\n${window.currentVisualizationText}`;
            closeVisualizationModal();
            document.getElementById('messageInput').value = prompt;
            setTimeout(() => sendMessage(), 100);
        }
    </script>
    <script>
    // AI message creation with toolbar
    function createAiMessage(content) {
        const messageId = `ai-message-${Date.now()}`;
        const sanitizedContent = DOMPurify.sanitize(content);
        const htmlContent = marked.parse(sanitizedContent);

        const messageElement = $(`
            <div class="message-bubble assistant" id="${messageId}" style="position:relative;">
                <button class="message-toggle" title="Edit Message"><i class="fas fa-edit"></i><span class="toggle-label">Edit</span></button>
                <div class="message-avatar">
                    <img src="https://youai.imgix.net/images/9e64b054-94aa-4364-8c4f-5675b73b6834_1700243233524.png" alt="MavericPro Avatar">
                </div>
                <div class="message-content-wrapper">
                    <div class="message-content" data-original="${encodeURIComponent(sanitizedContent)}">${htmlContent}</div>
                    <div class="message-toolbar">
                        <button class="toolbar-btn copy-btn" title="Copy"><i class="fas fa-copy"></i></button>
                        <button class="toolbar-btn toggle-btn" title="Toggle Raw"><i class="fas fa-code"></i></button>
                        <button class="toolbar-btn collapse-btn" title="Collapse"><i class="fas fa-chevron-up"></i></button>
                        <button class="toolbar-btn edit-btn" title="Edit"><i class="fas fa-edit"></i></button>
                    </div>
                </div>
            </div>
        `);

        // Event listener for copy button
        messageElement.find('.copy-btn').on('click', function() {
            const contentToCopy = messageElement.find('.message-content').text();
            navigator.clipboard.writeText(contentToCopy).then(() => {
                $(this).html('<i class="fas fa-check"></i>');
                setTimeout(() => $(this).html('<i class="fas fa-copy"></i>'), 2000);
            });
        });

        // Event listener for toggle button
        messageElement.find('.toggle-btn').on('click', function() {
            const messageContent = messageElement.find('.message-content');
            const isRaw = messageContent.data('is-raw');

            if (isRaw) {
                messageContent.html(marked.parse(sanitizedContent));
                messageContent.data('is-raw', false);
            } else {
                const rawContent = $('<pre></pre>').text(sanitizedContent);
                messageContent.html(rawContent);
                messageContent.data('is-raw', true);
            }
        });

        // Event listener for collapse button
        messageElement.find('.collapse-btn').on('click', function() {
            const messageContent = messageElement.find('.message-content');
            messageContent.slideToggle();
            $(this).find('i').toggleClass('fa-chevron-up fa-chevron-down');
        });

        // Edit button (toolbar)
        messageElement.find('.edit-btn').on('click', function() {
            const messageContent = messageElement.find('.message-content');
            if (messageContent.hasClass('editing')) return;

            // Store current HTML for cancel
            const originalHtml = messageContent.html();
            const originalText = decodeURIComponent(messageContent.data('original'));

            // Replace with textarea
            const textarea = $('<textarea class="message-edit-area"></textarea>').val(originalText);
            messageContent.html(textarea).addClass('editing');

            // Add Save and Cancel buttons
            const btnGroup = $('<div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end;"></div>');
            const saveBtn = $('<button style="padding:4px 12px;background:var(--accent-color);color:white;border:none;border-radius:4px;cursor:pointer;font-size:12px;">Save</button>');
            const cancelBtn = $('<button style="padding:4px 12px;background:var(--hover-bg);color:var(--text-primary);border:1px solid var(--border-color);border-radius:4px;cursor:pointer;font-size:12px;">Cancel</button>');
            btnGroup.append(saveBtn, cancelBtn);
            messageContent.append(btnGroup);

            textarea.focus().select();

            saveBtn.on('click', function() {
                const edited = textarea.val();
                const sanitized = DOMPurify.sanitize(edited);
                messageContent.html(marked.parse(sanitized));
                messageContent.data('original', encodeURIComponent(sanitized));
                messageContent.removeClass('editing');
            });

            cancelBtn.on('click', function() {
                messageContent.html(originalHtml);
                messageContent.removeClass('editing');
            });
        });

        // Event listener for message toggle button (Edit)
        messageElement.find('.message-toggle').on('click', function() {
            const messageContent = messageElement.find('.message-content');
            const isEditing = messageContent.hasClass('editing');

            if (!isEditing) {
                // Enter edit mode
                const originalContent = decodeURIComponent(messageContent.data('original'));
                const textArea = $('<textarea class="message-edit-area"></textarea>').val(originalContent);

                // Store the current HTML content
                messageContent.data('html-content', messageContent.html());

                // Replace with textarea
                messageContent.html(textArea);
                messageContent.addClass('editing');

                // Focus the textarea
                textArea.focus();

                // Change button icon and title
                $(this).html('<i class="fas fa-save"></i><span class="toggle-label">Save</span>');
                $(this).attr('title', 'Save Edits');

                // Add cancel button if it doesn't exist
                if (messageElement.find('.message-edit-cancel').length === 0) {
                    const cancelButton = $('<button class="message-edit-cancel" title="Cancel Edit"><i class="fas fa-times"></i></button>');
                    cancelButton.insertAfter($(this));

                    // Event listener for cancel button
                    cancelButton.on('click', function() {
                        // Restore original content
                        messageContent.html(messageContent.data('html-content'));
                        messageContent.removeClass('editing');

                        // Restore edit button
                        const editButton = messageElement.find('.message-toggle');
                        editButton.html('<i class="fas fa-edit"></i><span class="toggle-label">Edit</span>');
                        editButton.attr('title', 'Edit Message');

                        // Remove cancel button
                        $(this).remove();
                    });
                }
            } else {
                // Save edited content
                const editedContent = messageContent.find('textarea').val();
                const sanitizedEditedContent = DOMPurify.sanitize(editedContent);

                // Update the stored original content
                messageContent.data('original', encodeURIComponent(sanitizedEditedContent));

                // Update the displayed content
                messageContent.html(marked.parse(sanitizedEditedContent));
                messageContent.removeClass('editing');

                // Restore edit button
                $(this).html('<i class="fas fa-edit"></i><span class="toggle-label">Edit</span>');
                $(this).attr('title', 'Edit Message');

                // Remove cancel button
                messageElement.find('.message-edit-cancel').remove();
            }
        });

        return messageElement;
    }
    </script>
</body>
</html>
